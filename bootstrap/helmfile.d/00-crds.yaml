---
# Phase 0: CRD Extraction Bootstrap
# This file extracts ONLY CustomResourceDefinitions from charts
# CRDs are filtered using yq after template rendering
#
# Usage (with yq filtering):
#   helmfile -f bootstrap/helmfile.d/00-crds.yaml -e infra template | \
#     yq ea 'select(.kind == "CustomResourceDefinition")' | \
#     kubectl apply -f -
#
#   helmfile -f bootstrap/helmfile.d/00-crds.yaml -e apps template | \
#     yq ea 'select(.kind == "CustomResourceDefinition")' | \
#     kubectl apply -f -
#
# Note: postRenderer doesn't work with 'helmfile template', so we pipe to yq externally
#
# ⚠️ CRITICAL VERSION ALIGNMENT REQUIREMENT ⚠️
# CRD versions in this file MUST match controller versions in 01-core.yaml.gotmpl
# Mismatched versions can cause:
# - API compatibility issues
# - Resource validation failures
# - Silent data loss or corruption
#
# Verified Alignments (as of 2025-10-21):
#   cert-manager:      v1.19.0  (CRD ✓ Controller ✓)
#   external-secrets:  0.20.3   (CRD ✓ Controller ✓)
#
# Future Flux Deployments (CRDs pre-installed, controllers deployed via Flux):
#   victoria-metrics-operator: 0.5.1   (CRD only)
#   prometheus-operator:       24.0.1  (CRD only)
#   cloudnative-pg:            0.26.1  (CRD only)
#
# When updating versions:
# 1. Update CRD version in this file
# 2. Update controller version in 01-core.yaml.gotmpl or Flux HelmRelease
# 3. Test in staging cluster first
# 4. Document alignment in this comment block

helmDefaults:
  # Critical: Include CRDs and disable hooks for extraction
  args: ['--include-crds', '--no-hooks']
  cleanupOnFail: false
  wait: false
  timeout: 300

---
# Cluster-specific environments
environments:
  infra:
    values:
      - ../clusters/infra/values.yaml
  apps:
    values:
      - ../clusters/apps/values.yaml

---
releases:
  # cert-manager CRDs
  # Provides: Certificate, CertificateRequest, Issuer, ClusterIssuer, etc.
  - name: cert-manager-crds
    namespace: cert-manager
    chart: oci://quay.io/jetstack/charts/cert-manager
    version: v1.19.0
    set:
      - name: crds.enabled
        value: true

  # external-secrets CRDs
  # Provides: ExternalSecret, SecretStore, ClusterSecretStore, etc.
  - name: external-secrets-crds
    namespace: external-secrets
    chart: oci://ghcr.io/external-secrets/charts/external-secrets
    version: 0.20.3
    set:
      - name: installCRDs
        value: true

  # victoria-metrics-operator CRDs
  # Provides: VMAgent, VMAlert, VMAlertmanager, VMSingle, VMCluster, VMRule, VMServiceScrape, VMPodScrape, VMProbe, VMNodeScrape, VMStaticScrape, VMAuth, VMUser, VMAlertmanagerConfig, VLAgent, VLSingle, VLCluster, VMAnomaly, VMAuth, VMScrapeConfig, VMUser, VTCluster, VTSingle
  - name: victoria-metrics-operator-crds
    namespace: victoria-metrics
    chart: oci://ghcr.io/victoriametrics/helm-charts/victoria-metrics-operator-crds
    version: 0.5.1

  # prometheus-operator CRDs (for Prometheus-compatible resources)
  # Provides: PrometheusRule, ServiceMonitor, PodMonitor, Probe
  # Victoria Metrics operator can convert these to VMRule, VMServiceScrape, VMPodScrape, VMProbe
  - name: prometheus-operator-crds
    namespace: observability
    chart: oci://ghcr.io/prometheus-community/charts/prometheus-operator-crds
    version: 24.0.1

  # cloudnative-pg CRDs
  # Provides: Cluster, Pooler, Backup, ScheduledBackup, ImageCatalog, ClusterImageCatalog
  - name: cloudnative-pg-crds
    namespace: cnpg-system
    chart: oci://ghcr.io/cloudnative-pg/charts/cloudnative-pg
    version: 0.26.1
    set:
      - name: crds.create
        value: true

  # Note: Gateway API CRDs are automatically installed by bootstrap task (Phase 1)
  # Source: https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/standard-install.yaml
  # Version: v1.4.0 (released October 2025)
  # Provides: GatewayClass, Gateway, HTTPRoute, GRPCRoute, ReferenceGrant
