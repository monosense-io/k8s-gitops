<!-- Powered by BMAD™ Core → PO Validation Report -->

# PO Validation — STORY-NET-CILIUM-CORE-GITOPS (2025-10-27)

- Story file: `docs/stories/STORY-NET-CILIUM-CORE-GITOPS.md`
- Architecture refs: `docs/architecture.md` (Networking/Cilium section); repo layout under `kubernetes/infrastructure/networking/cilium/*`
- Context: v3.0 manifests‑first refactor; draft status. This validation checks template completeness, AC coverage, task sequencing, testing clarity, security, anti‑hallucination, and implementation readiness.

---

## Template Compliance Issues

- Sections present: Status, Story, Acceptance Criteria, Tasks / Subtasks, Dev Notes (with Testing), Dev Agent Record, Change Log, QA Results — all found and correctly ordered.
- Placeholders: None detected (no `{{...}}`, `TBD`, or `${VAR}` left in narrative text).
- Minor label mismatch: Heading says “Tasks / Subtasks — Implementation Plan (8 Phases)” but content uses 4 phases (0–3). Update heading to “(4 Phases)”.
- Stale phase references: “Risks & Mitigations” mentions Phase 4.3/4.4/5.1 — update to Phase 3.x equivalents based on the v3.0 refactor.
- Header link: “Links: docs/architecture.md §9” points to Secrets; for Cilium core, link should reference the Networking (Cilium) section in architecture instead of §9.

## Critical Issues (Must Fix — Blockers)

- AC-2 scope drift vs change log: AC-2 says HelmRelease includes “Gateway API and BGP” features. Change Log 3.0 states these moved to dedicated stories and this story is manifests‑first for cilium/core only. Fix AC-2 bullet to remove Gateway API and BGP from core.
- Substitution ownership wording: Several bullets say the HelmRelease “uses postBuild.substitute[…]”. `postBuild.substitute*` belongs to the Flux `Kustomization`, not to `HelmRelease`. Keep HelmRelease values using `${VAR}` and define substitution exclusively in the cluster `Kustomization` (`kubernetes/clusters/{infra,apps}/infrastructure.yaml`).
- KubePrism override inconsistency: AC-1 and Success Metrics require `k8sServiceHost: 127.0.0.1` and `k8sServicePort: 7445` in Flux build outputs, implying a Talos KubePrism setup. Current cluster settings specify `K8S_SERVICE_HOST` as `infra-k8s.monosense.io` and `apps-k8s.monosense.io` (see `kubernetes/clusters/*/cluster-settings.yaml`). Either:
  - Provide source and rationale for the KubePrism override and update cluster settings + architecture accordingly; or
  - Remove the KubePrism requirement and align AC-1/Success Metrics with the domain host values in architecture. Until clarified, AC‑3/AC‑4 verification steps will be ambiguous.

## Should‑Fix Issues (Quality / Clarity)

- AC mapping clarity: You already tag phases with ACs — add a compact map table (Phase → ACs) for quick scanning.
- Flux build vs kustomize build: Clarify that `flux build kustomization …` performs substitution (no `${VAR}`), whereas plain `kustomize build` will not. The Troubleshooting note currently suggests unsubstituted vars are “expected”; qualify that it applies to `kustomize` output, not `flux build`.
- Schema validation scope: `kubeconform` run over `kubernetes/infrastructure/networking/cilium/core` validates the HelmRelease CR (skipping unknown schemas if `-ignore-missing-schemas`), not the rendered Cilium resources. Mention this explicitly, and optionally add a CI‑only check to render the chart (`helm template` or Flux controller rendering in a sandbox) for deeper validation.
- Architecture link precision: Replace “§9” with “Networking (Cilium)” anchor and optionally “Repository Layout §5” for the file tree alignment.
- Dev Agent Record in a draft: Consider moving Phase 0 “Complete” notes to Change Log or leave Dev Agent Record empty until the story is Approved/InProgress.

## Nice‑to‑Have Improvements

- Add a tiny AC‑to‑file checklist (e.g., a table that lists each required file/path per AC) to speed dev verification.
- Provide a one‑shot `make validate-cilium-core` taskfile entry that runs the local validation commands (flux build + kubeconform + yq) for both clusters.
- Link to an internal “OCI mirror policy” note or mention the official Cilium OCI URL as a fallback right where the OCIRepository is defined.

## Anti‑Hallucination Findings

- Version pinning (Cilium 1.18.3) and features are supported by `docs/architecture.md` (Networking/Cilium). OK.
- KubePrism host/port override is not present in architecture; requires citation or removal.
- “Charts mirror at ghcr.io/home-operations” is not referenced in architecture; acceptable as an implementation choice if documented with a fallback policy.
- File paths and source tree match the Architecture “Repository Layout”. OK.

## Acceptance Criteria Coverage (Assessment)

- AC‑1: Directory structure + cluster settings — Covered; cluster settings already exist. Note the KubePrism host/port inconsistency above.
- AC‑2: GitOps resources — Covered by Phase 2 tasks; remove Gateway/BGP from “core” scope.
- AC‑3: Substitution — Covered via `${…}` in HelmRelease and `postBuild.substituteFrom` in cluster Kustomizations; fix wording to place substitution in Kustomization, not HelmRelease.
- AC‑4: Local validation — Commands provided; clarify `flux build` vs `kustomize` expectations.
- AC‑5: Cilium feature flags — Keep to core (kubeProxyReplacement, encryption, Hubble) and defer Gateway/BGP to their stories.
- AC‑6: Cross‑cluster consistency — Covered via diff checks.
- AC‑7: OCI availability — Covered as CI preflight; good.

## Final Assessment

- Decision: NO‑GO (requires edits before approval)
- Implementation Readiness Score: 7/10
- Confidence: Medium‑High once the blockers are resolved

### Required edits to flip to GO
1) Fix AC‑2 to remove Gateway API and BGP from the core scope; update any tasks implying those features.
2) Correct substitution ownership wording (Kustomization `postBuild.substitute*`, not HelmRelease).
3) Resolve the KubePrism host/port inconsistency: either document and adopt it across architecture + cluster settings, or align ACs to the domain host values already in cluster settings.
4) Update headings and stale phase references (8→4 phases; Phase 4.x/5.x → Phase 3.x).

Once these are addressed, this story can be marked Approved for implementation.

