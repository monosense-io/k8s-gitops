<!-- Powered by BMAD™ Core → PO Validation Report -->

# PO Validation — STORY-NET-CILIUM-IPAM (2025-10-27)

- Story file: `docs/stories/STORY-NET-CILIUM-IPAM.md`
- Architecture refs: `docs/architecture.md` (Networking/Cilium, repo layout) and `docs/IP-ALLOCATION-SUMMARY.md` (pool plan)
- Context: v3.0 manifests‑first split; this story creates IPAM pool manifests only. Deployment + runtime checks move to Story 45.

---

## Template Compliance Issues

- Missing sections relative to `.bmad-core/templates/story-tmpl.yaml`:
  - `## Status` (present only as inline header text; should be a section)
  - `## Dev Notes` and nested `### Testing`
  - `## Dev Agent Record` (Agent Model, Debug Log References, Completion Notes, File List)
  - `## QA Results`
- Placeholders: None detected (no `{{...}}`, `TBD`, or `_TBD_`). `${VAR}` usages are intentional for Flux substitution and acceptable in manifests.
- Structure: Headings are consistent; consider adding a brief “Executive Summary” like Story 01 for quick scanability.
- Link precision: Header says `docs/architecture.md §9`; Networking (Cilium/IPAM) material lives under Networking and Repository Layout sections. Update link text to those anchors.

## Critical Issues (Must Fix — Story Blocked)

- Missing required sections (above) per template — add `Status`, `Dev Notes` (+ `Testing`), `Dev Agent Record`, and `QA Results` sections. Until present, story stays NO‑GO.
- CRD field verification for `CiliumLoadBalancerIPPool`:
  - The story relies on `spec.disabled` for per‑cluster isolation. Confirm this field exists in the `cilium.io/v2alpha1` IPAM Pool CRD for the target Cilium version (1.18.3). If not supported, replace with one of:
    - Use `serviceSelector` with labels + per‑cluster label policy; or
    - Maintain per‑cluster pool manifests with inclusion gated by cluster Kustomizations.
  - Also verify whether `CiliumLoadBalancerIPPool` is cluster‑scoped. If cluster‑scoped, drop `metadata.namespace: kube-system` from examples/AC to avoid schema errors.
- Flux build command accuracy in AC/T5:
  - Replace `flux build kustomization cluster-infra-infrastructure --path ./kubernetes/infrastructure` with the pattern used in Story 01/Core and our scripts, for example:
    - `flux build kustomization -f kubernetes/clusters/infra/infrastructure.yaml --path .`
    - `flux build kustomization -f kubernetes/clusters/apps/infrastructure.yaml --path .`
  - This ensures correct substitution and mirrors existing repo usage.

## Should‑Fix Issues (Quality / Clarity)

- Kustomization placement/pattern:
  - T4 proposes `kubernetes/infrastructure/networking/cilium/ipam/ks.yaml` plus a local `kustomization.yaml`. The repo pattern uses cluster‑level Flux `Kustomization` resources under `kubernetes/clusters/{infra,apps}/`. Prefer adding a new cluster Kustomization (e.g., `cilium-ipam`) there with `spec.path: ./kubernetes/infrastructure/networking/cilium/ipam` and `dependsOn: [cilium-core]`, instead of committing a `Kustomization` CR inside the component folder.
- Local validation tooling:
  - `kubectl --dry-run=client -f kubernetes/infrastructure/networking/cilium/ipam/` may fail type validation unless CRDs are installed. Prefer `kustomize build ... | kubeconform --strict -ignore-missing-schemas` (as done for core) for schema checks without clusters.
- AC wording for bootstrap references:
  - Infra/apps `cilium-values.yaml` currently only annotate ClusterMesh Service IPs; gateway Envoy IP is intentionally deferred to GitOps manifests. Align AC to “documented in bootstrap OR in Flux Gateway manifests” to avoid contradictions, or add the Envoy annotation blocks in bootstrap if you want them at bootstrap time.
- Provide minimal example snippets:
  - Add explicit example `kubernetes/infrastructure/networking/cilium/ipam/kustomization.yaml` with the two pool files, and illustrate the cluster‑level Flux `Kustomization` for `cilium-ipam` with `dependsOn` on `cilium-core`.

## Nice‑to‑Have Improvements

- Add a `scripts/validate-cilium-ipam.sh` modeled after `scripts/validate-cilium-core.sh` to run: YAML syntax checks, `kustomize build` + `kubeconform`, and `flux build` for each cluster to confirm `${INFRA|APPS}_POOL_DISABLED` substitutions and no `${...}` remain.
- Include a compact AC↔File checklist table (paths required for each AC) to speed dev verification.
- Cross‑reference `docs/IP-ALLOCATION-SUMMARY.md` in the Acceptance Criteria “Pool Segmentation” for clear source traceability.

## Anti‑Hallucination Findings

- Pool ranges and reserved IPs (100/110 infra, 120/121 apps) are documented in `docs/IP-ALLOCATION-SUMMARY.md` and reflected in `kubernetes/clusters/*/cluster-settings.yaml`. OK.
- File paths and repo layout match `docs/architecture.md` Repository Layout, which includes an `ipam/` component. OK.
- The `spec.disabled` IPAM field needs a CRD reference (add a short citation in Dev Notes or Architecture; otherwise switch to `serviceSelector`/per‑cluster manifests as noted above).

## Acceptance Criteria Coverage (Assessment)

- AC‑1 (Manifests Created): Covered by tasks; ensure pool names, ranges, and isolation pattern match cluster‑settings variables. Verify resource scope/namespace.
- AC‑2 (Kustomization Created): Covered; recommend defining cluster‑level Kustomizations (`cilium-ipam`) with `dependsOn: cilium-core` rather than committing a `ks.yaml` inside the component.
- AC‑3 (Cluster Settings Alignment): Values already present in `kubernetes/clusters/{infra,apps}/cluster-settings.yaml`. Gateway IP bootstrap annotation is optional vs Flux gateway manifests — clarify in AC.
- AC‑4 (Local Validation): Commands present; fix `flux build` flags and prefer `kubeconform` over `kubectl --dry-run=client` for CRDs.
- AC‑5 (Pool Segmentation): Clearly specified and documented; add explicit yq assertion examples for non‑overlap.

## Final Assessment

- Decision: NO‑GO (needs template compliance + CRD field/scope verification and command fixes)
- Implementation Readiness Score: 7/10
- Confidence: Medium (High once `spec.disabled` and scope verified or replaced with `serviceSelector`/per‑cluster manifests)

### Required edits to flip to GO
1) Add missing template sections: `## Status`, `## Dev Notes` (+ `### Testing`), `## Dev Agent Record`, `## QA Results`.
2) Verify `CiliumLoadBalancerIPPool` supports `spec.disabled` and resource scope; alternatively switch to `serviceSelector` or per‑cluster gated manifests. Update examples/AC accordingly.
3) Fix `flux build` commands in AC/T5 to use the `-f` style with `--path .` consistent with Story 01 and scripts.
4) Choose a single Kustomization pattern: cluster‑level Flux `Kustomization` named `cilium-ipam` with `dependsOn: [cilium-core]` (recommended), and include a minimal `kustomization.yaml` under `ipam/` listing the two pool files.
5) Clarify bootstrap vs GitOps ownership for Gateway IPs; either add annotations in bootstrap values files or state that Gateway IPs are set in Flux Gateway manifests.

