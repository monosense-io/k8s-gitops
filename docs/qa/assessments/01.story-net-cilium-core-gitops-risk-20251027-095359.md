<!-- Powered by BMAD™ Core -->

# Risk Profile: Story 01 — STORY-NET-CILIUM-CORE-GITOPS

Date: 2025-10-27
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 10
- Critical: 0 | High: 3 | Medium: 4 | Low: 3
- Highest: TECH-002 (Score 6) — Flux postBuild substitution misconfigured or not applied

The story was just course‑corrected to a manifests‑first, core‑only scope. Major blockers from prior drafts (Gateway/BGP in core, KubePrism hard requirement) are removed. Remaining high risks center on Flux substitution, OCI mirror availability, and cluster wiring.

## Risk Matrix

| Risk ID   | Description                                                   | Prob. | Impact | Score | Priority |
|-----------|---------------------------------------------------------------|-------|--------|-------|----------|
| TECH-002  | Flux postBuild substitution misconfigured/not applied         | 2     | 3      | 6     | High     |
| OPS-003   | Cluster `infrastructure.yaml` missing/incorrect wiring        | 2     | 3      | 6     | High     |
| TECH-004  | OCI mirror lacks cilium 1.18.3 (or network unreachable in CI) | 2     | 3      | 6     | High     |
| TECH-005  | HelmRelease schema/API drift vs kubeconform coverage          | 2     | 2      | 4     | Medium   |
| TECH-006  | Values mismatch vs bootstrap (drift over time)                | 2     | 2      | 4     | Medium   |
| TECH-007  | HealthChecks misconfigured (names/namespaces)                 | 2     | 2      | 4     | Medium   |
| OPS-008   | Tooling versions differ (flux/kustomize/kubeconform/yq)       | 2     | 2      | 4     | Medium   |
| TECH-009  | Unrendered variables in HelmRelease values                    | 1     | 2      | 2     | Low      |
| OPS-010   | Paths in kustomization.yaml incorrect                         | 1     | 2      | 2     | Low      |
| BUS-011   | Scope creep back into core (Gateway/BGP)                      | 1     | 2      | 2     | Low      |

Notes:
- Scores use Probability (1–3) × Impact (1–3). Priority tiers: 9 Critical, 6 High, 4 Medium, 2–3 Low.

## Mitigations and Testing Focus

### TECH-002 — Flux substitution not applied (Score 6)
- Strategy: Preventive
- Actions:
  - Ensure cluster Kustomizations set `postBuild.substituteFrom: ConfigMap/cluster-settings` and include required keys.
  - Validate with `flux build` for both clusters; grep for `${` to assert zero placeholders.
- Testing Requirements:
  - Add CI step: `flux build` per cluster; fail on `${`.
  - Scenario IDs: P0-SUB-001/002 (see test-design doc).

### OPS-003 — Cluster wiring missing/incorrect (Score 6)
- Strategy: Preventive/Detective
- Actions:
  - Add `Kustomization` for `cilium-core` in both `kubernetes/clusters/{infra,apps}/infrastructure.yaml` with `healthChecks`.
  - Verify path and ordering before BGP/Gateway/IPAM.
- Testing Requirements:
  - `flux build -f ...infra...` and `...apps...`; confirm `cilium-core` appears with healthChecks.

### TECH-004 — OCI mirror availability (Score 6)
- Strategy: Preventive
- Actions:
  - Keep mirror URL; document official Cilium OCI fallback next to OCIRepository.
  - Add CI-only reachability check for `1.18.3`.
- Testing Requirements:
  - CI curl/helm registry login listing; fall back on failure and log.

### TECH-005 — Schema/API drift (Score 4)
- Strategy: Detective
- Actions:
  - Run kubeconform on the HelmRelease CR; acknowledge it won’t render the chart.
  - Optional CI: `helm template` with pinned chart to catch value key drift.

### TECH-006 — Bootstrap vs HelmRelease drift (Score 4)
- Strategy: Preventive
- Actions:
  - Maintain `values.yaml.gotmpl` pattern; add periodic diff check in CI.

### TECH-007 — HealthChecks misconfigured (Score 4)
- Strategy: Preventive/Detective
- Actions:
  - Use exact resource names/namespaces for DaemonSet/Deployment.
  - Validate with `flux build` and unit grep.

### OPS-008 — Tooling version drift (Score 4)
- Strategy: Preventive
- Actions:
  - Pin minimum versions in docs; add `make validate-cilium-core` target to run all checks consistently.

### TECH-009 — Unrendered variables (Score 2)
- Strategy: Detective
- Actions: Grep `${` in flux build outputs; fail fast.

### OPS-010 — Path typos (Score 2)
- Strategy: Preventive
- Actions: Keep short `tree`/`rg` checks in validation script.

### BUS-011 — Scope creep (Score 2)
- Strategy: Preventive
- Actions: Keep Gateway/BGP/IPAM strictly in their stories; enforce via AC language.

## Risk Summary (Gate YAML)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 3
    medium: 4
    low: 3
  highest:
    id: TECH-002
    score: 6
    title: "Flux postBuild substitution misconfigured or not applied"
  recommendations:
    must_fix:
      - "Add/verify postBuild.substituteFrom to reference ConfigMap/cluster-settings in both clusters"
      - "Wire cilium/core Kustomization in infra/apps with healthChecks"
      - "Add CI preflight: verify OCI mirror or use official Cilium OCI for 1.18.3"
    monitor:
      - "Optional CI: helm template chart render to detect value key drift"
      - "Periodic diff: bootstrap values vs HelmRelease"
```

## Risk-Based Testing Strategy

- P0: Flux substitution correctness (no `${VAR}`), cluster wiring presence, OCI availability.
- P1: HealthChecks correctness, schema validation clean, toolchain versions.
- P2: Optional deep chart render, bootstrap/HelmRelease drift checks.

