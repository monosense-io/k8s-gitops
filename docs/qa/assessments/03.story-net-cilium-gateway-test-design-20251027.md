# Test Design — STORY-NET-CILIUM-GATEWAY (2025-10-27)

Designer: Quinn (Test Architect & Quality Advisor)
Story: docs/stories/STORY-NET-CILIUM-GATEWAY.md
Scope: Manifests-first. No cluster access. Runtime checks deferred to Story 45.

## Test Strategy Overview
- Total scenarios: 15
- By level: Unit 5, Integration 10, E2E 0
- Priorities: P0: 5, P1: 8, P2: 2
- Focus: Schema/static validation, Flux build substitution per cluster, cluster wiring (dependsOn), cert issuer reference, listener config.

## Test Scenarios by Acceptance Criteria

### AC‑1: GatewayClass Manifest Created
| ID                  | Level | Pri | Test                                                                                  | Justification                                      | Mitigates |
|---------------------|-------|-----|---------------------------------------------------------------------------------------|----------------------------------------------------|-----------|
| 03.gateway-UNIT-001 | Unit  | P0  | Assert file `kubernetes/infrastructure/networking/cilium/gateway/gatewayclass.yaml` exists and `metadata.name: cilium` | Ensures presence of required CR                     | WIRE-001  |
| 03.gateway-UNIT-002 | Unit  | P0  | Assert `.spec.controllerName == "io.cilium/gateway-controller"`                      | Controller binding correctness                      | API-001   |

### AC‑2: Gateway Manifest Created
| ID                  | Level       | Pri | Test                                                                                                           | Justification                         | Mitigates |
|---------------------|-------------|-----|----------------------------------------------------------------------------------------------------------------|---------------------------------------|-----------|
| 03.gateway-UNIT-003 | Unit        | P0  | Assert file `gateway.yaml` exists; `.metadata.name: cluster-gateway`, `.metadata.namespace: kube-system`       | Core identity fields                   | WIRE-001  |
| 03.gateway-UNIT-004 | Unit        | P0  | Assert `.spec.gatewayClassName: cilium` and `.spec.addresses[0].type: IPAddress` is set                       | API-compliant address configuration    | API-001   |
| 03.gateway-UNIT-005 | Unit        | P1  | Assert listeners: HTTP:80 and HTTPS:443 exist with `allowedRoutes.namespaces.from: All`                       | Listener readiness and policy default  | NET-001   |
| 03.gateway-INT-001  | Integration | P0  | Assert `.spec.tls.certificateRefs[0].name == "wildcard-tls"` and `namespace: kube-system` via kustomize build | Cert reference wiring                  | DEP-001   |

### AC‑3: Certificate Manifest Created
| ID                  | Level       | Pri | Test                                                                                                         | Justification                        | Mitigates |
|---------------------|-------------|-----|--------------------------------------------------------------------------------------------------------------|--------------------------------------|-----------|
| 03.gateway-UNIT-006 | Unit        | P0  | Assert `certificate.yaml` exists, `metadata.namespace: kube-system`, `spec.secretName: wildcard-tls`         | Secret location and naming            | SEC-001   |
| 03.gateway-UNIT-007 | Unit        | P1  | Assert `issuerRef.kind: ClusterIssuer` and `issuerRef.name: letsencrypt-production`                          | Depends on Story 06                   | DEP-001   |
| 03.gateway-INT-002  | Integration | P1  | Flux build renders `spec.dnsNames == ["*.${SECRET_DOMAIN}", "${SECRET_DOMAIN}"]` (placeholders present pre-subst) | Verifies substitution plumbing        | SUB-001   |

### AC‑4: Cluster-Specific Configuration (Substitution)
| ID                  | Level       | Pri | Test                                                                                                                        | Justification                             | Mitigates |
|---------------------|-------------|-----|-----------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|-----------|
| 03.gateway-INT-003  | Integration | P0  | `flux build -f kubernetes/clusters/infra/infrastructure.yaml --path .` yields Gateway `.spec.addresses[0].value == 10.25.11.110` | Ensures correct IP per cluster (infra)     | SUB-001   |
| 03.gateway-INT-004  | Integration | P0  | `flux build -f kubernetes/clusters/apps/infrastructure.yaml --path .` yields Gateway `.spec.addresses[0].value == 10.25.11.121`  | Ensures correct IP per cluster (apps)      | SUB-001   |
| 03.gateway-INT-005  | Integration | P1  | Flux build for infra/apps renders Certificate dnsNames with actual domain (no `${SECRET_DOMAIN}` left)                        | Confirms substitution resolution           | SUB-001   |

### AC‑5: Kustomization Created (Cluster‑Level)
| ID                  | Level       | Pri | Test                                                                                                                             | Justification                         | Mitigates |
|---------------------|-------------|-----|----------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|-----------|
| 03.gateway-INT-006  | Integration | P0  | Append `cilium-gateway` Kustomization to both cluster files with correct `spec.path` and `dependsOn: [cilium-core, cilium-ipam]` | Guarantees reconciliation order        | WIRE-001  |
| 03.gateway-INT-007  | Integration | P1  | Health checks configured for `GatewayClass/cilium` and `Gateway/cluster-gateway` (optional but recommended)                    | Detects early reconciliation issues    | WIRE-001  |

### AC‑6: Local Validation Passes
| ID                  | Level       | Pri | Test                                                                                                              | Justification                          | Mitigates |
|---------------------|-------------|-----|-------------------------------------------------------------------------------------------------------------------|----------------------------------------|-----------|
| 03.gateway-INT-008  | Integration | P1  | `kustomize build kubernetes/infrastructure/networking/cilium/gateway | kubeconform --strict -ignore-missing-schemas` passes | Schema conformance without CRDs        | SCHEMA-001|
| 03.gateway-INT-009  | Integration | P0  | Flux builds (infra/apps) show no unresolved placeholders like `${CILIUM_GATEWAY_LB_IP}` or `${SECRET_DOMAIN}`    | Confirms substitution completeness     | SUB-001   |
| 03.gateway-INT-010  | Integration | P2  | Lint YAML structure (e.g., yq eval '.' on all gateway files)                                                     | Baseline structural sanity             | SCHEMA-001|

## Negative/Edge Cases (Design‑time)
- Address setting via legacy annotation ignored by tests; ensure only `spec.addresses` is used (would fail 03.gateway-UNIT-004).
- Gateway in wrong namespace or wrong name fails 03.gateway-UNIT-003.
- Missing cluster Kustomization or bad `spec.path` fails 03.gateway-INT-006.
- Missing issuer or wrong name flagged by 03.gateway-UNIT-007 (deployment deferred but wiring must exist).
- IP outside pool ranges to be caught during Story 45; optional CI check compares `.spec.addresses[0].value` against pool bounds.

## Risk Coverage Mapping
- DEP-001: 03.gateway-UNIT-007, 03.gateway-INT-002, 03.gateway-INT-008.
- WIRE-001: 03.gateway-UNIT-001/003, 03.gateway-INT-006/007.
- API-001: 03.gateway-UNIT-004.
- SUB-001: 03.gateway-INT-003/004/005/009.
- SCHEMA-001: 03.gateway-INT-008/010.
- SEC-001: 03.gateway-UNIT-006.
- NET-001: Covered in Story 45 E2E validations (documented but not executed here).

## Recommended Execution Order
1) P0 Integration + Unit: 03.gateway-UNIT-001/003/004; 03.gateway-INT-003/004/006/009
2) P1: 03.gateway-UNIT-002/005/007; 03.gateway-INT-001/002/005/007/008
3) P2: 03.gateway-INT-010

## Gate YAML Block (test_design)
```yaml
test_design:
  scenarios_total: 15
  by_level:
    unit: 5
    integration: 10
    e2e: 0
  by_priority:
    p0: 5
    p1: 8
    p2: 2
  coverage_gaps: []
```

## Notes
- Runtime validations (Gateway Programmed, BGP advertisement, TLS issuance) are explicitly deferred to Story 45 and will be covered by E2E tests there.
- Use `flux build -f ... --path .` consistently to mirror cluster Kustomization structure used in this repo.
- Keep kubeconform strict and tolerate missing CRDs locally with `-ignore-missing-schemas`.
