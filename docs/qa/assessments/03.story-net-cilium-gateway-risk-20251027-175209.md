# QA Risk Profile — STORY-NET-CILIUM-GATEWAY (2025-10-27 rev 2)

- Story file: `docs/stories/STORY-NET-CILIUM-GATEWAY.md`
- Reviewer: Quinn (Test Architect & Quality Advisor)
- Method: Probability × Impact (BMAD risk framework)

## Executive Summary
- Total risks: 10
- Critical: 1, High: 1, Medium: 3, Low: 5
- Highest risk: DEP-001 (Cert-Manager dependency ordering for Certificate manifests)
- Readiness impact: Medium — manifests-first approach is solid; ensure controller enablement and dependency ordering before deployment.

## Risk Matrix
| ID       | Category | Description | Prob. | Impact | Score | Priority |
|----------|----------|-------------|-------|--------|-------|----------|
| DEP-001  | OPS      | Certificate depends on ClusterIssuer `letsencrypt-production`; if cert-manager CRDs/issuers not applied before gateway manifests, Flux apply will fail | High (3) | High (3) | 9 | Critical |
| GAPI-001 | TECH     | Cilium Gateway API controller not enabled (`values.gatewayAPI.enabled: true` missing in HelmRelease); Gateway will not program | Medium (2) | High (3) | 6 | High |
| WIRE-001 | OPS      | Cluster-level Kustomization for `cilium-gateway` not added or lacks dependsOn; manifests won’t reconcile | Medium (2) | Medium (2) | 4 | Medium |
| SUB-001  | TECH     | Bad or missing `${CILIUM_GATEWAY_LB_IP}` substitution from cluster-settings | Medium (2) | Medium (2) | 4 | Medium |
| NET-001  | OPS      | Gateway reconciled before BGP reachability validated; external reachability fails | Medium (2) | Medium (2) | 4 | Medium |
| API-001  | TECH     | Gateway API `spec.addresses` compatibility; older Gateway API/Cilium may ignore addresses | Low (1) | Medium (2) | 2 | Low |
| IPAM-001 | TECH     | Gateway IP not inside IPAM pool range (pool conflict) | Low (1) | Medium (2) | 2 | Low |
| SCHEMA-001| OPS     | Local schema validation missing CRDs; false confidence without `-ignore-missing-schemas` | Medium (2) | Low (1) | 2 | Low |
| SEC-001  | SEC      | Wildcard TLS secret in `kube-system` increases blast radius if compromised | Low (1) | Medium (2) | 2 | Low |
| DOC-001  | OPS      | PRD sharding config mismatch (core-config says sharded but `docs/prd/` absent) can cause process confusion | Low (1) | Low (1) | 1 | Minimal |

Legend: Score = Probability × Impact; 9=Critical, 6=High, 4=Medium, 2–3=Low, 1=Minimal

## Detailed Risks and Mitigations

### DEP-001 — Cert-Manager dependency ordering (Score 9)
- Signals: No `kubernetes/infrastructure/security/cert-manager/` manifests in repo; Story 06 is prerequisite but cluster Kustomization in this story will reconcile Certificate.
- Mitigations:
  - Ensure cert-manager issuers Kustomization exists and set `dependsOn` from `cilium-gateway` to that Kustomization, or split `Certificate` into its own Kustomization that depends on cert-manager.
  - Keep local validation tolerant with `kubeconform --strict -ignore-missing-schemas`.
- Testing focus: Flux build renders Certificate dnsNames from `${SECRET_DOMAIN}`; issuer Ready=True before reconciling certificate.

### GAPI-001 — Gateway API controller disabled (Score 6)
- Signals: `kubernetes/infrastructure/networking/cilium/core/helmrelease.yaml` lacks `values.gatewayAPI.enabled: true`.
- Mitigations: Add the flag in HelmRelease values; verify Cilium version supports Gateway API controller (target 1.18.3).
- Testing focus: After deployment stories, `kubectl get gatewayclass cilium -o yaml` shows Accepted=True; Gateway becomes Programmed=True.

### WIRE-001 — Missing/wrong cluster wiring (Score 4)
- Signals: Cluster files include only `cilium-core` and `cilium-ipam`.
- Mitigations: Append `cilium-gateway` Kustomization with `dependsOn: [cilium-core, cilium-ipam]`; include healthChecks for GatewayClass/Gateway.
- Testing focus: `flux build` shows rendered Gateway and Certificate with correct substitutions.

### SUB-001 — Substitution for `${CILIUM_GATEWAY_LB_IP}` (Score 4)
- Signals: Relies on `postBuild.substituteFrom: cluster-settings`.
- Mitigations: CI check for presence/format of key; assert values differ by cluster.
- Testing focus: `flux build | yq` extracts IP per cluster and matches expected values.

### NET-001 — BGP readiness before exposure (Score 4)
- Mitigations: Deploy gateway only after BGP Control Plane validation story; sequence with dependsOn.
- Testing focus: Smoke test reachability and route advertisement post-deploy.

### API-001 — Gateway API field compatibility (Score 2)
- Mitigations: None for targeted versions; keep annotation fallback documented if downgrades occur.

### IPAM-001 — IP pool alignment (Score 2)
- Mitigations: Build-time assertion that IP lies within configured pool bounds per cluster.

### SCHEMA-001 — Local validation without CRDs (Score 2)
- Mitigations: Use `-ignore-missing-schemas`; pin schemas in CI where feasible.

### SEC-001 — TLS secret scope (Score 2)
- Mitigations: Limit RBAC; consider dedicated namespace later; accepted infra risk.

### DOC-001 — PRD sharding mismatch (Score 1)
- Mitigations: Reconcile `.bmad-core/core-config.yaml` with repo layout or add `docs/prd/` directory; documentation-only.

## Recommendations
- Must-fix before deployment:
  - Enable Cilium Gateway API controller (`values.gatewayAPI.enabled: true`).
  - Add cluster-level `cilium-gateway` Kustomizations with proper `dependsOn`.
  - Ensure cert-manager issuers are available before reconciling `Certificate` (dependsOn or separate Kustomization for certs).
- Monitor:
  - Validate IP substitution and IPAM pool alignment in CI.
  - Confirm Gateway API schema compatibility for target versions.

## Gate Snippet (for gate files)
```yaml
risk_summary:
  totals:
    critical: 1
    high: 1
    medium: 3
    low: 5
  highest:
    id: DEP-001
    score: 9
    title: Cert-Manager dependency ordering for Certificate manifests
  recommendations:
    must_fix:
      - Enable Cilium Gateway API controller (values.gatewayAPI.enabled: true)
      - Add cluster-level cilium-gateway Kustomizations with dependsOn
      - Ensure cert-manager issuers before reconciling Certificate
    monitor:
      - Validate IP substitution and IPAM pool alignment in CI
      - Verify Gateway API schema compatibility with Cilium
```

## References
- Story: `docs/stories/STORY-NET-CILIUM-GATEWAY.md`
- Architecture: `docs/architecture.md` §9 Networking (Cilium)
- Cluster settings: `kubernetes/clusters/{infra,apps}/cluster-settings.yaml`
- IP pools: `kubernetes/infrastructure/networking/cilium/ipam/{infra,apps}/lb-ippool-*.yaml`

