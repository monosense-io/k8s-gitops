# Risk Profile: Story 01.story-net-cilium-core-gitops

Date: 2025-10-27
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 10
- Critical Risks (score 9): 0
- High Risks (score 6): 3
- Medium Risks (score 4): 4
- Low Risks (score 2–3): 3
- Overall Posture: Moderate. Most risks stem from Flux wiring, variable substitution, and OCI source availability rather than runtime networking behavior (deferred to Story 45).

Highest risk:
- TECH-002 (Score 6): Flux postBuild substitution misconfigured or not applied → manifests render with `${VAR}` placeholders or wrong values.

## Risk Matrix

| Risk ID   | Description                                                      | Prob | Impact | Score | Priority |
|-----------|------------------------------------------------------------------|------|--------|-------|----------|
| TECH-002  | postBuild substitution misconfigured/not applied                 | 2    | 3      | 6     | High     |
| TECH-004  | HelmRelease OCI sourceRef/version wiring incorrect               | 2    | 3      | 6     | High     |
| OPS-003   | Cluster Kustomization ordering/healthChecks missing for Cilium   | 2    | 3      | 6     | High     |
| OPS-002   | OCI mirror unreachable; no documented fallback path used         | 2    | 2      | 4     | Medium   |
| TECH-001  | Bootstrap vs Flux HelmRelease value drift                        | 2    | 2      | 4     | Medium   |
| OPS-004   | K8S_SERVICE_HOST/PORT mismatch from cluster-settings             | 2    | 2      | 4     | Medium   |
| PERF-001  | kubeProxyReplacement strict mode causes node networking issues   | 2    | 2      | 4     | Medium   |
| SEC-001   | WireGuard encryption misconfig leads to unencrypted traffic      | 1    | 3      | 3     | Low      |
| TECH-005  | SERVICE_CIDR defined but unused in chart → confusion/drift       | 1    | 2      | 2     | Low      |
| OPS-005   | kubeconform schema gaps cause false confidence                   | 1    | 2      | 2     | Low      |

Scoring: Probability 1–3 × Impact 1–3. High: 6, Critical: 9.

## Critical Risks Requiring Immediate Attention

None (no score 9). Treat High risks as must‑fix before merge to main.

## High Risks (Score 6)

### TECH-002 — postBuild substitution misconfigured/not applied (Score 6)
- Probability: Medium — Miswiring is common in early cluster wiring.
- Impact: High — Broken values propagate; Cilium may render wrong host/ids.
- Mitigation:
  - Ensure each cluster `infrastructure.yaml` defines `postBuild.substituteFrom` referencing `ConfigMap/cluster-settings`.
  - Add automated check: `flux build` followed by grep to ensure no `${` tokens remain.
  - Block PR if variables remain unsubstituted.
  - Testing Focus: Compare infra vs apps builds; assert resolved `k8sServiceHost` and `cluster.id`.

### TECH-004 — HelmRelease OCI sourceRef/version wiring incorrect (Score 6)
- Probability: Medium — Common mistakes with `spec.chart.spec.sourceRef` and `version`.
- Impact: High — Chart won’t fetch or wrong version deployed.
- Mitigation:
  - Enforce apiVersion `helm.toolkit.fluxcd.io/v2`.
  - Use `sourceRef.kind: OCIRepository`, `name: cilium-charts` and `version: ${CILIUM_VERSION}`.
  - Add kubeconform + `flux build` CI to catch schema errors.
  - Testing Focus: Lint HelmRelease YAML; verify OCI ref presence during CI (if networked).

### OPS-003 — Cluster Kustomization ordering/healthChecks missing (Score 6)
- Probability: Medium — Ordering health checks often deferred.
- Impact: High — Flux may proceed without Cilium ready; hard-to-debug failures.
- Mitigation:
  - In each cluster `infrastructure.yaml`, set `dependsOn` as needed and `healthChecks` for `DaemonSet/cilium` and `Deployment/cilium-operator` in `kube-system`; `prune: true`, `wait: true`, `timeout: 10m`.
  - Testing Focus: `flux build` includes the cilium/core path; manual review of healthChecks in YAML.

## Medium Risks (Score 4)

- OPS-002 — OCI mirror unreachable; no fallback used
  - Mitigation: CI preflight that resolves `1.18.3`; fallback to official Cilium OCI if mirror unavailable; document policy.
- TECH-001 — Bootstrap vs Flux HelmRelease value drift
  - Mitigation: Keep bootstrap `values.yaml.gotmpl` reading Flux values; periodic diff job.
- OPS-004 — K8S_SERVICE_HOST/PORT mismatch
  - Mitigation: Add `K8S_SERVICE_PORT: "6443"` to both cluster-settings; validation greps for `k8sServicePort: 6443` in `flux build` outputs.
- PERF-001 — kubeProxyReplacement strict mode issues
  - Mitigation: Document kernel prerequisites; runtime tests live in Story 45; here limit to schema and value correctness.

## Low Risks (Score 2–3)

- SEC-001 — WireGuard encryption misconfig
  - Mitigation: Values validation; runtime validation in Story 45.
- TECH-005 — SERVICE_CIDR unused variable confusion
  - Mitigation: Clarify in AC that it is not consumed by this chart; keep for other components.
- OPS-005 — kubeconform schema gaps
  - Mitigation: Accept known gaps; complement with `flux build` and focused YAML linters.

## Risk-Based Testing Strategy

Priority 1 (High):
- `flux build` for infra/apps; assert no `${VAR}`; assert correct `k8sServiceHost` and `k8sServicePort`.
- Validate HelmRelease apiVersion and `sourceRef.kind: OCIRepository` + `version` key present.

Priority 2 (Medium):
- CI preflight for OCI tag `1.18.3` (networked only); fallback policy check.
- Diff bootstrap values vs Flux HelmRelease values (automation optional).

Priority 3 (Low):
- Document SERVICE_CIDR usage; verify presence but not referenced by this chart.

## risk_summary (paste into gate file)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 3
    medium: 4
    low: 3
  highest:
    id: TECH-002
    score: 6
    title: "Flux postBuild substitution misconfigured or not applied"
  recommendations:
    must_fix:
      - "Add/verify postBuild.substituteFrom to reference ConfigMap/cluster-settings in both clusters"
      - "Wire cilium/core Kustomization in infra/apps with healthChecks"
      - "Add CI preflight: verify OCI mirror or use official Cilium OCI for 1.18.3"
    monitor:
      - "Optional CI: helm template chart render to detect value key drift"
      - "Periodic diff: bootstrap values vs HelmRelease"
```
