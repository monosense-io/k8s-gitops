# Test Design: Story 01 — STORY-NET-CILIUM-CORE-GITOPS

Date: 2025-10-27
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 15
- Unit tests: 0 (0%)
- Integration tests: 12 (80%)
- E2E tests: 3 (20%)
- Priority distribution: P0: 3, P1: 12, P2: 0

Rationale: This story is “manifests-first” with local-only validation. Most coverage is integration-level (manifest schema, structure, and Flux build outputs). E2E denotes repository-level flows across clusters (infra/apps) using Flux build and cross-cluster diffing.

## Test Scenarios by Acceptance Criteria

### AC-1: Directory Structure and Cluster Settings Created

| ID                                   | Level       | Priority | Test                                                                                   | Justification                                 |
|--------------------------------------|-------------|----------|----------------------------------------------------------------------------------------|-----------------------------------------------|
| 01.core-INT-001                      | Integration | P1       | Verify required directories exist under `kubernetes/infrastructure/networking/cilium/` | Ensures structure for component reconciliation |
| 01.core-INT-002                      | Integration | P1       | Parse cluster-settings for infra/apps with `yq eval` (no YAML errors)                  | Validates config files are syntactically sound |
| 01.core-INT-003                      | Integration | P1       | Assert `.data.CILIUM_VERSION == "1.18.3"` in both cluster-settings                     | Pinned version required per story              |

### AC-2: GitOps Resources Created and Valid

| ID                                   | Level       | Priority | Test                                                                                           | Justification                                         |
|--------------------------------------|-------------|----------|------------------------------------------------------------------------------------------------|-------------------------------------------------------|
| 01.core-INT-004                      | Integration | P1       | Validate `ocirepository.yaml` fields: `spec.url` and `ref.semver == "1.18.3"`                 | Ensures correct chart source/version                    |
| 01.core-INT-005                      | Integration | P1       | Validate `networking/cilium/kustomization.yaml` includes `ocirepository.yaml`                  | Guarantees source is reconciled                        |
| 01.core-INT-006                      | Integration | P1       | Validate `core/kustomization.yaml` includes `helmrelease.yaml`                                 | Guarantees HelmRelease is part of component build      |
| 01.core-INT-007                      | Integration | P1       | Sanity-check HelmRelease spec fields present (namespace, chartRef, values keys)               | Early structural guard before Flux applies              |

### AC-3: Per-Cluster Variable Substitution Configured

| ID                                   | Level | Priority | Test                                                                                                                           | Justification                                       | Mitigates |
|--------------------------------------|-------|----------|--------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|-----------|
| 01.core-E2E-001                      | E2E   | P0       | `flux build kustomization -f kubernetes/clusters/infra/infrastructure.yaml --path .` has no `${VAR}` placeholders               | Confirms `postBuild.substituteFrom` is effective    | TECH-002  |
| 01.core-E2E-002                      | E2E   | P0       | `flux build kustomization -f kubernetes/clusters/apps/infrastructure.yaml --path .` has no `${VAR}` placeholders                | Same as above for apps cluster                      | TECH-002  |

### AC-4: Local Validation Passes

| ID                                   | Level       | Priority | Test                                                                                                 | Justification                                |
|--------------------------------------|-------------|----------|------------------------------------------------------------------------------------------------------|----------------------------------------------|
| 01.core-INT-008                      | Integration | P1       | `kustomize build kubernetes/infrastructure/networking/cilium/core | kubeconform --strict` passes                      | Schema conformance                            |
| 01.core-INT-009                      | Integration | P1       | `kustomize build kubernetes/infrastructure/networking/cilium/core` completes without error            | Baseline build integrity                      |

### AC-5: Cilium Features Configured in Manifests

| ID                                   | Level       | Priority | Test                                                                                  | Justification                                   |
|--------------------------------------|-------------|----------|---------------------------------------------------------------------------------------|-------------------------------------------------|
| 01.core-INT-010                      | Integration | P1       | Validate HelmRelease values: strict kubeProxyReplacement, WireGuard enabled, BGP CP, Hubble, Prometheus, ServiceMonitor, etc. | Ensures required feature flags are present      |

### AC-6: Cross-Cluster Manifest Consistency

| ID                                   | Level | Priority | Test                                                                                                                      | Justification                                                     |
|--------------------------------------|-------|----------|---------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|
| 01.core-E2E-003                      | E2E   | P1       | Diff infra vs apps `flux build` outputs; verify differences limited to CLUSTER, CLUSTER_ID, POD_CIDR, SERVICE_CIDR, IPs   | Guards consistency and ensures only expected substitutions differ  |

### Non-AC Conformance (Architecture/Quality)

| ID                                   | Level       | Priority | Test                                                                                                                      | Justification                                      | Mitigates |
|--------------------------------------|-------------|----------|---------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------|-----------|
| 01.core-INT-011                      | Integration | P1       | Cluster `infrastructure.yaml` includes `./kubernetes/infrastructure/networking/cilium/core` (infra and apps)               | Ensures component wired at cluster level           | TECH-001  |
| 01.core-INT-012                      | Integration | P1       | Cluster Kustomization sets `wait: true`, `prune: true`, `timeout: 10m`, and healthChecks for cilium/cilium-operator         | Baseline reliability of reconciliation            | OPS-001   |
| 01.core-INT-013                      | Integration | P0       | CI-only: Confirm OCI ref `oci://ghcr.io/home-operations/charts-mirror/cilium:1.18.3` resolves (or use official fallback)   | Prevents source failures during reconcile         | TECH-003  |

## Risk Coverage

- TECH-002 (substitution not applied): Covered by 01.core-E2E-001 and 01.core-E2E-002.
- TECH-001 (missing wiring): Covered by 01.core-INT-011.
- TECH-003 (OCI source availability): Covered by 01.core-INT-013.
- OPS-001 (missing health checks/timeouts): Covered by 01.core-INT-012.

## Recommended Execution Order

1. P0: 01.core-E2E-001, 01.core-E2E-002, 01.core-INT-013 (CI-only)
2. P1: 01.core-INT-001 → 01.core-INT-007 (structure and resource presence)
3. P1: 01.core-INT-008, 01.core-INT-009 (schema/build)
4. P1: 01.core-INT-010 (feature flags)
5. P1: 01.core-E2E-003 (cross-cluster diff)
6. P1: 01.core-INT-011, 01.core-INT-012 (cluster wiring and health)

## Gate YAML Block (test_design)

```yaml
test_design:
  scenarios_total: 15
  by_level:
    unit: 0
    integration: 12
    e2e: 3
  by_priority:
    p0: 3
    p1: 12
    p2: 0
  coverage_gaps: []
```

## Notes

- Kubeconform CRD schemas for Flux kinds may require custom schema locations in CI; if unavailable, restrict schema validation to native kinds and treat CRDs as structure-checked via yq.
- OCI ref validation is a CI/networked environment test; not required for local offline validation.

