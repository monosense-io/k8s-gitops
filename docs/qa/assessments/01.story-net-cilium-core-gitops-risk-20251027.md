# Risk Profile: Story 01 — STORY-NET-CILIUM-CORE-GITOPS

Date: 2025-10-27
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 10
- Critical Risks: 0
- High Risks: 3
- Medium Risks: 3
- Low/Minimal Risks: 4
- Overall Story Risk Score: 64/100

## Critical/High Risks Requiring Attention

### 1) TECH-002: Flux postBuild substitution not applied (Highest)
- Score: 6 (High) — Probability: Medium (2), Impact: High (3)
- Description: Cluster Kustomizations may omit `postBuild.substituteFrom: ConfigMap/cluster-settings`, leaving `${VAR}` unresolved in HelmRelease at deploy time.
- Mitigation (preventive): Ensure cluster `infrastructure.yaml` defines `postBuild.substituteFrom` for both clusters; add CI check that fails if `${` appears in `flux build` output.
- Testing focus: Run `flux build kustomization -f kubernetes/clusters/{infra,apps}/infrastructure.yaml --path .` and grep for `${` (must be zero).

### 2) TECH-001: Missing cluster wiring for cilium/core after removing per-component ks.yaml
- Score: 6 (High) — Probability: Medium (2), Impact: High (3)
- Description: With aggregator ks.yaml removed, teams must wire `./kubernetes/infrastructure/networking/cilium/core` in each cluster `infrastructure.yaml` with health checks/timeouts; omission blocks reconciliation.
- Mitigation: Provide canonical `Kustomization` snippets for both clusters; add CI guard that verifies directory inclusion.
- Testing focus: `flux build` for both clusters must include a HelmRelease named `cilium` in `kube-system`.

### 3) TECH-003: OCI mirror availability/incorrect ref
- Score: 6 (High) — Probability: Medium (2), Impact: High (3)
- Description: `oci://ghcr.io/home-operations/charts-mirror/cilium` may be inaccessible or not contain 1.18.3.
- Mitigation: Verify chart exists; document fallback to official Cilium OCI; optionally pin by digest; add CI preflight to fetch tags/manifest.
- Testing focus: Non-networked validation can’t pull, but CI in networked env must attempt `flux reconcile source oci` or equivalent dry-run.

## Risk Matrix

| Risk ID   | Description                                                      | Prob | Impact | Score | Priority |
|-----------|------------------------------------------------------------------|------|--------|-------|----------|
| TECH-002  | postBuild substitution omitted in cluster Kustomizations         | 2    | 3      | 6     | High     |
| TECH-001  | cilium/core not wired in cluster infrastructure                  | 2    | 3      | 6     | High     |
| TECH-003  | OCI mirror unavailable/incorrect version                         | 2    | 3      | 6     | High     |
| OPS-002   | CRD lifecycle mismatch vs Story 43 (CreateReplace vs separate)  | 2    | 2      | 4     | Medium   |
| TECH-004  | Gateway/BGP flags in core causing scope overlap with later work  | 2    | 2      | 4     | Medium   |
| OPS-001   | Missing healthChecks/timeouts in cluster Kustomizations          | 2    | 2      | 4     | Medium   |
| SEC-001   | Supply-chain trust of mirror (signing/provenance)                | 1    | 3      | 3     | Low      |
| PERF-001  | kubeProxyReplacement strict compatibility issues later           | 1    | 2      | 2     | Low      |
| TECH-005  | Cluster-settings values drift from architecture                  | 1    | 2      | 2     | Low      |
| OPS-003   | Local `flux build` path misuse by contributors                   | 1    | 1      | 1     | Minimal  |

## Risk Mitigations and Test Requirements

- For TECH-002 (substitution):
  - Actions: Add `postBuild.substituteFrom: ConfigMap/cluster-settings` in both cluster `infrastructure.yaml`; CI step: run `flux build` for both clusters and fail on `${`.
  - Tests: Add a script target to run both builds; compare infra vs apps diffs limited to `CLUSTER`, `CLUSTER_ID`, CIDRs, and assigned IPs.

- For TECH-001 (wiring):
  - Actions: Provide and adopt canonical snippets including `healthChecks`, `wait: true`, `prune: true`, `timeout: 10m`.
  - Tests: `grep -R "kubernetes/infrastructure/networking/cilium/core" kubernetes/clusters/*/infrastructure.yaml` in CI; build must include the HelmRelease.

- For TECH-003 (OCI source):
  - Actions: Validate tag availability; document fallback to official registry; optional digest pin.
  - Tests: Networked CI preflight to confirm the OCI ref resolves; alert if not.

- For OPS-002 (CRDs):
  - Actions: Confirm CRD ownership split with Story 43; if CRDs are managed elsewhere, set HelmRelease CRD strategy accordingly and document.
  - Tests: kubeconform schema runs with provided CRD schemas where needed.

- For TECH-004 (scope overlap):
  - Actions: Keep BGP/Gateway feature values present but disabled in core unless explicitly required; ensure dedicated stories own enablement.
  - Tests: Verify helm values align with intended story boundaries.

## Risk-Based Testing Strategy

- Priority 1 (High): Flux build substitution verification; cluster wiring presence; OCI ref existence.
- Priority 2 (Medium): CRD lifecycle validation and healthChecks; scope separation for BGP/Gateway.
- Priority 3 (Low): Version compatibility notes; style/CI consistency.

## Monitoring and Controls

- Add CI checks: kubeconform; flux build for infra/apps; grep for `${` in outputs; diff outputs to confirm only cluster-specific changes.
- Optional: Configure alerting for Flux `Kustomization` readiness on first deploy in Story 45.

## Gate YAML Snippet (risk_summary)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 3
    medium: 3
    low: 4
  highest:
    id: TECH-002
    score: 6
    title: "Flux postBuild substitution not applied"
  recommendations:
    must_fix:
      - "Add postBuild.substituteFrom and verify with flux build (infra/apps)"
      - "Wire cilium/core in both cluster infrastructure.yaml with healthChecks"
      - "Verify OCI mirror contains 1.18.3 or use official Cilium OCI"
    monitor:
      - "Validate CRD ownership vs Story 43 and set strategy consistently"
      - "Keep BGP/Gateway enablement scoped to dedicated stories"
```

## Story Hook

Risk profile path: `docs/qa/assessments/01.story-net-cilium-core-gitops-risk-20251027.md`

