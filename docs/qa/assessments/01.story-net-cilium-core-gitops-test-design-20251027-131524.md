# Test Design: Story 01.story-net-cilium-core-gitops

Date: 2025-10-27
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 0 (0%)
- Integration tests: 18 (100%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 3, P1: 15, P2: 0
- Rationale: This story is manifests‑only; validation is performed by static build and schema tools (kustomize, flux build, kubeconform, yq). Runtime e2e is deferred to Story 45 (VALIDATE‑NETWORKING).

## Test Scenarios by Acceptance Criteria

### AC‑1: Directory Structure and Cluster Settings Created

| ID                                      | Level       | Priority | Test                                                                 | Justification |
| --------------------------------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 01.story-net-cilium-core-gitops-INT-001 | Integration | P1       | Verify directory structure exists for `kubernetes/infrastructure/networking/cilium/{core,bgp,gateway,clustermesh,ipam}` and cluster dirs with `flux-system/` | Ensures greenfield scaffolding present |
| 01.story-net-cilium-core-gitops-INT-002 | Integration | P1       | Validate `kubernetes/clusters/{infra,apps}/cluster-settings.yaml` with `yq eval` | Syntax correctness of inputs |
| 01.story-net-cilium-core-gitops-INT-003 | Integration | P1       | Assert `.data.CILIUM_VERSION == "1.18.3"` for both clusters via `yq` | Version pin correctness |
| 01.story-net-cilium-core-gitops-INT-004 | Integration | P1       | Assert presence of `.data.K8S_SERVICE_HOST` (and `.data.K8S_SERVICE_PORT` when added) for both clusters | Required for HelmRelease values |

### AC‑2: GitOps Resources Created and Valid

| ID                                      | Level       | Priority | Test                                                                                   | Justification |
| --------------------------------------- | ----------- | -------- | -------------------------------------------------------------------------------------- | ------------- |
| 01.story-net-cilium-core-gitops-INT-005 | Integration | P1       | OCIRepository manifest exists with URL `oci://…/cilium` and `ref.semver: "1.18.3"`     | Source availability and version pin |
| 01.story-net-cilium-core-gitops-INT-006 | Integration | P0       | HelmRelease apiVersion `helm.toolkit.fluxcd.io/v2` and chart `spec.version: ${CILIUM_VERSION}` | Prevent schema/version miswiring (TECH‑004) |
| 01.story-net-cilium-core-gitops-INT-007 | Integration | P0       | HelmRelease `spec.chart.spec.sourceRef.kind: OCIRepository`, `name: cilium-charts`     | Correct OCI wiring (TECH‑004) |
| 01.story-net-cilium-core-gitops-INT-008 | Integration | P1       | Component kustomization includes `helmrelease.yaml` under `core/`                      | Kustomize component integrity |
| 01.story-net-cilium-core-gitops-INT-009 | Integration | P0       | Cluster `infrastructure.yaml` includes `cilium/core` with `prune: true`, `wait: true`, `timeout: 10m` and healthChecks for DS `cilium` and Deploy `cilium-operator` | Ordering/health readiness (OPS‑003) |

### AC‑3: Per‑Cluster Variable Substitution Configured

| ID                                      | Level       | Priority | Test                                                                 | Justification |
| --------------------------------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 01.story-net-cilium-core-gitops-INT-010 | Integration | P0       | `flux build` infra: assert no `${` tokens; `k8sServiceHost` and, if present, `k8sServicePort` resolved | Detects substitution failures (TECH‑002) |
| 01.story-net-cilium-core-gitops-INT-011 | Integration | P0       | `flux build` apps: assert no `${` tokens; host/port resolved         | Detects substitution failures (TECH‑002) |
| 01.story-net-cilium-core-gitops-INT-012 | Integration | P1       | Inspect cluster Kustomization for `postBuild.substituteFrom` referencing `ConfigMap/cluster-settings` | Ensures substitution source wired |

### AC‑4: Local Validation Passes

| ID                                      | Level       | Priority | Test                                                                 | Justification |
| --------------------------------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 01.story-net-cilium-core-gitops-INT-013 | Integration | P1       | `kustomize build kubernetes/infrastructure/networking/cilium/core` succeeds | Component builds |
| 01.story-net-cilium-core-gitops-INT-014 | Integration | P1       | `kubeconform --strict -ignore-missing-schemas` passes on built manifests | Schema validation |
| 01.story-net-cilium-core-gitops-INT-015 | Integration | P1       | Confirm no CRDs present in component build (no kind: CustomResourceDefinition) | Scope control |

### AC‑5: Cilium Features Configured (Core Only)

| ID                                      | Level       | Priority | Test                                                                 | Justification |
| --------------------------------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 01.story-net-cilium-core-gitops-INT-016 | Integration | P1       | Verify values include `kubeProxyReplacement: true`; `encryption: {enabled: true, type: wireguard}` | Feature flags correctness |
| 01.story-net-cilium-core-gitops-INT-017 | Integration | P1       | Verify `hubble.enabled: true`, `hubble.relay.enabled: true`, `hubble.ui.enabled: false`; `prometheus.serviceMonitor.enabled: true` | Observability config correctness |

### AC‑6: Cross‑Cluster Manifest Consistency

| ID                                      | Level       | Priority | Test                                                                 | Justification |
| --------------------------------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 01.story-net-cilium-core-gitops-INT-018 | Integration | P1       | Diff infra vs apps `flux build` outputs; differences limited to cluster‑specific values (CLUSTER, CLUSTER_ID, POD_CIDR_STRING, SERVICE_CIDR, CLUSTERMESH_IP, LB IPs, ASN) | Confirms substitution and parity |

### AC‑7/AC‑8
- AC‑7 (OCI preflight) executed only in networked CI; document policy and evidence path.
- AC‑8 (QA gate) satisfied by presence of risk_summary and this test design in `docs/qa/gates/01.story-net-cilium-core-gitops.yml`.

## Risk Coverage

- TECH‑002 covered by INT‑010, INT‑011 (P0)
- TECH‑004 covered by INT‑006, INT‑007 (P0)
- OPS‑003 covered by INT‑009 (P0)
- OPS‑002 covered by AC‑7 policy (documented, CI‑only)
- OPS‑004 covered by INT‑010/011 host/port checks
- TECH‑001 covered by cross‑cluster diff INT‑018 and bootstrap diff policy note

## Recommended Execution Order

1. P0 integration tests: INT‑006, INT‑007, INT‑009, INT‑010, INT‑011 (fast, build‑time checks)
2. Remaining P1 integration tests in AC order

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 0
    integration: 18
    e2e: 0
  by_priority:
    p0: 3
    p1: 15
    p2: 0
  coverage_gaps: []
```

## Trace References

Test design matrix: docs/qa/assessments/01.story-net-cilium-core-gitops-test-design-YYYYMMDD.md
P0 tests identified: 3

