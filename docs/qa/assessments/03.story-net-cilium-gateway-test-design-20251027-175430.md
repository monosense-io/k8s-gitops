# Test Design: STORY-NET-CILIUM-GATEWAY (03)

Date: 2025-10-27 (rev 2)
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 20
- By level: Unit 8, Integration 12, E2E 0 (runtime E2E deferred to Story 45)
- Priority distribution: P0: 7, P1: 9, P2: 4
- Rationale: Unit tests validate manifest structure; integration tests validate Flux/Kustomize rendering and substitutions; E2E moved to validation story.

## Test Scenarios by Acceptance Criteria

### AC‑1: GatewayClass Manifest Created
- Description: gatewayclass.yaml exists; name cilium; controllerName io.cilium/gateway-controller

| ID                 | Level | Priority | Test                                                         | Justification |
|--------------------|-------|----------|--------------------------------------------------------------|---------------|
| 03.GW-UNIT-001     | Unit  | P0       | File exists: `gatewayclass.yaml`; `.metadata.name==cilium`   | Core presence |
| 03.GW-UNIT-002     | Unit  | P0       | `.spec.controllerName=="io.cilium/gateway-controller"`      | Correct controller |

Command examples
```bash
yq '.kind' kubernetes/infrastructure/networking/cilium/gateway/gatewayclass.yaml | grep '^GatewayClass$'
yq '.metadata.name' kubernetes/infrastructure/networking/cilium/gateway/gatewayclass.yaml | grep '^cilium$'
yq '.spec.controllerName' kubernetes/infrastructure/networking/cilium/gateway/gatewayclass.yaml | grep '^io.cilium/gateway-controller$'
```

### AC‑2: Gateway Manifest Created
- Description: gateway.yaml exists; name cluster-gateway in kube-system; gatewayClassName cilium; addresses[0] with IP; listeners HTTP/HTTPS; TLS refs

| ID                 | Level       | Priority | Test                                                                                | Justification |
|--------------------|-------------|----------|-------------------------------------------------------------------------------------|---------------|
| 03.GW-UNIT-003     | Unit        | P0       | `.metadata.name=="cluster-gateway" && .metadata.namespace=="kube-system"`         | Naming/NS     |
| 03.GW-UNIT-004     | Unit        | P0       | `.spec.gatewayClassName=="cilium"`                                                | Class link     |
| 03.GW-UNIT-005     | Unit        | P1       | `.spec.addresses[0].type=="IPAddress" && .spec.addresses[0].value` placeholder    | Address shape  |
| 03.GW-UNIT-006     | Unit        | P1       | Listeners include HTTP:80 and HTTPS:443; allowedRoutes.namespaces.from==All         | Listener shape |
| 03.GW-INT-001      | Integration | P0       | TLS certRef points to Secret `wildcard-tls` in kube-system (via render)            | TLS wiring     |

Example assertions
```bash
yq '.spec.listeners[] | select(.protocol=="HTTP") | .port' kubernetes/.../gateway/gateway.yaml | grep '^80$'
yq '.spec.listeners[] | select(.protocol=="HTTPS") | .port' kubernetes/.../gateway/gateway.yaml | grep '^443$'
```

### AC‑3: Certificate Manifest Created
- Description: certificate.yaml exists; namespace kube-system; secretName wildcard-tls; issuerRef kind ClusterIssuer name letsencrypt-production; dnsNames include wildcard and root

| ID                 | Level       | Priority | Test                                                                                         | Justification |
|--------------------|-------------|----------|----------------------------------------------------------------------------------------------|---------------|
| 03.GW-UNIT-007     | Unit        | P0       | certificate.yaml exists; `.metadata.namespace=="kube-system"`; `.spec.secretName=="wildcard-tls"` | TLS secret    |
| 03.GW-UNIT-008     | Unit        | P1       | `.spec.issuerRef.kind=="ClusterIssuer" && .spec.issuerRef.name=="letsencrypt-production"`       | Issuer ref    |
| 03.GW-INT-002      | Integration | P1       | Rendered dnsNames contain `*.${SECRET_DOMAIN}` and `${SECRET_DOMAIN}` substituted              | Substitution  |

### AC‑4: Cluster‑Specific Substitution
- Description: Flux build renders cluster IPs; certificate domains substituted

| ID                 | Level       | Priority | Test                                                                                           | Justification |
|--------------------|-------------|----------|------------------------------------------------------------------------------------------------|---------------|
| 03.GW-INT-003      | Integration | P0       | Infra build ⇒ `.spec.addresses[0].value==10.25.11.110`                                         | Critical IP   |
| 03.GW-INT-004      | Integration | P0       | Apps build ⇒ `.spec.addresses[0].value==10.25.11.121`                                          | Critical IP   |
| 03.GW-INT-005      | Integration | P1       | Certificate dnsNames substituted (no `${SECRET_DOMAIN}` placeholders)                           | Correct DNS   |
| 03.GW-INT-006      | Integration | P1       | No unresolved placeholders in any rendered gateway files                                        | Hygiene       |

Commands
```bash
flux build -f kubernetes/clusters/infra/infrastructure.yaml --path . | yq 'select(.kind=="Gateway") | .spec.addresses[0].value'
flux build -f kubernetes/clusters/apps/infrastructure.yaml --path . | yq 'select(.kind=="Gateway") | .spec.addresses[0].value'
flux build -f kubernetes/clusters/infra/infrastructure.yaml --path . | yq '.. | scalars | select(type=="!!str" and test("\\$\\{[^}]+\\}"))' && exit 1 || true
```

### AC‑5: Cluster‑Level Kustomization
- Description: Add cilium-gateway Kustomization to both clusters with dependsOn; health checks present

| ID                 | Level       | Priority | Test                                                                                         | Justification |
|--------------------|-------------|----------|----------------------------------------------------------------------------------------------|---------------|
| 03.GW-INT-007      | Integration | P0       | `kubernetes/clusters/infra/infrastructure.yaml` contains Kustomization `metadata.name: cilium-gateway` | Wiring infra  |
| 03.GW-INT-008      | Integration | P0       | Same for apps cluster                                                                         | Wiring apps   |
| 03.GW-INT-009      | Integration | P1       | `dependsOn` includes `cilium-core` and `cilium-ipam` for both clusters                        | Ordering      |
| 03.GW-INT-010      | Integration | P1       | Health checks include GatewayClass/Gateway (optional)                                         | Health        |

Example assertions
```bash
yq 'select(.kind=="Kustomization" and .metadata.name=="cilium-gateway") | .spec.path' kubernetes/clusters/infra/infrastructure.yaml | grep './kubernetes/infrastructure/networking/cilium/gateway'
yq 'select(.kind=="Kustomization" and .metadata.name=="cilium-gateway") | .spec.dependsOn[].name' kubernetes/clusters/apps/infrastructure.yaml | sort | uniq | grep -E 'cilium-core|cilium-ipam'
```

### AC‑6: Local Validation Passes
- Description: dry-run, kustomize build, flux build, kubeconform strict (ignore missing)

| ID                 | Level       | Priority | Test                                                     | Justification |
|--------------------|-------------|----------|----------------------------------------------------------|---------------|
| 03.GW-INT-011      | Integration | P1       | `kubectl apply --dry-run=client -f .../gateway/` succeeds | Syntax        |
| 03.GW-INT-012      | Integration | P1       | `kustomize build .../gateway` succeeds                    | Structure     |
| 03.GW-INT-013      | Integration | P1       | `kubeconform --strict -ignore-missing-schemas` passes     | Schemas       |

### Risk-Driven Assurance Tests
- Derived from QA Risk Profile rev 2

| ID                 | Level       | Priority | Test                                                                                                   | Mitigates |
|--------------------|-------------|----------|--------------------------------------------------------------------------------------------------------|-----------|
| 03.GW-INT-014      | Integration | P0       | Cilium HelmRelease sets `values.gatewayAPI.enabled: true`                                              | GAPI-001  |
| 03.GW-INT-015      | Integration | P1       | Rendered Gateway IP lies within the cluster’s IPAM pool bounds                                         | IPAM-001  |
| 03.GW-INT-016      | Integration | P2       | YAML structural lint: `yq eval '.'` on all gateway files succeeds                                      | SCHEMA-001|
| 03.GW-INT-017      | Integration | P2       | Optional: `certificateRefs[].namespace` omitted or equals `kube-system` (consistency)                   | SEC-001   |

Example assertions
```bash
yq '.spec.values.gatewayAPI.enabled' kubernetes/infrastructure/networking/cilium/core/helmrelease.yaml | grep -E 'true|True'
# IP in range (infra example):
start=$(yq '.spec.blocks[0].start' kubernetes/infrastructure/networking/cilium/ipam/infra/lb-ippool-infra.yaml)
end=$(yq '.spec.blocks[0].stop' kubernetes/infrastructure/networking/cilium/ipam/infra/lb-ippool-infra.yaml)
actual=$(flux build -f kubernetes/clusters/infra/infrastructure.yaml --path . | yq 'select(.kind=="Gateway") | .spec.addresses[0].value')
python - <<'PY'
import ipaddress, os
print(ipaddress.ip_address(os.environ['start']) <= ipaddress.ip_address(os.environ['actual']) <= ipaddress.ip_address(os.environ['end']))
PY
```

## Risk Coverage
- P0 tests map to DEP-001, GAPI-001, substitution accuracy, and cluster wiring.
- IPAM and schema hygiene covered via P1/P2.

## Recommended Execution Order
1) P0: 001–005, 003–004, 007–008, 014
2) P1: 006, 008, 009–013, 015
3) P2: 016–017

## Gate Block (for gate files)
```yaml
test_design:
  scenarios_total: 20
  by_level: { unit: 8, integration: 12, e2e: 0 }
  by_priority: { p0: 7, p1: 9, p2: 4 }
  coverage_gaps: []
```
