# Test Design: Story 02 — STORY-NET-CILIUM-IPAM

Date: 2025-10-27
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 14
- Unit tests: 4 (29%)
- Integration tests: 10 (71%)
- E2E tests: 0 (0%) — runtime validation deferred to Story 45
- Priority distribution: P0: 4, P1: 8, P2: 2

Rationale: This is a manifests-only story. Coverage emphasizes structural/content checks of manifests and Flux build outputs. No runtime cluster tests are defined here; those are covered in Story 45 (VALIDATE-NETWORKING).

## Test Scenarios by Acceptance Criteria

### AC‑1: IPAM Pool Manifests Created (Per‑Cluster Inclusion)

| ID                      | Level       | Priority | Test                                                                                         | Justification                                  | Mitigates   |
|-------------------------|-------------|----------|----------------------------------------------------------------------------------------------|-----------------------------------------------|-------------|
| 02.ipam-UNIT-001        | Unit        | P1       | YAML parse both pool files (infra/apps) with yq                                               | Basic syntax correctness                       | TECH-001    |
| 02.ipam-INT-001         | Integration | P1       | Assert `apiVersion=cilium.io/v2alpha1`, `kind=CiliumLoadBalancerIPPool` for both files       | Correct CR kind/version                        | TECH-001    |
| 02.ipam-INT-002         | Integration | P0       | Assert `.metadata.namespace` is absent (cluster‑scoped)                                       | Prevent scope errors                           | TECH-001    |
| 02.ipam-INT-003         | Integration | P1       | Assert names `infra-pool` and `apps-pool`                                                    | Naming per story                               |             |
| 02.ipam-INT-004         | Integration | P0       | Assert blocks match `10.25.11.100-119` (infra) and `10.25.11.120-139` (apps)                 | Enforces pool boundaries                        | OPS-001     |

### AC‑2: Kustomization Created (Component + Cluster‑Level)

| ID                      | Level       | Priority | Test                                                                                                               | Justification                                     | Mitigates |
|-------------------------|-------------|----------|--------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|-----------|
| 02.ipam-UNIT-002        | Unit        | P1       | Component kustomizations exist: `ipam/infra/kustomization.yaml`, `ipam/apps/kustomization.yaml`                    | Ensures component build roots exist               | TECH-002  |
| 02.ipam-UNIT-003        | Unit        | P1       | No `kind: Kustomization` CRs under `kubernetes/infrastructure/networking/cilium/ipam/**`                           | CRs belong at cluster level                       | TECH-002  |
| 02.ipam-INT-005         | Integration | P0       | Cluster Kustomizations added: `cilium-ipam` (infra/apps) with correct `spec.path` and `dependsOn: cilium-core`     | Correct wiring and ordering                       | TECH-002  |
| 02.ipam-INT-006         | Integration | P0       | `flux build -f kubernetes/clusters/infra/infrastructure.yaml --path .` includes only `infra-pool` (not apps-pool) | Validates per‑cluster inclusion                   | TECH-002  |
| 02.ipam-INT-007         | Integration | P0       | `flux build -f kubernetes/clusters/apps/infrastructure.yaml --path .` includes only `apps-pool`                    | Validates per‑cluster inclusion                   | TECH-002  |

### AC‑3: Cluster Settings Alignment

| ID                      | Level       | Priority | Test                                                                                                      | Justification                             | Mitigates |
|-------------------------|-------------|----------|-----------------------------------------------------------------------------------------------------------|-------------------------------------------|-----------|
| 02.ipam-INT-008         | Integration | P1       | If present, assert `CILIUM_LB_POOL_START/END` match pools for infra/apps                                   | Documentation keys align with manifests  | OPS-002   |
| 02.ipam-INT-009         | Integration | P1       | Bootstrap: assert ClusterMesh annotations are `10.25.11.100` (infra) and `10.25.11.120` (apps)            | Prevents stale 10.25.12.x values         | OPS-002   |
| 02.ipam-INT-010         | Integration | P1       | Bootstrap: assert infra gateway annotation is `10.25.11.110` and apps gateway `10.25.11.121`               | Aligns with IP plan                       | OPS-002   |

### AC‑4: Local Validation Passes

| ID                      | Level       | Priority | Test                                                                                                                             | Justification                          | Mitigates |
|-------------------------|-------------|----------|----------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|-----------|
| 02.ipam-INT-011         | Integration | P1       | `kustomize build ipam/infra | kubeconform --strict -ignore-missing-schemas` passes                                           | Schema/syntax conformance              | TECH-003  |
| 02.ipam-INT-012         | Integration | P1       | `kustomize build ipam/apps | kubeconform --strict -ignore-missing-schemas` passes                                            | Schema/syntax conformance              | TECH-003  |
| 02.ipam-INT-013         | Integration | P0       | `flux build -f kubernetes/clusters/infra/infrastructure.yaml --path .` shows no `${` placeholders for IPAM resources           | Confirms substitutions resolved        | TECH-002  |
| 02.ipam-INT-014         | Integration | P0       | `flux build -f kubernetes/clusters/apps/infrastructure.yaml --path .` shows no `${` placeholders for IPAM resources            | Confirms substitutions resolved        | TECH-002  |

### AC‑5: Pool Segmentation Correct

| ID                      | Level       | Priority | Test                                                                                                         | Justification                         | Mitigates |
|-------------------------|-------------|----------|--------------------------------------------------------------------------------------------------------------|---------------------------------------|-----------|
| 02.ipam-UNIT-004        | Unit        | P0       | yq assert: no overlap between ranges across infra/apps pool files                                            | Prevents IP conflicts                 | OPS-001   |
| 02.ipam-INT-015         | Integration | P1       | Confirm both ranges lie within `10.25.11.0/24` (regex check on start/stop)                                   | Ensures subnet alignment               | OPS-001   |
| 02.ipam-INT-016         | Integration | P2       | Optional: compute IP counts (20 each) via script and assert                                                  | Sanity on address counts              | OPS-001   |

## Risk Coverage

- TECH-001 (CRD scope/fields mismatch): Covered by 02.ipam-INT-001/002 and namespace absence checks.
- TECH-002 (Flux miswiring/mis-path): Covered by 02.ipam-INT-005/006/007 and no‑placeholder checks (013/014).
- OPS-001 (range overlap): Covered by 02.ipam-INT-004, 02.ipam-UNIT-004, 02.ipam-INT-015/016.
- OPS-002 (bootstrap inconsistencies): Covered by 02.ipam-INT-009/010.
- TECH-003 (schema blind spots): Addressed by kubeconform strict mode with ignore‑missing‑schemas.

## Recommended Execution Order

1. P0: 02.ipam-INT-004 (boundaries), 02.ipam-UNIT-004 (non‑overlap), 02.ipam-INT-005/006/007 (wiring), 02.ipam-INT-013/014 (no placeholders)
2. P1: 02.ipam-UNIT-001, 02.ipam-INT-001/003, 02.ipam-INT-011/012, 02.ipam-INT-008/009/010, 02.ipam-INT-015
3. P2: 02.ipam-INT-016 (IP count)

## Gate YAML Block (test_design)

```yaml
test_design:
  scenarios_total: 14
  by_level:
    unit: 4
    integration: 10
    e2e: 0
  by_priority:
    p0: 4
    p1: 8
    p2: 2
  coverage_gaps: []
```

## Notes

- For the optional IP count test, a small helper (bash/python) can convert dotted addresses to integers and assert inclusive counts. Keep it CI‑only.
- Kubeconform may require schema location hints for CRDs; we rely on `--strict -ignore-missing-schemas` and structural checks via yq.
- Runtime validation (pool enforcement and service IP allocation) belongs to Story 45.

