# Test Design: Story 01 — STORY-NET-CILIUM-CORE-GITOPS

Date: 2025-10-27
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 0 (0%)
- Integration tests: 18 (100%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 3, P1: 15, P2: 0

Rationale: Manifests‑first, local‑only validation. Coverage focuses on file presence, schema/structure, Flux build substitution, and cross‑cluster consistency. Runtime validation is deferred to Story 45 (VALIDATE‑NETWORKING).

## Test Scenarios by Acceptance Criteria

### AC‑1: Directory Structure and Cluster Settings Created

| ID                         | Level       | Priority | Test                                                                                   | Justification                                 |
|----------------------------|-------------|----------|----------------------------------------------------------------------------------------|-----------------------------------------------|
| 01.core-INT-001            | Integration | P1       | Verify required directories exist under `kubernetes/infrastructure/networking/cilium/` | Ensures structure for component reconciliation |
| 01.core-INT-002            | Integration | P1       | Parse cluster-settings (infra/apps) with `yq eval` (no YAML errors)                    | Validates configs are syntactically sound      |
| 01.core-INT-003            | Integration | P1       | Assert `.data.CILIUM_VERSION == "1.18.3"` in both cluster-settings                     | Pinned version required per story              |

### AC‑2: GitOps Resources Created and Valid

| ID                         | Level       | Priority | Test                                                                                           | Justification                                         |
|----------------------------|-------------|----------|------------------------------------------------------------------------------------------------|-------------------------------------------------------|
| 01.core-INT-004            | Integration | P1       | Validate `ocirepository.yaml` fields: `spec.url` and `ref.semver == "1.18.3"`                 | Correct chart source/version                         |
| 01.core-INT-005            | Integration | P1       | Validate `networking/cilium/kustomization.yaml` includes `ocirepository.yaml`                  | Ensures source gets reconciled                        |
| 01.core-INT-006            | Integration | P1       | Validate `core/kustomization.yaml` includes `helmrelease.yaml`                                 | Ensures HelmRelease is included                       |
| 01.core-INT-007            | Integration | P1       | Sanity‑check HelmRelease spec: apiVersion v2, namespace, sourceRef, values keys                | Early structural guard                                |

### AC‑3: Per‑Cluster Variable Substitution Configured

| ID                         | Level       | Priority | Test                                                                                                                        | Justification                                     | Mitigates |
|----------------------------|-------------|----------|-----------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|-----------|
| 01.core-INT-008            | Integration | P0       | HelmRelease contains placeholders `${CLUSTER}`, `${CLUSTER_ID}`, `${POD_CIDR_STRING}`, `${SERVICE_CIDR}`, `${CILIUM_VERSION}` | Ensures no hard‑coded values                       | TECH-002  |
| 01.core-INT-009            | Integration | P0       | Cluster Kustomizations define `postBuild.substituteFrom: ConfigMap/cluster-settings` (infra and apps)                        | Substitution owned by cluster Kustomizations       | TECH-002  |
| 01.core-INT-010            | Integration | P0       | `flux build -f kubernetes/clusters/infra/infrastructure.yaml --path .` has no `${VAR}`                                        | Confirms substitution effective (infra)            | TECH-002  |
| 01.core-INT-011            | Integration | P0       | `flux build -f kubernetes/clusters/apps/infrastructure.yaml --path .` has no `${VAR}`                                         | Confirms substitution effective (apps)             | TECH-002  |

### AC‑4: Local Validation Passes

| ID                         | Level       | Priority | Test                                                                                                 | Justification                                |
|----------------------------|-------------|----------|------------------------------------------------------------------------------------------------------|----------------------------------------------|
| 01.core-INT-012            | Integration | P1       | `kustomize build kubernetes/infrastructure/networking/cilium/core` completes without error           | Baseline build integrity                      |
| 01.core-INT-013            | Integration | P1       | `kustomize build ... | kubeconform --strict -ignore-missing-schemas` passes                          | Schema conformance                            |
| 01.core-INT-014            | Integration | P1       | `flux build` output contains `k8sServiceHost` equal to cluster `K8S_SERVICE_HOST` (infra/apps)       | Confirms key substitution correctness         |

### AC‑5: Cilium Features Configured in Manifests (Core Only)

| ID                         | Level       | Priority | Test                                                                                               | Justification                                   |
|----------------------------|-------------|----------|----------------------------------------------------------------------------------------------------|-------------------------------------------------|
| 01.core-INT-015            | Integration | P1       | Validate HelmRelease values: strict kubeProxyReplacement, WireGuard enabled, Hubble, metrics       | Ensures required core feature flags             |
| 01.core-INT-016            | Integration | P1       | Negative: Ensure no `gatewayAPI.enabled` or `bgpControlPlane.enabled` keys in HelmRelease values   | Prevents scope creep into non‑core features     |

### AC‑6: Cross‑Cluster Manifest Consistency

| ID                         | Level       | Priority | Test                                                                                                                      | Justification                                                     |
|----------------------------|-------------|----------|---------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|
| 01.core-INT-017            | Integration | P1       | Diff infra vs apps `flux build` outputs; differences limited to CLUSTER, CLUSTER_ID, POD_CIDR, SERVICE_CIDR, IPs, ASN     | Guards consistency; expected substitutions only  |

### AC‑7: OCI Source Availability (CI preflight)

| ID                         | Level       | Priority | Test                                                                                             | Justification                        | Mitigates |
|----------------------------|-------------|----------|--------------------------------------------------------------------------------------------------|--------------------------------------|-----------|
| 01.core-INT-018            | Integration | P0       | CI‑only: Confirm OCI mirror resolves `1.18.3` or fall back to official Cilium OCI                | Prevent source failures in reconcile | TECH-004  |

## Risk Coverage

- TECH‑002 (substitution misconfigured/not applied): 01.core-INT-008..011
- OPS‑003 (cluster wiring/healthChecks): covered implicitly via 01.core-INT-007 and AC‑4 build checks; add explicit check when wiring PR lands.
- TECH‑004 (OCI availability): 01.core-INT-018
- TECH‑007 (healthChecks): Confirmed when cluster Kustomizations are added; include in wiring PR validation.

## Recommended Execution Order

1. P0: 01.core-INT-010, 01.core-INT-011, 01.core-INT-018 (CI‑only)
2. P1: 01.core-INT-001 → 01.core-INT-007 (structure/resources)
3. P1: 01.core-INT-012, 013 (build/schema)
4. P1: 01.core-INT-014 (key substitution)
5. P1: 01.core-INT-015, 016 (feature flags)
6. P1: 01.core-INT-017 (cross‑cluster diff)

## Gate YAML Block (test_design)

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 0
    integration: 18
    e2e: 0
  by_priority:
    p0: 3
    p1: 15
    p2: 0
  coverage_gaps: []
```

## Notes

- kubeconform validates the HelmRelease CR, not the rendered Cilium chart. Optional CI step: `helm template` the pinned chart to catch value key drift.
- OCI ref validation is CI/networked only; local environment may be offline.

