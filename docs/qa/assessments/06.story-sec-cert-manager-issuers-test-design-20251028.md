# Test Design: Story 06 — STORY-SEC-CERT-MANAGER-ISSUERS — Create cert-manager Issuer Manifests

Date: 2025-10-28
Designer: Quinn (Test Architect)
Story File: docs/stories/STORY-SEC-CERT-MANAGER-ISSUERS.md

## Test Strategy Overview

- Total test scenarios: 14
- Unit tests: 1 (7%)
- Integration tests: 13 (93%)
- E2E tests: 0 (0%) — Deployment/E2E explicitly deferred to Story 45
- Priority distribution: P0: 4, P1: 10, P2: 0

Rationale: This story is manifests-only. Tests focus on static validation, composition correctness, and Flux build-time substitutions. No cluster access or runtime issuance is included.

## Test Scenarios by Acceptance Criteria

### AC1: ClusterIssuer Manifests Created

#### Scenarios

| ID          | Level       | Priority | Test                                                                 | Justification |
| ----------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 06-UNIT-001 | Unit        | P1       | YAML syntax lint for `kubernetes/infrastructure/security/cert-manager/*.yaml` | Pure static validation |
| 06-INT-001  | Integration | P1       | `yq` select: two ClusterIssuers exist with names `letsencrypt-staging`/`letsencrypt-production` | Structural correctness |
| 06-INT-002  | Integration | P1       | `yq` select: ACME servers are staging/prod endpoints as specified     | Field validation |
| 06-INT-003  | Integration | P1       | `yq` select: DNS-01 solver uses Cloudflare and selector `dnsZones: [ ${SECRET_DOMAIN} ]` | Solver configuration |

### AC2: ExternalSecret Manifest Created

#### Scenarios

| ID          | Level       | Priority | Test                                                                 | Justification |
| ----------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 06-INT-004  | Integration | P0       | `yq` select: ExternalSecret references `ClusterSecretStore/onepassword` | Secret store correctness (risk SEC-001/SEC-002) |
| 06-INT-005  | Integration | P0       | `yq` select: `spec.data[0].remoteRef.key == ${CERTMANAGER_CLOUDFLARE_SECRET_PATH}` and `property: credential` | Prevents secret key mismatch |
| 06-INT-006  | Integration | P1       | `yq` select: target secret name `cloudflare-api-token`, namespace `cert-manager` | Consumer alignment |

### AC3: Wildcard Certificate Manifest Created

#### Scenarios

| ID          | Level       | Priority | Test                                                                 | Justification |
| ----------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 06-INT-007  | Integration | P1       | `yq` select: Certificate name `wildcard-tls`, ns `kube-system`, secretName `wildcard-tls` | Structural correctness |
| 06-INT-008  | Integration | P1       | `yq` select: DNS names include `*.${SECRET_DOMAIN}` and `${SECRET_DOMAIN}` | Domain coverage |
| 06-INT-009  | Integration | P1       | `yq` select: `issuerRef.name == letsencrypt-production` and kind `ClusterIssuer` | Issuer wiring |

### AC4: PrometheusRule Manifest Created

#### Scenarios

| ID          | Level       | Priority | Test                                                                 | Justification |
| ----------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 06-INT-010  | Integration | P1       | `yq` select: PrometheusRule in ns `cert-manager` with rules `CertManagerAbsent`, `CertificateExpiringSoon`, `CertificateNotReady` | Alert coverage present |

### AC5: Kustomization Created (glue + Flux Kustomization)

#### Scenarios

| ID          | Level       | Priority | Test                                                                 | Justification |
| ----------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 06-INT-011  | Integration | P1       | `yq` select: glue `kustomization.yaml` resources include all 4 manifests | Composition correctness |
| 06-INT-012  | Integration | P1       | `yq` select: `ks.yaml` has `dependsOn: [ { name: external-secrets } ]` | Ordering to avoid deadlocks (risk TECH-001) |
| 06-INT-013  | Integration | P1       | `yq` select: `ks.yaml` postBuild `substituteFrom` includes `ConfigMap/cluster-settings` | Substitution source configured |

### AC6: Cluster Settings Alignment

#### Scenarios

| ID          | Level       | Priority | Test                                                                 | Justification |
| ----------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 06-INT-014  | Integration | P0       | Grep `kubernetes/clusters/infra/cluster-settings.yaml` for keys `LETSENCRYPT_EMAIL`, `SECRET_DOMAIN`, `CERTMANAGER_CLOUDFLARE_SECRET_PATH` | Prevents mis‑issuance/mis‑substitution (risk OPS-001) |
| 06-INT-015  | Integration | P0       | Grep `kubernetes/clusters/apps/cluster-settings.yaml` for same keys    | Cross‑cluster consistency |

### AC7: Local Validation Passes (no cluster access)

#### Scenarios

| ID          | Level       | Priority | Test                                                                 | Justification |
| ----------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 06-INT-016  | Integration | P1       | `kubectl --dry-run=client -f kubernetes/infrastructure/security/cert-manager/` | Syntax gate across manifests |
| 06-INT-017  | Integration | P1       | `kustomize build kubernetes/infrastructure/security/cert-manager`      | Build gate across kustomization |
| 06-INT-018  | Integration | P1       | `flux build kustomization cluster-infra-infrastructure --path ./kubernetes/infrastructure | yq` check for `.spec.acme.email` and domains | Verifies substitution wiring without a cluster |
| 06-INT-019  | Integration | P1       | `flux build kustomization cluster-apps-infrastructure --path ./kubernetes/infrastructure | yq` check for `.spec.dnsNames` and ExternalSecret path | Verifies domain/email/path substitution |

Note: Tests 06-INT-018/019 are executed locally using the Flux CLI build mode and do not require a live Kubernetes cluster.

## Risk Coverage

- SEC-001 (Over‑privileged Cloudflare token): 06-INT-004/006 — validate store/namespace/secret mapping; scope review remains manual but flagged in gate
- TECH-001 (dependsOn mismatch): 06-INT-012 — enforce exact `dependsOn` name
- OPS-001 (Wrong SECRET_DOMAIN): 06-INT-014/015/019 — validate domain present and substituted
- SEC-002 (property mismatch): 06-INT-005 — validate `remoteRef.property: credential` and key mapping
- TECH-002 (PrometheusRule CRD missing): Covered by Story 45; here we statically ensure resource presence (06-INT-010)
- TECH-003 (healthChecks timeout): Deferred; this story keeps healthChecks but runtime behavior validated in Story 45
- OPS-003 (Namespace assumptions): 06-INT-006/010 implicitly require correct namespace values
- OPS-002/TECH-004/OPS-004: Addressed via 06-UNIT-001, 06-INT-016/017 and AC4 checks

## Recommended Execution Order

1. P0 integration checks for cluster-settings keys (06-INT-014/015)
2. ExternalSecret critical mapping (06-INT-004/005/006)
3. Kustomization composition and ordering (06-INT-011/012/013)
4. ClusterIssuer and Certificate static field checks (06-INT-001/002/003/007/008/009)
5. PrometheusRule presence (06-INT-010)
6. Lint/build gates (06-UNIT-001, 06-INT-016/017)
7. Flux build substitution checks (06-INT-018/019)

## Commands (Examples)

```bash
# Unit lint
kubectl --dry-run=client -f kubernetes/infrastructure/security/cert-manager/

# Glue composition
yq '.resources[]' kubernetes/infrastructure/security/cert-manager/kustomization.yaml

# Issuers present
yq 'select(.kind=="ClusterIssuer") | .metadata.name' kubernetes/infrastructure/security/cert-manager/clusterissuers.yaml

# ExternalSecret mapping
yq 'select(.kind=="ExternalSecret") | .spec.secretStoreRef, .spec.data[0].remoteRef' kubernetes/infrastructure/security/cert-manager/externalsecret-cloudflare.yaml

# Flux build substitution (infra)
flux build kustomization cluster-infra-infrastructure --path ./kubernetes/infrastructure \
  | yq 'select(.kind=="ClusterIssuer" and .metadata.name=="letsencrypt-production") | .spec.acme.email'

# Flux build substitution (apps)
flux build kustomization cluster-apps-infrastructure --path ./kubernetes/infrastructure \
  | yq 'select(.kind=="Certificate" and .metadata.name=="wildcard-tls") | .spec.dnsNames'
```

## Output: Gate YAML Block

```yaml
test_design:
  scenarios_total: 14
  by_level:
    unit: 1
    integration: 13
    e2e: 0
  by_priority:
    p0: 4
    p1: 10
    p2: 0
  coverage_gaps: []
```

## Trace References

Test design matrix: docs/qa/assessments/06.story-sec-cert-manager-issuers-test-design-20251028.md
P0 tests identified: 4

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate for a manifests-only story
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent

