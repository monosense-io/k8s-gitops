<!-- Powered by BMAD™ Core → QA Risk Profile -->

# Risk Profile: Story 02 — STORY-NET-CILIUM-IPAM

Date: 2025-10-27
Reviewer: Quinn (Test Architect & Quality Advisor)
Story: docs/stories/STORY-NET-CILIUM-IPAM.md
Scope: Create per‑cluster CiliumLoadBalancerIPPool manifests and cluster‑level Flux wiring (no deployment).

## Executive Summary

- Total Risks Identified: 9
- Critical: 0, High: 3, Medium: 4, Low: 2
- Overall Posture: Manageable with clear mitigations; proceed once PO corrections in this story are merged and basic preflight checks pass.

## Risk Matrix

| Risk ID | Category | Description | Prob | Impact | Score | Priority |
|---|---|---|---|---|---|---|
| TECH-001 | Technical | CRD scope/fields mismatch (namespace set or relying on unsupported spec.disabled) | 2 | 3 | 6 | High |
| TECH-002 | Technical | Flux path/dependsOn miswire includes both pools in a single cluster build | 2 | 3 | 6 | High |
| OPS-001 | Operational | IP range overlap or boundary errors (off‑by‑one) | 2 | 3 | 6 | High |
| TECH-003 | Technical | Kubeconform miss due to missing CRD schemas hides YAML errors | 2 | 2 | 4 | Medium |
| OPS-002 | Operational | Inconsistent alignment with bootstrap annotations (historical 10.25.12.x bug) | 2 | 2 | 4 | Medium |
| OPS-003 | Operational | Cluster‑level Kustomization omitted; pools never applied later in Story 45 | 2 | 2 | 4 | Medium |
| TECH-004 | Technical | Service selector defaults cause unintended allocation behavior later | 1 | 2 | 2 | Low |
| SEC-001 | Security | Exposing incorrect IPs could route test traffic to wrong segments in Story 45 | 1 | 2 | 2 | Low |
| BUS-001 | Business | Rework if ranges change post‑approval due to external constraints | 1 | 2 | 2 | Low |

Legend: Probability/Impact — High(3), Medium(2), Low(1). Score = P×I.

## Top Risks (Details)

1) TECH-001 — CRD scope/fields
- Description: CiliumLoadBalancerIPPool is cluster‑scoped; setting `metadata.namespace` or relying on non‑portable fields (e.g., `spec.disabled`) can fail validation or behave unpredictably across versions.
- Detection: kustomize + kubeconform (ignore‑missing‑schemas) plus static review of resource scope; flux dry‑runs should show cluster‑scoped objects without namespace.
- Mitigation: Use per‑cluster inclusion (infra/apps dirs), omit namespace, avoid spec.disabled; if isolation by selector is desired, use labels + serviceSelector.
- Residual Risk: Low.

2) TECH-002 — Flux miswiring
- Description: Incorrect `path` or missing `dependsOn: cilium-core` may include wrong pools or block reconciliation sequence.
- Mitigation: Add `cilium-ipam` Kustomization under `kubernetes/clusters/{infra,apps}/infrastructure.yaml` with correct path and dependsOn; verify via `flux build ... --path .` that only expected pool appears per cluster.
- Residual Risk: Low.

3) OPS-001 — Range overlap/boundaries
- Description: Off‑by‑one errors or typos can overlap infra/apps pools.
- Mitigation: yq assertions comparing start/stop across both files; include in validation script; peer review against docs/IP-ALLOCATION-SUMMARY.md.
- Residual Risk: Low.

## Mitigations and Validation

- Preventive
  - Per‑cluster inclusion pattern (no spec.disabled); omit namespace in CR.
  - Cluster‑level `cilium-ipam` Kustomization with `dependsOn: cilium-core`.
  - Guardrails: yq non‑overlap check; flux dry‑run verifies exactly one pool per cluster.
- Detective
  - Add `scripts/validate-cilium-ipam.sh` mirroring core script: kustomize + kubeconform + flux builds + yq assertions.
  - CI job to run validation on PRs touching `ipam/` or `cluster-settings.yaml`.
- Corrective
  - If overlap detected, adjust ranges and re‑run validations; ensure bootstrap annotations remain consistent.

## risk_summary (for gate files)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 3
    medium: 4
    low: 2
  highest:
    id: TECH-001
    score: 6
    title: "CRD scope/fields mismatch (cluster-scoped, field portability)"
  recommendations:
    must_fix:
      - "Adopt per-cluster inclusion; remove namespace/spec.disabled from CRs"
      - "Add cluster-level Kustomization 'cilium-ipam' with dependsOn: cilium-core"
      - "Add yq non-overlap checks across both pool files"
    monitor:
      - "Align bootstrap annotations and cluster-settings with IP plan"
      - "Flux build outputs must show exactly one pool per cluster"
```

## Notes

- This assessment focuses on manifest creation (no runtime). Security and networking functional risks are handled in Story 45 validation.
- Residual risk is low once mitigations are in place and validations are automated.

