# QA Risk Profile — STORY-NET-CILIUM-GATEWAY (2025-10-27)

- Story file: `docs/stories/STORY-NET-CILIUM-GATEWAY.md`
- Reviewer: Quinn (Test Architect & Quality Advisor)
- Method: Probability × Impact (BMAD risk framework)

## Executive Summary
- Total risks: 8
- Critical: 0, High: 1, Medium: 4, Low: 3
- Highest risk: DEP-001 (Cert-Manager dependency ordering for Certificate manifests)
- Readiness impact: Medium — manifests-first approach is solid; deployment gating must be handled in cluster Kustomizations.

## Risk Matrix
| ID       | Category | Description | Prob. | Impact | Score | Priority |
|----------|----------|-------------|-------|--------|-------|----------|
| DEP-001  | OPS      | Certificate depends on ClusterIssuer `letsencrypt-production`; if cert-manager CRDs/issuers not applied before gateway manifests, Flux apply will fail | High (3) | High (3) | 9 | High |
| WIRE-001 | OPS      | Cluster-level Kustomization for `cilium-gateway` not added or lacks dependsOn; manifests won’t reconcile | Medium (2) | Medium (2) | 4 | Medium |
| API-001  | TECH     | Gateway API `spec.addresses` vs legacy annotation; older Gateway API or Cilium versions could ignore addresses | Low (1) | Medium (2) | 2 | Low |
| SUB-001  | TECH     | Bad or missing `${CILIUM_GATEWAY_LB_IP}` substitution from cluster-settings | Medium (2) | Medium (2) | 4 | Medium |
| IPAM-001 | TECH     | Gateway IP not inside IPAM pool range (cross-pool conflict) | Low (1) | Medium (2) | 2 | Low |
| SCHEMA-001| OPS     | Local schema validation missing CRDs; false confidence without `-ignore-missing-schemas` | Medium (2) | Low (1) | 2 | Low |
| SEC-001  | SEC      | Storing wildcard TLS secret in `kube-system` increases blast radius if compromised | Low (1) | Medium (2) | 2 | Low |
| NET-001  | OPS      | Gateway deployed before BGP reachability validated; external reachability fails | Medium (2) | Medium (2) | 4 | Medium |

Legend: Score = Probability × Impact; 9=Critical, 6=High, 4=Medium, 2–3=Low

## Detailed Risks and Mitigations

### DEP-001 — Cert-Manager dependency ordering (Score 9)
- Signals: `kubernetes/infrastructure/security/cert-manager` directory not found; Story 06 is prerequisite but cluster Kustomization may reconcile Certificate earlier.
- Mitigations:
  - Add a cluster-level `Kustomization` for cert-manager issuers and set `dependsOn` from `cilium-gateway` to that Kustomization when available.
  - Alternatively, move `Certificate` to its own Kustomization that depends on cert-manager; keep Gateway/GatewayClass separate.
  - Keep local validation tolerant with `kubeconform --strict -ignore-missing-schemas`.
- Testing focus:
  - Flux build shows `Certificate` rendered with `${SECRET_DOMAIN}`.
  - After Story 06, verify `ClusterIssuer/letsencrypt-production` Ready=True before reconciling gateway.

### WIRE-001 — Missing/wrong cluster wiring (Score 4)
- Signals: Current cluster files include `cilium-core` and `cilium-ipam` only. Gateway Kustomization must be appended by this story.
- Mitigations:
  - Append `cilium-gateway` Kustomization with `dependsOn: [cilium-core, cilium-ipam]` in both clusters.
  - Add healthChecks for `GatewayClass/cilium` and `Gateway/cluster-gateway` objects.
- Testing focus: `flux build -f kubernetes/clusters/{infra,apps}/infrastructure.yaml --path . | yq 'select(.kind=="Gateway") | .spec.addresses[0].value'`.

### API-001 — Gateway API field compatibility (Score 2)
- Signals: Using `spec.addresses`; architecture targets Gateway API v1 and Cilium 1.18.3 which support it.
- Mitigations: None required for targeted versions; keep annotation fallback commented in doc for emergency rollback.
- Testing focus: `kubeconform` with Gateway API schemas when available.

### SUB-001 — Substitution risk for `${CILIUM_GATEWAY_LB_IP}` (Score 4)
- Signals: Relies on `postBuild.substituteFrom: cluster-settings`.
- Mitigations: Ensure key exists in both cluster ConfigMaps (verified: infra=10.25.11.110, apps=10.25.11.121). Add CI check for presence.
- Testing focus: Flux build renders correct IP per cluster; value within expected range.

### IPAM-001 — IP pool alignment (Score 2)
- Signals: Gateway IP must lie within pool ranges (infra .100–.119, apps .120–.139).
- Mitigations: Keep ranges in `docs/IP-ALLOCATION-SUMMARY.md`; add yq check comparing `.spec.addresses[0].value` vs pool bounds.
- Testing focus: Build-time assertion using yq in CI.

### SCHEMA-001 — Local validation without CRDs (Score 2)
- Mitigations: Use `kubeconform --strict -ignore-missing-schemas` and pin schemas when practical.
- Testing focus: Run kubeconform pipelines on PR.

### SEC-001 — TLS secret scope (Score 2)
- Mitigations: Limit RBAC for secret access; consider dedicated namespace in future; keep as accepted risk for platform infra.
- Testing focus: RBAC policy review.

### NET-001 — BGP readiness before exposure (Score 4)
- Mitigations: Deploy gateway after BGP Control Plane validation (separate story); document sequencing in runbooks.
- Testing focus: Smoke test via node-local curl before advertising.

## Recommendations
- Must-fix before deployment:
  - Add cluster-level `cilium-gateway` Kustomization to both clusters with correct dependsOn.
  - Ensure cert-manager issuers are available before reconciling `Certificate` (either via dependsOn or separate Kustomization for the certs).
- Monitor:
  - Schema compatibility for Gateway API v1 with current Cilium chart version.
  - Substitution values for `${CILIUM_GATEWAY_LB_IP}` in CI.

## Gate Snippet (for gate files)
```yaml
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 4
    low: 3
  highest:
    id: DEP-001
    score: 9
    title: Cert-Manager dependency ordering for Certificate manifests
  recommendations:
    must_fix:
      - Add cluster-level cilium-gateway Kustomization with dependsOn
      - Ensure cert-manager issuers before reconciling Certificate
    monitor:
      - Verify Gateway API schema compatibility with Cilium
      - Validate IP substitution from cluster-settings
```

## References
- Story: `docs/stories/STORY-NET-CILIUM-GATEWAY.md`
- Architecture: `docs/architecture.md` §10 Networking (Cilium)
- Cluster settings: `kubernetes/clusters/{infra,apps}/cluster-settings.yaml`
- IP allocation: `docs/IP-ALLOCATION-SUMMARY.md`
