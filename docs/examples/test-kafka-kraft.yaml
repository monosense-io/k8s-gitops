# Test Kafka Cluster (KRaft Mode)
#
# This is a minimal single-node Kafka cluster for testing Strimzi operator functionality.
# DO NOT use this configuration in production.
#
# Purpose: Validate operator installation and basic Kafka operations
# Cluster: apps
# Namespace: messaging
#
# Usage:
#   kubectl apply -f test-kafka-kraft.yaml
#
# Cleanup:
#   kubectl delete -f test-kafka-kraft.yaml
#
---
apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: test-kafka
  namespace: messaging
  labels:
    app.kubernetes.io/name: test-kafka
    app.kubernetes.io/component: kafka
    app.kubernetes.io/part-of: strimzi
spec:
  # Kafka broker configuration
  kafka:
    version: 3.9.0
    replicas: 1  # Single node for testing

    # Listeners
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: scram-sha-512

    # Kafka configuration
    config:
      # Minimal replication for single-node
      offsets.topic.replication.factor: 1
      transaction.state.log.replication.factor: 1
      transaction.state.log.min.isr: 1
      default.replication.factor: 1
      min.insync.replicas: 1

      # Log retention (short for testing)
      log.retention.hours: 1
      log.segment.bytes: 104857600  # 100MB

      # KRaft mode (no ZooKeeper)
      # Automatically enabled in Strimzi 0.48.0

    # Storage (ephemeral for testing - data lost on pod restart)
    storage:
      type: ephemeral

    # Resource requests/limits
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi

  # Entity Operator (manages topics and users)
  entityOperator:
    # Topic Operator
    topicOperator:
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 256Mi

    # User Operator
    userOperator:
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 256Mi

---
# Test Topic
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: test-topic
  namespace: messaging
  labels:
    strimzi.io/cluster: test-kafka
    app.kubernetes.io/name: test-topic
spec:
  partitions: 3
  replicas: 1  # Single replica (single-node cluster)
  config:
    retention.ms: 3600000  # 1 hour
    segment.bytes: 104857600  # 100MB
    compression.type: producer

---
# Test User
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: test-user
  namespace: messaging
  labels:
    strimzi.io/cluster: test-kafka
    app.kubernetes.io/name: test-user
spec:
  # Authentication
  authentication:
    type: scram-sha-512

  # Authorization (simple ACLs)
  authorization:
    type: simple
    acls:
      # Allow all operations on test-topic
      - resource:
          type: topic
          name: test-topic
          patternType: literal
        operations:
          - Read
          - Write
          - Describe
          - Create
          - Delete
        host: "*"

      # Allow consumer group operations
      - resource:
          type: group
          name: test-consumer-group
          patternType: literal
        operations:
          - Read
          - Describe
        host: "*"

      # Allow describe on cluster
      - resource:
          type: cluster
        operations:
          - Describe
        host: "*"

---
# Verification Instructions (embedded as ConfigMap)
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-kafka-verification
  namespace: messaging
data:
  README.md: |
    # Test Kafka Cluster Verification

    ## 1. Check Cluster Status

    ```bash
    # Check Kafka cluster
    kubectl get kafka test-kafka -n messaging

    # Check Kafka pods
    kubectl get pods -n messaging -l strimzi.io/cluster=test-kafka

    # Check logs
    kubectl logs -n messaging -l strimzi.io/name=test-kafka-kafka -c kafka
    ```

    ## 2. Verify Topic

    ```bash
    # Check topic
    kubectl get kafkatopic test-topic -n messaging

    # Describe topic
    kubectl describe kafkatopic test-topic -n messaging
    ```

    ## 3. Verify User

    ```bash
    # Check user
    kubectl get kafkauser test-user -n messaging

    # Get user credentials
    kubectl get secret test-user -n messaging -o jsonpath='{.data.password}' | base64 -d
    echo
    ```

    ## 4. Test Producer/Consumer

    ### Start Consumer

    ```bash
    kubectl run kafka-consumer -ti --rm=true \
      --image=quay.io/strimzi/kafka:0.48.0-kafka-3.9.0 \
      --restart=Never -n messaging -- \
      bin/kafka-console-consumer.sh \
        --bootstrap-server test-kafka-kafka-bootstrap:9092 \
        --topic test-topic \
        --from-beginning
    ```

    ### Send Messages (in another terminal)

    ```bash
    kubectl run kafka-producer -ti --rm=true \
      --image=quay.io/strimzi/kafka:0.48.0-kafka-3.9.0 \
      --restart=Never -n messaging -- \
      bin/kafka-console-producer.sh \
        --bootstrap-server test-kafka-kafka-bootstrap:9092 \
        --topic test-topic
    ```

    Type messages and press Enter. Messages should appear in consumer terminal.

    ## 5. Test with SCRAM-SHA-512 Authentication

    ### Create client.properties

    ```bash
    # Get password
    PASSWORD=$(kubectl get secret test-user -n messaging -o jsonpath='{.data.password}' | base64 -d)

    # Create properties file
    cat > /tmp/client.properties <<EOF
    security.protocol=SASL_SSL
    sasl.mechanism=SCRAM-SHA-512
    sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username="test-user" password="${PASSWORD}";
    ssl.truststore.location=/tmp/truststore.jks
    ssl.truststore.password=changeit
    EOF
    ```

    ### Extract cluster CA certificate

    ```bash
    kubectl get secret test-kafka-cluster-ca-cert -n messaging \
      -o jsonpath='{.data.ca\.crt}' | base64 -d > /tmp/ca.crt

    # Create truststore
    keytool -import -trustcacerts -alias root \
      -file /tmp/ca.crt -keystore /tmp/truststore.jks \
      -storepass changeit -noprompt
    ```

    ### Test authenticated connection

    ```bash
    kubectl run kafka-consumer-auth -ti --rm=true \
      --image=quay.io/strimzi/kafka:0.48.0-kafka-3.9.0 \
      --restart=Never -n messaging -- \
      bin/kafka-console-consumer.sh \
        --bootstrap-server test-kafka-kafka-tls-bootstrap:9093 \
        --topic test-topic \
        --consumer.config /tmp/client.properties \
        --from-beginning
    ```

    ## 6. Cleanup

    ```bash
    # Delete test cluster
    kubectl delete -f docs/examples/test-kafka-kraft.yaml

    # Verify PVCs deleted (if persistent storage used)
    kubectl get pvc -n messaging
    ```

    ## Expected Results

    - ✅ Kafka cluster status: Ready
    - ✅ Kafka pods: Running
    - ✅ Topic created successfully
    - ✅ User created with credentials
    - ✅ Producer can send messages
    - ✅ Consumer can receive messages
    - ✅ SCRAM-SHA-512 authentication works
    - ✅ ACLs enforced correctly

    ## Troubleshooting

    ### Cluster Not Ready

    ```bash
    # Check operator logs
    kubectl logs -n strimzi-operator-system -l app.kubernetes.io/name=strimzi-cluster-operator

    # Check events
    kubectl get events -n messaging --sort-by='.lastTimestamp'
    ```

    ### Topic Not Created

    ```bash
    # Check topic operator logs
    kubectl logs -n messaging -l strimzi.io/name=test-kafka-entity-operator -c topic-operator
    ```

    ### Authentication Failures

    ```bash
    # Check user operator logs
    kubectl logs -n messaging -l strimzi.io/name=test-kafka-entity-operator -c user-operator

    # Verify secret exists
    kubectl get secret test-user -n messaging
    ```
