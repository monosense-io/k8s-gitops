---
# PodDisruptionBudget Component (maxUnavailable: 1)
# Ensures high availability by preventing all pods from being disrupted simultaneously
#
# Usage:
#   apiVersion: kustomize.config.k8s.io/v1beta1
#   kind: Kustomization
#   components:
#     - ../../components/pdb-maxunavailable-1
#   resources:
#     - deployment.yaml  # Must have app.kubernetes.io/name label
#
# The PDB will automatically match the Deployment's app.kubernetes.io/name label via replacements

apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
  - poddisruptionbudget.yaml

replacements:
  # Auto-populate PDB name from Deployment
  - source:
      kind: Deployment
      fieldPath: metadata.name
    targets:
      - select:
          kind: PodDisruptionBudget
        fieldPaths:
          - metadata.name

  # Copy app label from Deployment to PDB selector
  - source:
      kind: Deployment
      fieldPath: spec.template.metadata.labels.[app.kubernetes.io/name]
    targets:
      - select:
          kind: PodDisruptionBudget
        fieldPaths:
          - spec.selector.matchLabels.[app.kubernetes.io/name]
