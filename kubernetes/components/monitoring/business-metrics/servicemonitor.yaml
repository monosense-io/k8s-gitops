---
# Business Metrics Service Monitor
# Monitors business-relevant endpoints for KPI tracking
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: business-metrics
  namespace: observability
  labels:
    app.kubernetes.io/name: business-metrics
    app.kubernetes.io/component: monitoring
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: business-metrics
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      honorLabels: true
      metricRelabelings:
        # Add business context labels
        - sourceLabels: [namespace]
          targetLabel: business_unit
          replacement: platform
        - sourceLabels: [pod]
          targetLabel: service_type
          regex: 'gitlab-(.*)'
          replacement: '${1}'
---
# GitLab Business Metrics Service Monitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: gitlab-business-metrics
  namespace: gitlab-system
  labels:
    app.kubernetes.io/name: gitlab
    app.kubernetes.io/component: business-metrics
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: gitlab
      app.kubernetes.io/component: webservice
  endpoints:
    - port: workhorse
      interval: 60s
      path: /metrics
      scheme: http
      metricRelabelings:
        # Business-relevant metric filtering and labeling
        - sourceLabels: [__name__]
          regex: 'gitlab_(builds|pipelines|merge_requests|users|projects)_.*'
          action: keep
        - sourceLabels: [__name__]
          targetLabel: business_domain
          replacement: devops_platform
        - sourceLabels: [__name__]
          targetLabel: metric_category
          regex: 'gitlab_(builds|pipelines).*'
          replacement: cicd
        - sourceLabels: [__name__]
          targetLabel: metric_category
          regex: 'gitlab_(users|projects).*'
          replacement: collaboration
---
# PostgreSQL Business Metrics Service Monitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgresql-business-metrics
  namespace: cnpg-system
  labels:
    app.kubernetes.io/name: cloudnative-pg
    app.kubernetes.io/component: business-metrics
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: shared-postgres
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      metricRelabelings:
        # Focus on business-impact database metrics
        - sourceLabels: [__name__]
          regex: '.*_(connections|transactions|locks|deadlocks).*'
          action: keep
        - sourceLabels: [database]
          targetLabel: business_application
          regex: 'gitlab.*'
          replacement: gitlab
        - sourceLabels: [database]
          targetLabel: business_application
          regex: 'harbor.*'
          replacement: harbor
        - sourceLabels: [database]
          targetLabel: business_application
          regex: 'mattermost.*'
          replacement: mattermost
        - sourceLabels: [database]
          targetLabel: business_application
          regex: 'keycloak.*'
          replacement: keycloak