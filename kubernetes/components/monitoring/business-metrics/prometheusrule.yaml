---
# Business Metrics Alert Rules
# Translates technical alerts into business impact notifications
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: business-metrics-alerts
  namespace: observability
  labels:
    app.kubernetes.io/name: business-metrics
    app.kubernetes.io/component: alerting
spec:
  groups:
    # Business Impact Alerts
    - name: business-impact.rules
      interval: 1m
      rules:
        # GitLab Service Availability - Business Critical
        - alert: GitLabServiceUnavailability
          expr: |
            (
              sum(up{job=~"gitlab.*"}) < 1
            ) or (
              sum(rate(gitlab_http_requests_total{status=~"5.."}[5m])) /
              sum(rate(gitlab_http_requests_total[5m])) > 0.05
            )
          for: 2m
          annotations:
            summary: "GitLab platform service degradation impacting developer productivity"
            description: |
              GitLab platform is experiencing service degradation that directly impacts
              developer productivity and business operations.

              Business Impact:
              - Developer productivity: HIGH
              - Time to market: AFFECTED
              - Collaboration: DISRUPTED

              Current Status: {{ $value | humanizePercentage }} error rate
              Estimated Business Cost: ${{ $value | humanize }} per hour
          labels:
            severity: critical
            business_impact: high
            affected_stakeholders: "development_teams,product_management,executives"

        # Database Performance Impact on Business Operations
        - alert: DatabasePerformanceBusinessImpact
          expr: |
            (
              pg_stat_activity_long_running_queries > 5
            ) or (
              pg_stat_database_connections_active / pg_stat_database_connections_max > 0.9
            )
          for: 5m
          annotations:
            summary: "Database performance issues affecting business operations"
            description: |
              Database performance degradation is impacting business operations:
              - Application response times increased
              - User experience degraded
              - Potential transaction failures

              Affected Applications: {{ range query "pg_stat_activity_long_running_queries" }}{{ .Labels.database }} {{ end }}
              Current Connection Utilization: {{ query "pg_stat_database_connections_active / pg_stat_database_connections_max" }}%

              Business Impact Assessment:
              - Customer Experience: MEDIUM-HIGH
              - Transaction Processing: AFFECTED
              - Revenue Impact: POTENTIAL
          labels:
            severity: warning
            business_impact: medium
            affected_stakeholders: "application_teams,customers,support"

        # Cost Optimization Opportunities
        - alert: ResourceUnderutilizationCostOpportunity
          expr: |
            (
              avg by (namespace) (rate(container_cpu_usage_seconds_total[5m])) < 0.1
              and
              avg by (namespace) (container_spec_cpu_quota) > 1
            ) or (
              avg by (namespace) (container_memory_usage_bytes / container_spec_memory_limit_bytes) < 0.3
              and
              avg by (namespace) (container_spec_memory_limit_bytes) > 1000000000
            )
          for: 24h
          annotations:
            summary: "Cost optimization opportunity detected in {{ $labels.namespace }}"
            description: |
              Resources in namespace {{ $labels.namespace }} are significantly underutilized,
              presenting an opportunity for cost optimization.

              Current CPU Utilization: {{ query "avg by (namespace) (rate(container_cpu_usage_seconds_total[5m]))" }}
              Current Memory Utilization: {{ query "avg by (namespace) (container_memory_usage_bytes / container_spec_memory_limit_bytes)" }}

              Estimated Monthly Savings: $50-200
              Recommended Action: Review resource allocation and consider rightsizing
          labels:
            severity: info
            business_impact: positive
            category: cost_optimization
            stakeholders: "infrastructure_team,finance"

    # Business KPI Alerts
    - name: business-kpi.rules
      interval: 5m
      rules:
        # Developer Productivity Metrics
        - alert: DeveloperProductivityDegradation
          expr: |
            (
              rate(gitlab_builds_failed_total[1h]) / rate(gitlab_builds_total[1h]) > 0.15
            ) or (
              histogram_quantile(0.95, rate(gitlab_builds_duration_seconds_bucket[1h])) > 1800
            )
          for: 15m
          annotations:
            summary: "Developer productivity metrics showing degradation"
            description: |
              Developer productivity indicators are below acceptable thresholds:

              Build Failure Rate: {{ query "rate(gitlab_builds_failed_total[1h]) / rate(gitlab_builds_total[1h])" | humanizePercentage }}
              95th Percentile Build Time: {{ query "histogram_quantile(0.95, rate(gitlab_builds_duration_seconds_bucket[1h]))" | humanizeDuration }}

              Business Impact:
              - Developer velocity: DECREASED
              - Time to market: EXTENDED
              - Team morale: POTENTIALLY AFFECTED

              Recommended Actions:
              1. Investigate failing builds
              2. Review build pipeline optimization
              3. Check resource constraints
          labels:
            severity: warning
            business_impact: medium
            category: productivity
            stakeholders: "development_teams,devops,product_management"

        # User Experience Metrics
        - alert: UserExperienceDegradation
          expr: |
            (
              histogram_quantile(0.95, rate(gitlab_http_request_duration_seconds_bucket[5m])) > 2
            ) or (
              rate(gitlab_http_requests_total{status=~"5.."}[5m]) / rate(gitlab_http_requests_total[5m]) > 0.02
            )
          for: 5m
          annotations:
            summary: "User experience metrics indicate performance degradation"
            description: |
              User experience metrics have degraded beyond acceptable thresholds:

              95th Percentile Response Time: {{ query "histogram_quantile(0.95, rate(gitlab_http_request_duration_seconds_bucket[5m]))" }}s
              Error Rate: {{ query "rate(gitlab_http_requests_total{status=~\"5..\"}[5m]) / rate(gitlab_http_requests_total[5m])" | humanizePercentage }}

              Business Impact:
              - User satisfaction: DEGRADED
              - Product adoption: POTENTIALLY AFFECTED
              - Support tickets: MAY INCREASE
          labels:
            severity: warning
            business_impact: medium
            category: user_experience
            stakeholders: "product_team,support,engineering"

    # Financial Impact Alerts
    - name: financial-impact.rules
      interval: 1h
      rules:
        # Budget Overrun Warning
        - alert: MonthlyBudgetExceededWarning
          expr: |
            sum(increase(container_cpu_usage_seconds_total[30d])) * 0.00005 +
            sum(avg_over_time(container_memory_usage_bytes[30d])) * 0.00000002 >
            10000
          for: 0m
          annotations:
            summary: "Monthly infrastructure budget approaching limit"
            description: |
              Current month's infrastructure spending is approaching the budget limit.

              Estimated Monthly Cost: ${{ $value | humanize }}
              Budget Threshold: $10,000
              Utilization: {{ $value | humanizePercentage }}

              Recommended Actions:
              1. Review resource utilization
              2. Identify optimization opportunities
              3. Consider budget adjustment if usage is justified
          labels:
            severity: warning
            business_impact: financial
            category: budget_management
            stakeholders: "finance,infrastructure_leadership"

        # Storage Cost Alert
        - alert: StorageCostOptimizationOpportunity
          expr: |
            sum(kubelet_volume_stats_used_bytes) / sum(kubelet_volume_stats_capacity_bytes) > 0.85
          for: 1h
          annotations:
            summary: "High storage utilization indicates optimization opportunity"
            description: |
              Storage utilization is high, presenting optimization opportunities:

              Current Utilization: {{ $value | humanizePercentage }}
              Total Storage Used: {{ query "sum(kubelet_volume_stats_used_bytes)" | humanizeBytes }}
              Total Storage Capacity: {{ query "sum(kubelet_volume_stats_capacity_bytes)" | humanizeBytes }}

              Potential Cost Savings:
              - Implement compression: $20-50/month
              - Cleanup unused data: $10-30/month
              - Optimize storage classes: $15-40/month
          labels:
            severity: info
            business_impact: positive
            category: cost_optimization
            stakeholders: "infrastructure_team,finance"

    # Business Process Alerts
    - name: business-process.rules
      interval: 2m
      rules:
        # CI/CD Pipeline Health
        - alert: CICDProcessHealthDegradation
          expr: |
            (
              rate(gitlab_pipelines_failed_total[15m]) / rate(gitlab_pipelines_total[15m]) > 0.1
            ) or (
              histogram_quantile(0.90, rate(gitlab_pipeline_duration_seconds_bucket[15m])) > 1200
            )
          for: 10m
          annotations:
            summary: "CI/CD process health showing degradation"
            description: |
              CI/CD pipeline metrics indicate process health issues:

              Pipeline Failure Rate: {{ query "rate(gitlab_pipelines_failed_total[15m]) / rate(gitlab_pipelines_total[15m])" | humanizePercentage }}
              90th Percentile Duration: {{ query "histogram_quantile(0.90, rate(gitlab_pipeline_duration_seconds_bucket[15m]))" | humanizeDuration }}

              Business Process Impact:
              - Deployment frequency: REDUCED
              - Release quality: COMPROMISED
              - Team confidence: AFFECTED

              Process Improvement Recommendations:
              1. Review failed pipeline configurations
              2. Optimize pipeline stages and dependencies
              3. Check resource constraints
              4. Implement better error handling
          labels:
            severity: warning
            business_impact: medium
            category: process_health
            stakeholders: "devops_teams,development_teams,product_management"