---
# PodMonitor Component
# Creates a PodMonitor for Prometheus metrics scraping directly from pods
# Use when metrics are exposed without a Service (e.g., DaemonSets, sidecars)
#
# Usage:
#   apiVersion: kustomize.config.k8s.io/v1beta1
#   kind: Kustomization
#   components:
#     - ../../../components/monitoring/podmonitor
#   resources:
#     - daemonset.yaml  # or deployment.yaml with app.kubernetes.io/name label

apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
  - podmonitor.yaml

replacements:
  # Auto-populate PodMonitor name from DaemonSet or Deployment
  - source:
      kind: DaemonSet
      fieldPath: metadata.name
    targets:
      - select:
          kind: PodMonitor
        fieldPaths:
          - metadata.name
        options:
          create: true

  - source:
      kind: Deployment
      fieldPath: metadata.name
    targets:
      - select:
          kind: PodMonitor
        fieldPaths:
          - metadata.name
        options:
          create: true

  # Copy app label to PodMonitor selector
  - source:
      kind: DaemonSet
      fieldPath: spec.template.metadata.labels.[app.kubernetes.io/name]
    targets:
      - select:
          kind: PodMonitor
        fieldPaths:
          - spec.selector.matchLabels.[app.kubernetes.io/name]
        options:
          create: true

  - source:
      kind: Deployment
      fieldPath: spec.template.metadata.labels.[app.kubernetes.io/name]
    targets:
      - select:
          kind: PodMonitor
        fieldPaths:
          - spec.selector.matchLabels.[app.kubernetes.io/name]
        options:
          create: true
