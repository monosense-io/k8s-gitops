---
apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: keycloak
  namespace: security
spec:
  instances: 2  # HA with 2 replicas

  # Database configuration
  db:
    vendor: postgres
    host: postgres-rw.databases.svc.cluster.local
    database: keycloak
    port: 5432
    usernameSecret:
      name: keycloak-pguser-secret
      key: username
    passwordSecret:
      name: keycloak-pguser-secret
      key: password

  # HTTP configuration
  http:
    httpEnabled: true  # Backend uses HTTP, Envoy handles TLS termination

  # Hostname configuration
  hostname:
    hostname: sso.monosense.dev
    strict: false  # Allow access via cluster DNS for internal services
    strictBackchannel: false

  # Proxy configuration for Envoy Gateway
  proxy:
    headers: xforwarded  # Trust X-Forwarded-* headers from Envoy

  # Disable default ingress (using Gateway API instead)
  ingress:
    enabled: false

  # Container image configuration
  image: quay.io/keycloak/keycloak:26.0.4

  # Init containers for custom theme
  unsupported:
    podTemplate:
      spec:
        initContainers:
          - name: theme-provider
            image: ghcr.io/trosvald/keycloak-theme:latest
            imagePullPolicy: Always
            command:
              - sh
              - -c
              - |
                echo "Copying custom theme..."
                cp -rv /theme/* /themes/
                echo "Theme copied successfully"
            volumeMounts:
              - name: themes
                mountPath: /themes

        # Main container modifications
        containers:
          - name: keycloak
            env:
              # Admin credentials from secret
              - name: KEYCLOAK_ADMIN
                valueFrom:
                  secretKeyRef:
                    name: keycloak-admin-secret
                    key: username
              - name: KEYCLOAK_ADMIN_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: keycloak-admin-secret
                    key: password

            # Resource limits
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                memory: 2Gi

            # Volume mounts
            volumeMounts:
              - name: themes
                mountPath: /opt/keycloak/themes

        # Volumes
        volumes:
          - name: themes
            emptyDir: {}

  # Additional Keycloak options
  additionalOptions:
    # Cache configuration
    - name: cache
      value: ispn
    - name: cache-stack
      value: kubernetes

    # Theme configuration
    - name: spi-theme-default
      value: custom-redhat

    # Performance tuning
    - name: http-pool-max-threads
      value: "200"

    # Database connection pool
    - name: db-pool-initial-size
      value: "5"
    - name: db-pool-max-size
      value: "20"
    - name: db-pool-min-size
      value: "5"

    # Metrics
    - name: metrics-enabled
      value: "true"

    # Health checks
    - name: health-enabled
      value: "true"

    # Logging
    - name: log-level
      value: INFO
    - name: log-console-output
      value: json

    # Session timeouts
    - name: sso-session-idle-timeout
      value: 30m
    - name: sso-session-max-lifespan
      value: 10h
