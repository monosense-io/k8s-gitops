---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &name gitlab-secret
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: *name
    creationPolicy: Owner
    template:
      data:
        # GitLab root password
        gitlab-root-password: "{{ .GITLAB_ROOT_PASSWORD }}"
        # GitLab Shell secret
        gitlab-shell-secret: "{{ .GITLAB_SHELL_SECRET }}"
        # GitLab Rails secrets
        gitlab-rails-secret: "{{ .GITLAB_RAILS_SECRET }}"
        # Gitaly authentication token
        gitlab-gitaly-token: "{{ .GITLAB_GITALY_TOKEN }}"
        # GitLab Workhorse secret
        gitlab-workhorse-secret: "{{ .GITLAB_WORKHORSE_SECRET }}"
  dataFrom:
    - extract:
        key: dev-gitlab
---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: gitlab-redis-secret
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: gitlab-redis-secret
    creationPolicy: Owner
    template:
      data:
        # Redis connection configuration - no password needed for Dragonfly in cluster
        redis-password: ""
  dataFrom:
    - extract:
        key: dev-gitlab
---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: gitlab-minio-secret
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: gitlab-minio-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # MinIO S3 credentials
        accesskey: "{{ .MINIO_ACCESS_KEY }}"
        secretkey: "{{ .MINIO_SECRET_KEY }}"
        # Connection string for GitLab
        connection: |
          provider: AWS
          region: bsd-lat
          aws_access_key_id: {{ .MINIO_ACCESS_KEY }}
          aws_secret_access_key: {{ .MINIO_SECRET_KEY }}
          aws_signature_version: 4
          host: minio.storage.svc.cluster.local
          endpoint: http://minio.storage.svc.cluster.local:9000
          path_style: true
  dataFrom:
    - extract:
        key: dev-minio
---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: gitlab-registry-secret
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: gitlab-registry-secret
    creationPolicy: Owner
    template:
      data:
        # Registry HTTP secret
        registry-http-secret: "{{ .GITLAB_REGISTRY_HTTP_SECRET | default \"\" }}"
        # Registry notification secret
        registry-notification-secret: "{{ .GITLAB_REGISTRY_NOTIFICATION_SECRET | default \"\" }}"
  dataFrom:
    - extract:
        key: dev-gitlab
