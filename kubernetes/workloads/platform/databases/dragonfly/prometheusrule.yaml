---
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  name: dragonfly
  namespace: dragonfly-system
  labels:
    app.kubernetes.io/name: dragonfly
    app.kubernetes.io/component: monitoring
spec:
  groups:
    - name: dragonfly.availability
      interval: 30s
      rules:
        - alert: DragonflyDown
          expr: up{job="dragonfly-system/dragonfly"} == 0
          for: 5m
          labels:
            severity: critical
            component: dragonfly
          annotations:
            summary: "Dragonfly instance {{ $labels.pod }} is down"
            description: "Dragonfly pod {{ $labels.pod }} has been unreachable for 5 minutes"

        - alert: DragonflyNoPrimary
          expr: count(dragonfly_role{role="master"}) == 0
          for: 2m
          labels:
            severity: critical
            component: dragonfly
          annotations:
            summary: "Dragonfly cluster has no primary instance"
            description: "No Dragonfly primary instance detected for 2 minutes"

        - alert: DragonflyReplicaCountLow
          expr: count(up{job="dragonfly-system/dragonfly"} == 1) < 3
          for: 10m
          labels:
            severity: warning
            component: dragonfly
          annotations:
            summary: "Dragonfly cluster has fewer replicas than expected"
            description: "Dragonfly cluster has {{ $value }} replicas (expected 3)"

    - name: dragonfly.performance
      interval: 30s
      rules:
        - alert: DragonflyMemoryHigh
          expr: (dragonfly_memory_used_bytes / dragonfly_memory_max_bytes) > 0.8
          for: 10m
          labels:
            severity: warning
            component: dragonfly
          annotations:
            summary: "Dragonfly memory usage high on {{ $labels.pod }}"
            description: "Dragonfly pod {{ $labels.pod }} is using {{ $value | humanizePercentage }} of memory limit"

        - alert: DragonflyMemoryCritical
          expr: (dragonfly_memory_used_bytes / dragonfly_memory_max_bytes) > 0.9
          for: 5m
          labels:
            severity: critical
            component: dragonfly
          annotations:
            summary: "Dragonfly memory usage critical on {{ $labels.pod }}"
            description: "Dragonfly pod {{ $labels.pod }} is using {{ $value | humanizePercentage }} of memory limit"

        - alert: DragonflyDiskNearFull
          expr: (dragonfly_disk_used_bytes / dragonfly_disk_size_bytes) > 0.8
          for: 15m
          labels:
            severity: warning
            component: dragonfly
          annotations:
            summary: "Dragonfly disk usage high on {{ $labels.pod }}"
            description: "Dragonfly pod {{ $labels.pod }} is using {{ $value | humanizePercentage }} of disk space"

        - alert: DragonflyCommandRateHigh
          expr: rate(dragonfly_commands_processed_total[5m]) > 10000
          for: 10m
          labels:
            severity: warning
            component: dragonfly
          annotations:
            summary: "Dragonfly command rate very high on {{ $labels.pod }}"
            description: "Dragonfly pod {{ $labels.pod }} is processing {{ $value }} commands/sec"

    - name: dragonfly.replication
      interval: 30s
      rules:
        - alert: DragonflyReplicationLagHigh
          expr: dragonfly_replication_lag_seconds > 10
          for: 5m
          labels:
            severity: warning
            component: dragonfly
          annotations:
            summary: "Dragonfly replication lag high on {{ $labels.pod }}"
            description: "Dragonfly replica {{ $labels.pod }} is {{ $value }}s behind primary"

        - alert: DragonflyReplicationBroken
          expr: dragonfly_connected_slaves == 0 and dragonfly_role{role="master"} == 1
          for: 5m
          labels:
            severity: critical
            component: dragonfly
          annotations:
            summary: "Dragonfly primary has no connected replicas"
            description: "Dragonfly primary has no connected replicas for 5 minutes"

        - alert: DragonflyRoleChange
          expr: changes(dragonfly_role[5m]) > 0
          for: 1m
          labels:
            severity: warning
            component: dragonfly
          annotations:
            summary: "Dragonfly role change detected on {{ $labels.pod }}"
            description: "Dragonfly pod {{ $labels.pod }} role changed (failover event)"
