---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cnpg-backup-validation
  namespace: cnpg-system
  labels:
    app.kubernetes.io/name: cloudnative-pg
    app.kubernetes.io/component: backup-validation
spec:
  # Run daily at 03:00 UTC (1 hour after backup completes)
  schedule: "0 3 * * *"

  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3

  jobTemplate:
    spec:
      backoffLimit: 2

      template:
        metadata:
          labels:
            app: cnpg-backup-validation

        spec:
          restartPolicy: OnFailure

          # Use non-root image with MinIO client pre-installed
          containers:
            - name: validate
              image: minio/mc:latest

              command:
                - /bin/sh
                - -c
                - |
                  set -e

                  # Configure mc alias
                  mc alias set s3 ${S3_ENDPOINT} ${S3_ACCESS_KEY} ${S3_SECRET_KEY}

                  # List recent backups
                  echo "=== Listing recent backups ==="
                  mc ls s3/${BUCKET_NAME}/${CNPG_SHARED_CLUSTER_NAME}/base/ | tail -n 5

                  # Count base backups
                  BACKUP_COUNT=$(mc ls s3/${BUCKET_NAME}/${CNPG_SHARED_CLUSTER_NAME}/base/ | wc -l)
                  echo "Total base backups: ${BACKUP_COUNT}"

                  if [ "${BACKUP_COUNT}" -lt 1 ]; then
                    echo "ERROR: No backups found!"
                    exit 1
                  fi

                  # Check for recent backup (within 48 hours)
                  RECENT_BACKUP=$(mc ls s3/${BUCKET_NAME}/${CNPG_SHARED_CLUSTER_NAME}/base/ --json | \
                    jq -r 'select(.lastModified | fromdateiso8601 > (now - 172800)) | .key' | \
                    head -n 1)

                  if [ -z "${RECENT_BACKUP}" ]; then
                    echo "ERROR: No backup within last 48 hours!"
                    exit 1
                  fi

                  echo "Recent backup found: ${RECENT_BACKUP}"

                  # Verify WAL archive (check for recent WAL files)
                  echo "=== Checking WAL archive ==="
                  WAL_COUNT=$(mc ls s3/${BUCKET_NAME}/${CNPG_SHARED_CLUSTER_NAME}/wals/ --recursive | wc -l)
                  echo "Total WAL files: ${WAL_COUNT}"

                  if [ "${WAL_COUNT}" -lt 1 ]; then
                    echo "ERROR: No WAL files found!"
                    exit 1
                  fi

                  echo "Backup validation completed successfully"

              env:
                - name: S3_ENDPOINT
                  value: ${CNPG_MINIO_ENDPOINT_URL}
                - name: BUCKET_NAME
                  value: ${CNPG_BACKUP_BUCKET}
                - name: CNPG_SHARED_CLUSTER_NAME
                  value: ${CNPG_SHARED_CLUSTER_NAME}
                - name: S3_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: cnpg-minio-credentials
                      key: ACCESS_KEY_ID
                - name: S3_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: cnpg-minio-credentials
                      key: SECRET_ACCESS_KEY

              # Non-root security context
              securityContext:
                runAsNonRoot: true
                runAsUser: 10001
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL

              resources:
                requests:
                  cpu: "50m"
                  memory: "64Mi"
                limits:
                  cpu: "200m"
                  memory: "128Mi"

          # Pod security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 10001
            fsGroup: 10001
            seccompProfile:
              type: RuntimeDefault
