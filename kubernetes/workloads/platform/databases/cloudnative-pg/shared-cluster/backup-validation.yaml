---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cnpg-backup-validation
  namespace: cnpg-system
  labels:
    app.kubernetes.io/name: shared-postgres
    app.kubernetes.io/component: backup-validation
    app.kubernetes.io/part-of: cloudnative-pg
spec:
  schedule: "0 6 * * *"  # Daily at 6 AM UTC
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: cnpg-backup-validation
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup-validator
              image: public.ecr.aws/aws-cli/aws-cli:2
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  echo "Starting backup validation at $(date -u)"

                  # Verify required environment variables
                  test -n "${AWS_ACCESS_KEY_ID:-}" || { echo "ERROR: AWS_ACCESS_KEY_ID not set"; exit 1; }
                  test -n "${AWS_SECRET_ACCESS_KEY:-}" || { echo "ERROR: AWS_SECRET_ACCESS_KEY not set"; exit 1; }
                  test -n "${CNPG_MINIO_ENDPOINT_URL:-}" || { echo "ERROR: CNPG_MINIO_ENDPOINT_URL not set"; exit 1; }
                  test -n "${CNPG_BACKUP_BUCKET:-}" || { echo "ERROR: CNPG_BACKUP_BUCKET not set"; exit 1; }

                  BUCKET_PATH="s3://${CNPG_BACKUP_BUCKET}/shared-postgres"
                  echo "Checking objects in ${BUCKET_PATH}"

                  OBJ_COUNT=$(aws s3 ls "$BUCKET_PATH/" --endpoint-url "$CNPG_MINIO_ENDPOINT_URL" --recursive | wc -l | tr -d ' ')
                  if [ "$OBJ_COUNT" -eq 0 ]; then
                    echo "ERROR: No backup objects found under ${BUCKET_PATH}"
                    exit 1
                  fi
                  echo "âœ“ Found ${OBJ_COUNT} objects under ${BUCKET_PATH}"

                  # Show latest base backup object (best effort)
                  LATEST_BASE=$(aws s3 ls "$BUCKET_PATH/base/" --endpoint-url "$CNPG_MINIO_ENDPOINT_URL" --recursive | sort | tail -n 1 || true)
                  if [ -n "$LATEST_BASE" ]; then
                    echo "Latest base backup object: $LATEST_BASE"
                  else
                    echo "WARNING: Could not locate base backup objects"
                  fi

                  # WAL archive presence
                  WAL_COUNT=$(aws s3 ls "$BUCKET_PATH/wal/" --endpoint-url "$CNPG_MINIO_ENDPOINT_URL" --recursive | wc -l | tr -d ' ')
                  echo "WAL archive files: ${WAL_COUNT}"

                  echo "Backup validation completed successfully at $(date -u)"

              env:
                - name: CNPG_BACKUP_BUCKET
                  value: "${CNPG_BACKUP_BUCKET}"
                - name: CNPG_MINIO_ENDPOINT_URL
                  value: "${CNPG_MINIO_ENDPOINT_URL}"
                - name: AWS_DEFAULT_REGION
                  value: "us-east-1"
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: cnpg-minio-credentials
                      key: access-key
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: cnpg-minio-credentials
                      key: secret-key
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
              securityContext:
                runAsNonRoot: true
                runAsUser: 65534
                readOnlyRootFilesystem: true
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
