---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: shared-postgres
  namespace: cnpg-system
spec:
  description: "Shared multi-tenant PostgreSQL cluster for platform applications"

  # PostgreSQL Configuration
  imageName: ghcr.io/cloudnative-pg/postgresql:16.8
  instances: 3

  # Update Strategy
  primaryUpdateStrategy: unsupervised
  primaryUpdateMethod: switchover

  # High Availability
  minSyncReplicas: 0
  maxSyncReplicas: 2

  # Superuser Access
  enableSuperuserAccess: true
  superuserSecret:
    name: cnpg-superuser

  # Certificate Management
  certificates:
    serverTLSSecret: shared-postgres-server-cert
    serverCASecret: shared-postgres-ca-cert
    clientCASecret: shared-postgres-ca-cert

  # Bootstrap Configuration
  bootstrap:
    initdb:
      database: postgres
      owner: postgres
      secret:
        name: cnpg-superuser
      postInitSQL:
        - CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
        - CREATE EXTENSION IF NOT EXISTS pgaudit;
        - ALTER SYSTEM SET pg_stat_statements.track = 'all';

  # Storage Configuration
  storage:
    storageClass: ${CNPG_STORAGE_CLASS}
    size: ${CNPG_DATA_SIZE}
    resizeInUseVolumes: true
    pvcTemplate:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: ${CNPG_DATA_SIZE}
      volumeMode: Filesystem

  walStorage:
    storageClass: ${CNPG_STORAGE_CLASS}
    size: ${CNPG_WAL_SIZE}
    resizeInUseVolumes: true
    pvcTemplate:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: ${CNPG_WAL_SIZE}
      volumeMode: Filesystem

  # Resource Management
  resources:
    requests:
      cpu: "2000m"
      memory: "8Gi"
    limits:
      cpu: "4000m"
      memory: "16Gi"

  # PostgreSQL Configuration
  postgresql:
    parameters:
      # Memory Configuration
      shared_buffers: "4GB"
      effective_cache_size: "12GB"
      maintenance_work_mem: "1GB"
      work_mem: "64MB"

      # WAL Configuration
      wal_level: replica
      max_wal_senders: "10"
      max_replication_slots: "10"
      wal_keep_size: "1GB"
      wal_compression: "on"
      wal_buffers: "16MB"

      # Checkpoint Configuration
      checkpoint_timeout: "15min"
      checkpoint_completion_target: "0.9"
      max_wal_size: "8GB"
      min_wal_size: "2GB"

      # Query Planner
      random_page_cost: "1.1"
      effective_io_concurrency: "200"

      # Worker Processes
      max_worker_processes: "16"
      max_parallel_workers_per_gather: "4"
      max_parallel_workers: "8"
      max_parallel_maintenance_workers: "4"

      # Connection Configuration
      max_connections: "200"

      # Logging Configuration
      log_min_duration_statement: "1000"
      log_checkpoints: "on"
      log_connections: "on"
      log_disconnections: "on"
      log_lock_waits: "on"
      log_line_prefix: "%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h "

      # Autovacuum Configuration
      autovacuum: "on"
      autovacuum_max_workers: "4"
      autovacuum_naptime: "15s"
      autovacuum_vacuum_threshold: "50"
      autovacuum_vacuum_scale_factor: "0.1"
      autovacuum_analyze_threshold: "50"
      autovacuum_analyze_scale_factor: "0.05"

      # Statistics
      track_activities: "on"
      track_counts: "on"
      track_io_timing: "on"
      track_functions: "all"

      # Extensions
      shared_preload_libraries: "pg_stat_statements,pgaudit"

      # TLS Configuration
      ssl: "on"
      ssl_min_protocol_version: "TLSv1.3"
      ssl_prefer_server_ciphers: "on"

    pg_hba:
      - host all all all scram-sha-256
      - hostssl all all all scram-sha-256

  # Monitoring
  monitoring:
    enablePodMonitor: true
    podMonitorMetricRelabelings:
      - sourceLabels: [cluster]
        targetLabel: cnpg_cluster
        action: replace
    customQueriesConfigMap:
      - name: shared-postgres-monitoring
        key: custom-queries.yaml

  # Pod Scheduling
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: preferred

  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          cnpg.io/cluster: shared-postgres

  # Replication Slots
  replicationSlots:
    highAvailability:
      enabled: true
      slotPrefix: _cnpg_
    updateInterval: 30

  # Backup Configuration
  backup:
    retentionPolicy: "30d"
    barmanObjectStore:
      destinationPath: "s3://${CNPG_BACKUP_BUCKET}/shared-postgres"
      endpointURL: "http://172.16.11.3:9000"
      s3Credentials:
        accessKeyId:
          name: cnpg-minio-credentials
          key: access-key
        secretAccessKey:
          name: cnpg-minio-credentials
          key: secret-key
      wal:
        compression: gzip
        encryption: AES256
        maxParallel: 4
      data:
        compression: gzip
        encryption: AES256
        jobs: 2
        immediateCheckpoint: true
      serverName: shared-postgres
      tags:
        environment: production
        cluster: infra
        application: platform-databases

  # Managed Database Roles
  managed:
    roles:
      # GitLab Application User
      - name: gitlab_app
        ensure: present
        login: true
        superuser: false
        createdb: false
        createrole: false
        inherit: true
        replication: false
        connectionLimit: 50
        passwordSecret:
          name: gitlab-db-credentials

      # Harbor Application User
      - name: harbor_app
        ensure: present
        login: true
        superuser: false
        createdb: false
        createrole: false
        inherit: true
        replication: false
        connectionLimit: 30
        passwordSecret:
          name: harbor-db-credentials

      # Mattermost Application User
      - name: mattermost_app
        ensure: present
        login: true
        superuser: false
        createdb: false
        createrole: false
        inherit: true
        replication: false
        connectionLimit: 40
        passwordSecret:
          name: mattermost-db-credentials

      # Keycloak Application User
      - name: keycloak_app
        ensure: present
        login: true
        superuser: false
        createdb: false
        createrole: false
        inherit: true
        replication: false
        connectionLimit: 20
        passwordSecret:
          name: keycloak-db-credentials

      # Read-Only User for Analytics
      - name: readonly_user
        ensure: present
        login: true
        superuser: false
        createdb: false
        createrole: false
        inherit: true
        replication: false
        connectionLimit: 10
        passwordSecret:
          name: postgres-readonly-credentials

  # Service Template
  serviceAccountTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: shared-postgres
        app.kubernetes.io/component: database
        app.kubernetes.io/part-of: cloudnative-pg

  # Pod Security
  securityContext:
    runAsNonRoot: true
    runAsUser: 26
    runAsGroup: 26
    fsGroup: 26
    fsGroupChangePolicy: "OnRootMismatch"
    seccompProfile:
      type: RuntimeDefault
