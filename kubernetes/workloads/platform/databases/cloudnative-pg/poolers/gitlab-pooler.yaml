---
apiVersion: postgresql.cnpg.io/v1
kind: Pooler
metadata:
  name: gitlab-pooler
  namespace: cnpg-system
spec:
  cluster:
    name: shared-postgres

  # Number of pooler instances
  instances: 3

  # Pool mode - transaction is best for most applications
  type: rw
  pgbouncer:
    poolMode: transaction

    # Connection pool configuration (Optimized for 10 GitLab users)
    parameters:
      # APPROPRIATE: Scaled for 10 users, not over-provisioned
      max_client_conn: "200"            # Sufficient for 10 users with connections
      default_pool_size: "15"           # Reasonable for small user base
      min_pool_size: "3"                # Lower minimum for efficiency
      reserve_pool_size: "5"            # Small reserve for bursts
      reserve_pool_timeout: "3"         # Faster timeout for cross-cluster
      max_db_connections: "15"          # Matches pool size
      max_user_connections: "15"        # Matches pool size

      # Timeouts (Optimized for cross-cluster latency)
      server_idle_timeout: "300"        # Shorter idle timeout
      server_lifetime: "1800"          # Shorter lifetime
      server_connect_timeout: "10"     # Faster connection timeout
      query_timeout: "180"             # Shorter query timeout
      query_wait_timeout: "60"         # Faster wait timeout
      client_idle_timeout: "60"        # Add client idle timeout
      idle_transaction_timeout: "300"  # Shorter transaction timeout

      # Logging
      log_connections: "1"
      log_disconnections: "1"
      log_pooler_errors: "1"
      stats_period: "60"

      # Security
      ignore_startup_parameters: "extra_float_digits,options"

    # Authentication query for application users
    authQuerySecret:
      name: gitlab-pooler-auth
    authQuery: "SELECT usename, passwd FROM user_search($1)"

  # Deployment configuration
  deploymentStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

  # Pod template
  template:
    metadata:
      labels:
        app.kubernetes.io/name: gitlab-pooler
        app.kubernetes.io/component: connection-pooler
    spec:
      # High Availability
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    cnpg.io/poolerName: gitlab-pooler
                topologyKey: kubernetes.io/hostname

      containers:
        - name: pgbouncer
          # Resource management (APPROPRIATE for 10 GitLab users)
          resources:
            requests:
              cpu: "150m"
              memory: "96Mi"
            limits:
              cpu: "300m"
              memory: "192Mi"
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            readOnlyRootFilesystem: true
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL

  # Monitoring
  monitoring:
    enablePodMonitor: true
---
# External Secret for pooler authentication
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: gitlab-pooler-auth
  namespace: cnpg-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: ${EXTERNAL_SECRET_STORE}
  target:
    name: gitlab-pooler-auth
    creationPolicy: Owner
  data:
    - secretKey: username
      remoteRef:
        key: kubernetes/infra/cloudnative-pg/gitlab
        property: username
    - secretKey: password
      remoteRef:
        key: kubernetes/infra/cloudnative-pg/gitlab
        property: password
