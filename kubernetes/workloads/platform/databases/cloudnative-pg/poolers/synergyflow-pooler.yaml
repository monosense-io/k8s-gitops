---
apiVersion: postgresql.cnpg.io/v1
kind: Pooler
metadata:
  name: synergyflow-pooler
  namespace: cnpg-system
  labels:
    app.kubernetes.io/name: synergyflow-pooler
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: synergyflow
spec:
  cluster:
    name: shared-postgres

  # Number of pooler instances for high availability
  instances: 3

  # Read-write connection pool
  type: rw
  pgbouncer:
    # Transaction mode - suitable for Spring Boot + Flowable
    poolMode: transaction

    # Connection pool configuration
    parameters:
      # Client connection limits
      max_client_conn: "1000"
      default_pool_size: "50"
      min_pool_size: "10"
      reserve_pool_size: "10"
      reserve_pool_timeout: "5"

      # Database connection limits (matches managed role limit)
      max_db_connections: "50"
      max_user_connections: "50"

      # Timeouts (in seconds)
      server_idle_timeout: "600"      # 10 minutes
      server_lifetime: "3600"         # 1 hour
      server_connect_timeout: "15"
      query_timeout: "300"            # 5 minutes
      query_wait_timeout: "120"       # 2 minutes
      client_idle_timeout: "0"        # Infinite
      idle_transaction_timeout: "600" # 10 minutes

      # Logging for observability
      log_connections: "1"
      log_disconnections: "1"
      log_pooler_errors: "1"
      stats_period: "60"

      # Security
      ignore_startup_parameters: "extra_float_digits,options"

    # Authentication query for synergyflow_app role
    authQuerySecret:
      name: synergyflow-pooler-auth
    authQuery: "SELECT usename, passwd FROM user_search($1)"

  # Deployment strategy
  deploymentStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

  # Resource allocation
  resources:
    requests:
      cpu: "500m"
      memory: "256Mi"
    limits:
      cpu: "2000m"
      memory: "512Mi"

  # High Availability - spread across nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                cnpg.io/poolerName: synergyflow-pooler
            topologyKey: kubernetes.io/hostname

  # Pod template for security hardening
  template:
    metadata:
      labels:
        app.kubernetes.io/name: synergyflow-pooler
        app.kubernetes.io/component: connection-pooler
        app.kubernetes.io/part-of: synergyflow
    spec:
      containers:
        - name: pgbouncer
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            readOnlyRootFilesystem: true
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL

  # Monitoring integration
  monitoring:
    enablePodMonitor: true
---
# External Secret for pooler authentication
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: synergyflow-pooler-auth
  namespace: cnpg-system
  labels:
    app.kubernetes.io/name: synergyflow-pooler
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: synergyflow
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: ${EXTERNAL_SECRET_STORE}
  target:
    name: synergyflow-pooler-auth
    creationPolicy: Owner
  data:
    - secretKey: username
      remoteRef:
        key: postgresql/synergyflow
        property: username
    - secretKey: password
      remoteRef:
        key: postgresql/synergyflow
        property: password
