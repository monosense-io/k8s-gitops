---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: actions-runner-controller
  namespace: actions-runner-system
  labels:
    app.kubernetes.io/name: gha-runner-scale-set-controller
    app.kubernetes.io/component: controller
    app.kubernetes.io/part-of: actions-runner-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: actions-runner-controller
  labels:
    app.kubernetes.io/name: gha-runner-scale-set-controller
    app.kubernetes.io/component: controller
    app.kubernetes.io/part-of: actions-runner-system
rules:
  # ARC CRDs management (AutoscalingRunnerSet, EphemeralRunner, etc.)
  - apiGroups: ["actions.github.com"]
    resources: ["*"]
    verbs: ["*"]

  # Pod lifecycle management for runner pods
  - apiGroups: [""]
    resources: ["pods", "pods/log", "pods/status"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Secret management for runner registration tokens
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Service management for webhook server
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # ConfigMap for controller configuration
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Events for troubleshooting and audit trail
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # PersistentVolumeClaims for ephemeral storage
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Leases for leader election (HA controller)
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: actions-runner-controller
  labels:
    app.kubernetes.io/name: gha-runner-scale-set-controller
    app.kubernetes.io/component: controller
    app.kubernetes.io/part-of: actions-runner-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: actions-runner-controller
subjects:
  - kind: ServiceAccount
    name: actions-runner-controller
    namespace: actions-runner-system
