---
# JMX Prometheus Exporter configuration for Kafka brokers
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-metrics
  namespace: messaging
  labels:
    app.kubernetes.io/name: kafka
    app.kubernetes.io/component: metrics
data:
  kafka-metrics-config.yml: |
    # Kafka broker metrics
    lowercaseOutputName: true
    lowercaseOutputLabelNames: true

    rules:
      # Broker metrics
      - pattern: kafka.server<type=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)><>Value
        name: kafka_server_$1_$2
        type: GAUGE
        labels:
          clientId: "$3"
          topic: "$4"
          partition: "$5"

      - pattern: kafka.server<type=(.+), name=(.+), clientId=(.+), brokerHost=(.+), brokerPort=(.+)><>Value
        name: kafka_server_$1_$2
        type: GAUGE
        labels:
          clientId: "$3"
          broker: "$4:$5"

      - pattern: kafka.server<type=(.+), name=(.+)><>Value
        name: kafka_server_$1_$2
        type: GAUGE

      # Replica manager metrics (critical for replication health)
      - pattern: kafka.server<type=ReplicaManager, name=(.+)><>Value
        name: kafka_server_replicamanager_$1
        type: GAUGE

      # Controller metrics (KRaft mode)
      - pattern: kafka.controller<type=KafkaController, name=(.+)><>Value
        name: kafka_controller_kafkacontroller_$1
        type: GAUGE

      # Network metrics
      - pattern: kafka.network<type=RequestMetrics, name=RequestsPerSec, request=(.+)><>Count
        name: kafka_network_requestmetrics_requests_total
        type: COUNTER
        labels:
          request: "$1"

      - pattern: kafka.network<type=RequestMetrics, name=TotalTimeMs, request=(.+)><>(\d+)thPercentile
        name: kafka_network_requestmetrics_totaltimems
        type: GAUGE
        labels:
          request: "$1"
          quantile: "0.$2"

      # Log metrics
      - pattern: kafka.log<type=Log, name=(.+), topic=(.+), partition=(.+)><>Value
        name: kafka_log_log_$1
        type: GAUGE
        labels:
          topic: "$2"
          partition: "$3"

      - pattern: kafka.log<type=LogFlushStats, name=(.+)><>(\d+)thPercentile
        name: kafka_log_logflushstats_$1
        type: GAUGE
        labels:
          quantile: "0.$2"

      # Partition metrics
      - pattern: kafka.cluster<type=Partition, name=(.+), topic=(.+), partition=(.+)><>Value
        name: kafka_cluster_partition_$1
        type: GAUGE
        labels:
          topic: "$2"
          partition: "$3"

      # JVM metrics
      - pattern: java.lang<type=Memory><HeapMemoryUsage>(\w+)
        name: jvm_memory_heap_$1
        type: GAUGE

      - pattern: java.lang<type=Memory><NonHeapMemoryUsage>(\w+)
        name: jvm_memory_nonheap_$1
        type: GAUGE

      - pattern: java.lang<type=GarbageCollector, name=(.+)><>CollectionCount
        name: jvm_gc_collection_count_total
        type: COUNTER
        labels:
          gc: "$1"

      - pattern: java.lang<type=GarbageCollector, name=(.+)><>CollectionTime
        name: jvm_gc_collection_time_ms_total
        type: COUNTER
        labels:
          gc: "$1"

      # Operating system metrics
      - pattern: java.lang<type=OperatingSystem><>(.+)
        name: jvm_os_$1
        type: GAUGE

      # Thread metrics
      - pattern: java.lang<type=Threading><>(.+)
        name: jvm_threads_$1
        type: GAUGE
