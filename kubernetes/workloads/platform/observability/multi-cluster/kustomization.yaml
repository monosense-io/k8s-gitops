---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
metadata:
  name: multi-cluster-monitoring-workloads
  namespace: observability
resources:
  - ../../../../bases/victoria-metrics-global
  - ../../../../components/monitoring/multi-cluster
  - secrets.yaml
  - backup-cronjob.yaml
components:
  - ../../../../components/monitoring/business-metrics
patchesStrategicMerge:
  - |-
    apiVersion: helm.toolkit.fluxcd.io/v2
    kind: HelmRelease
    metadata:
      name: victoria-metrics-global
      namespace: observability
    spec:
      values:
        # Override values based on cluster settings
        global:
          cluster: ${CLUSTER}
          cluster_id: ${CLUSTER_ID}
        # Storage configuration
        vmcluster:
          spec:
            vmselect:
              storage:
                volumeClaimTemplate:
                  spec:
                    storageClassName: ${OBSERVABILITY_BLOCK_SC}
            vminsert:
              resources:
                requests:
                  cpu: 500m
                  memory: 1Gi
                limits:
                  cpu: 1000m
                  memory: 2Gi
            vmstorage:
              storage:
                volumeClaimTemplate:
                  spec:
                    storageClassName: ${OBSERVABILITY_BLOCK_SC}
                    resources:
                      requests:
                        storage: 2Ti
        # VMagent configuration
        vmagent:
          spec:
            externalLabels:
              cluster: ${CLUSTER}
              cluster_id: ${CLUSTER_ID}
            storage:
              volumeClaimTemplate:
                spec:
                  storageClassName: ${OBSERVABILITY_BLOCK_SC}
        # VMAuth configuration
        vmauth:
          spec:
            config: |
              users:
                - username: "infra"
                  password_hash: "${INFRA_VMUSER_HASH}"
                  url_prefix: "http://vminsert:8480/insert/0/prometheus"
                - username: "apps"
                  password_hash: "${APPS_VMUSER_HASH}"
                  url_prefix: "http://vminsert:8480/insert/1/prometheus"
                - username: "global-read"
                  password_hash: "${GLOBAL_READ_VMUSER_HASH}"
                  url_prefix: "http://vmselect:8481/select/0/prometheus"
                - username: "business"
                  password_hash: "${BUSINESS_VMUSER_HASH}"
                  url_prefix: "http://vminsert:8480/insert/2/prometheus"
  - |-
    # Patch for VMagent remote write configuration
    apiVersion: operator.victoriametrics.com/v1beta1
    kind: VMAgent
    metadata:
      name: vmagent-multi-cluster
      namespace: observability
    spec:
      remoteWrite:
        - url: "http://victoria-metrics-global-vminsert.observability.svc.cluster.local:8480/insert/0/prometheus/api/v1/write"
          queue_config:
            max_samples_per_send: 10000
            max_shards: 200
            capacity: 25000
          write_relabel_configs:
            - source_labels: [__name__]
              regex: '(cluster_.*|node_.*|kube_node_.*|up|process_.*|go_.*|promhttp_.*|kube_pod_info|kube_deployment_.*|kube_service_.*|cilium_.*|hubble_.*|container_.*|machine_.*|kubelet_.*|kube_proxy_.*|cadvisor_.*|rest_client_.*|apiserver_.*|etcd_.*|coredns_.*|alertmanager_.*|prometheus_.*|vm_.*|victoriametrics_.*)'
              action: keep
            - target_label: source_cluster
              replacement: ${CLUSTER}
      externalLabels:
        cluster: ${CLUSTER}
        cluster_id: ${CLUSTER_ID}
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: ${OBSERVABILITY_BLOCK_SC}
            resources:
              requests:
                storage: 50Gi
postBuild:
  substituteFrom:
    - kind: ConfigMap
      name: cluster-settings
      optional: false
    - kind: Secret
      name: victoria-metrics-secrets
      optional: true