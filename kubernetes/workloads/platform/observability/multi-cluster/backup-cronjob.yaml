---
# Daily backup job for global VM cluster
apiVersion: batch/v1
kind: CronJob
metadata:
  name: vmcluster-backup
  namespace: observability
  labels:
    app.kubernetes.io/name: vmcluster-backup
    app.kubernetes.io/component: backup
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: vmcluster-backup
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: victoriametrics/vmbackupmanager:latest
            args:
              - --storageDataPath=/storage/data
              - --dst=s3://monosense-vmcluster-backup/
              - --snapshot.createURL=http://victoria-metrics-global-vmselect.observability.svc.cluster.local:8481
              - --snapshot.deleteURL=http://victoria-metrics-global-vmselect.observability.svc.cluster.local:8481
              - --dailyRetention=30d
              - --weeklyRetention=12w
              - --monthlyRetention=12m
              - --concurrency=3
            env:
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: vmcluster-backup-credentials
                    key: access-key-id
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: vmcluster-backup-credentials
                    key: secret-access-key
              - name: AWS_REGION
                value: "us-east-1"
            resources:
              requests:
                cpu: 1000m
                memory: 2Gi
              limits:
                cpu: 2000m
                memory: 4Gi
            volumeMounts:
              - name: storage
                mountPath: /storage
                readOnly: true
          volumes:
            - name: storage
              persistentVolumeClaim:
                claimName: victoria-metrics-global-vmstorage-db-victoria-metrics-global-vmstorage-0
          nodeSelector:
            kubernetes.io/os: linux
          tolerations:
            - key: node-role.kubernetes.io/master
              operator: Exists
              effect: NoSchedule
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
---
# Backup monitoring service
apiVersion: v1
kind: Service
metadata:
  name: vmcluster-backup-metrics
  namespace: observability
  labels:
    app.kubernetes.io/name: vmcluster-backup
    app.kubernetes.io/component: backup
spec:
  selector:
    app.kubernetes.io/name: vmcluster-backup
    app.kubernetes.io/component: backup
  ports:
  - name: metrics
    port: 8080
    targetPort: 8080
    protocol: TCP
---
# ServiceMonitor for backup metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vmcluster-backup
  namespace: observability
  labels:
    prometheus: kube-prometheus
    app.kubernetes.io/name: vmcluster-backup
    app.kubernetes.io/component: backup
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: vmcluster-backup
      app.kubernetes.io/component: backup
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics