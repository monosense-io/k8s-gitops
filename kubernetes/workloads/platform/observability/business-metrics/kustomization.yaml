---
# Business Metrics Integration
# Adds business metrics monitoring to the observability stack
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
metadata:
  name: business-metrics
  namespace: observability
resources:
  - ../../../../components/monitoring/business-metrics
configMapGenerator:
  - name: vmalert-business-rules
    files:
      - business-metrics-rules.yaml=../../../../components/monitoring/business-metrics/business-metrics-configmap.yaml
patches:
  # Patch Victoria Metrics to include business metrics recording rules
  - target:
      kind: HelmRelease
      name: victoria-metrics
    patch: |-
      - op: add
        path: /spec/values/vmalert/spec/additionalScrapeConfigs
        value:
          - name: business-metrics-rules
            configMap:
              name: vmalert-business-rules
              key: business-metrics-rules.yaml
      - op: add
        path: /spec/values/vmalert/spec/extraArgs
        value:
          rule.file: "/etc/vmalert/rules/*.yaml"