---
# Harbor Database Credentials (CNPG Pooler)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: harbor-db-credentials
  namespace: harbor
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: harbor-db-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # Harbor database connection URL format
        HARBOR_DATABASE_TYPE: "postgresql"
        HARBOR_DATABASE_HOSTNAME: "{{ .host }}"
        HARBOR_DATABASE_PORT: "{{ .port }}"
        HARBOR_DATABASE_DATABASE: "{{ .database }}"
        HARBOR_DATABASE_USERNAME: "{{ .username }}"
        HARBOR_DATABASE_PASSWORD: "{{ .password }}"
        HARBOR_DATABASE_SSLMODE: "{{ .sslmode }}"
        # PostgreSQL connection string format
        DATABASE_URL: "postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?sslmode={{ .sslmode }}"
  dataFrom:
    - extract:
        key: ${HARBOR_DB_SECRET_PATH}

---
# Harbor Redis Credentials (DragonflyDB)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: harbor-redis-credentials
  namespace: harbor
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: harbor-redis-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        HARBOR_REDIS_ADDR: "{{ .addr }}"
        HARBOR_REDIS_PASSWORD: "{{ .password }}"
        # Redis URL format for Harbor
        REDIS_URL: "redis://:{{ .password }}@{{ .addr }}/0"
  dataFrom:
    - extract:
        key: ${HARBOR_REDIS_SECRET_PATH}

---
# Harbor S3 Storage Credentials (MinIO)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: harbor-s3-credentials
  namespace: harbor
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: harbor-s3-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        HARBOR_STORAGE_S3_REGIONENDPOINT: "{{ .regionendpoint }}"
        HARBOR_STORAGE_S3_BUCKET: "{{ .bucket }}"
        HARBOR_STORAGE_S3_ACCESSKEY: "{{ .accesskey }}"
        HARBOR_STORAGE_S3_SECRETKEY: "{{ .secretkey }}"
        HARBOR_STORAGE_S3_REGION: "{{ .region }}"
  dataFrom:
    - extract:
        key: ${HARBOR_S3_SECRET_PATH}

---
# Harbor Admin Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: harbor-admin-credentials
  namespace: harbor
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: harbor-admin-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        HARBOR_ADMIN_PASSWORD: "{{ .password }}"
  dataFrom:
    - extract:
        key: ${HARBOR_ADMIN_SECRET_PATH}

---
# Harbor Core Secret (secret key, xsrf key, registry credentials)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: harbor-core-secret
  namespace: harbor
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: harbor-core-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        HARBOR_SECRET_KEY: "{{ .secret_key }}"
        HARBOR_XSRF_KEY: "{{ .xsrf_key }}"
        HARBOR_REGISTRY_PASSWORD: "{{ .registry_password }}"
  dataFrom:
    - extract:
        key: ${HARBOR_CORE_SECRET_PATH}
