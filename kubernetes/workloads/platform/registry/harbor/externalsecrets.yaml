---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-core
  namespace: harbor
  labels:
    app.kubernetes.io/name: harbor
    app.kubernetes.io/component: registry
    app.kubernetes.io/part-of: harbor
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: harbor-core
    creationPolicy: Owner

  data:
    - secretKey: HARBOR_ADMIN_PASSWORD
      remoteRef:
        key: harbor/core
        property: admin_password

    - secretKey: secret
      remoteRef:
        key: harbor/core
        property: secret_key

  refreshInterval: 1h

---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-database
  namespace: harbor
  labels:
    app.kubernetes.io/name: harbor
    app.kubernetes.io/component: registry
    app.kubernetes.io/part-of: harbor
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: harbor-database
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        password: "{{ .password }}"

  data:
    - secretKey: password
      remoteRef:
        key: postgresql/harbor
        property: password

  refreshInterval: 1h

---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-registry
  namespace: harbor
  labels:
    app.kubernetes.io/name: harbor
    app.kubernetes.io/component: registry
    app.kubernetes.io/part-of: harbor
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: harbor-registry
    creationPolicy: Owner

  data:
    - secretKey: REGISTRY_HTTP_SECRET
      remoteRef:
        key: harbor/registry
        property: http_secret

  refreshInterval: 1h

---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: postgres-backup-credentials
  namespace: harbor
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: harbor
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  target:
    name: postgres-backup-credentials
    creationPolicy: Owner

  data:
    - secretKey: ACCESS_KEY_ID
      remoteRef:
        key: s3/backup
        property: access_key_id

    - secretKey: SECRET_ACCESS_KEY
      remoteRef:
        key: s3/backup
        property: secret_access_key

  refreshInterval: 1h
