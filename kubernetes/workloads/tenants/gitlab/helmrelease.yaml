---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab
  namespace: gitlab-system
spec:
  interval: 30m
  chart:
    spec:
      chart: gitlab
      version: 7.10.4
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 1
      strategy: rollback
    cleanupOnFail: true
  values:
    global:
      edition: ee
      hosts:
        domain: apps.monosense.io
      psql:
        host: gitlab-pooler-rw.cnpg-system.svc.cluster.local
        port: 5432
        username: gitlab_app
        database: gitlab
        password:
          secret: gitlab-db-credentials
          key: password
        ssl:
          enabled: false
      redis:
        host: dragonfly.dragonfly-system.svc.cluster.local
        port: 6379
        password:
          enabled: true
          secret: gitlab-redis-credentials
          key: password
      minio:
        enabled: false
      appConfig:
        object_store:
          enabled: true
          connection:
            provider: AWS
            aws_access_key_id: <%= File.read("/etc/gitlab/objectstorage/AWS_ACCESS_KEY_ID") %>
            aws_secret_access_key: <%= File.read("/etc/gitlab/objectstorage/AWS_SECRET_ACCESS_KEY") %>
            endpoint: http://10.25.11.3:9000
            region: us-east-1
            path_style: true
          credentials:
            secret: gitlab-s3-credentials
          objects:
            artifacts:
              bucket: gitlab-artifacts
            lfs:
              bucket: gitlab-lfs
            uploads:
              bucket: gitlab-uploads
            packages:
              bucket: gitlab-packages
            external_diffs:
              bucket: gitlab-external-diffs
            terraform_state:
              bucket: gitlab-terraform
            dependency_proxy:
              bucket: gitlab-dependency-proxy
      kas:
        enabled: false
      shell:
        port: 2222
      gitaly:
        persistence:
          storageClass: rook-ceph-block
          size: 200Gi
      registry:
        bucket: gitlab-registry
      initialRootPassword:
        secret: gitlab-root-password
        key: password
    certmanager-issuer:
      email: infra@monosense.io
    nginx-ingress:
      enabled: false
    prometheus:
      install: false
    gitlab:
      gitlab-shell:
        service:
          type: ClusterIP
      webservice:
        minReplicas: 2
        maxReplicas: 4
        persistence:
          enabled: true
          storageClass: rook-ceph-block
          size: 20Gi
      sidekiq:
        persistence:
          enabled: true
          storageClass: rook-ceph-block
          size: 10Gi
    postgresql:
      install: false
    redis:
      install: false
    minio:
      install: false
    registry:
      storage:
        secret: gitlab-s3-credentials
    gitlab-runner:
      install: false
