---
# GitLab Database Credentials (CNPG Pooler)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gitlab-db-credentials
  namespace: gitlab-system
  labels:
    app.kubernetes.io/name: gitlab
    app.kubernetes.io/component: database
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: ${EXTERNAL_SECRET_STORE}

  target:
    name: gitlab-db-credentials
    creationPolicy: Owner

  refreshInterval: 1h

  data:
    - secretKey: host
      remoteRef:
        key: ${GITLAB_DB_SECRET_PATH}
        property: host

    - secretKey: port
      remoteRef:
        key: ${GITLAB_DB_SECRET_PATH}
        property: port

    - secretKey: database
      remoteRef:
        key: ${GITLAB_DB_SECRET_PATH}
        property: database

    - secretKey: username
      remoteRef:
        key: ${GITLAB_DB_SECRET_PATH}
        property: username

    - secretKey: password
      remoteRef:
        key: ${GITLAB_DB_SECRET_PATH}
        property: password

---
# GitLab Redis Credentials (DragonflyDB)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gitlab-redis-credentials
  namespace: gitlab-system
  labels:
    app.kubernetes.io/name: gitlab
    app.kubernetes.io/component: cache
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: ${EXTERNAL_SECRET_STORE}

  target:
    name: gitlab-redis-credentials
    creationPolicy: Owner

  refreshInterval: 1h

  data:
    - secretKey: host
      remoteRef:
        key: ${GITLAB_REDIS_SECRET_PATH}
        property: host

    - secretKey: port
      remoteRef:
        key: ${GITLAB_REDIS_SECRET_PATH}
        property: port

    - secretKey: password
      remoteRef:
        key: ${GITLAB_REDIS_SECRET_PATH}
        property: password

---
# GitLab S3 Credentials (MinIO)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gitlab-s3-credentials
  namespace: gitlab-system
  labels:
    app.kubernetes.io/name: gitlab
    app.kubernetes.io/component: object-storage
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: ${EXTERNAL_SECRET_STORE}

  target:
    name: gitlab-s3-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # GitLab expects connection details in YAML format
        connection: |
          provider: AWS
          region: ${GITLAB_S3_REGION}
          aws_access_key_id: {{ .ACCESS_KEY_ID }}
          aws_secret_access_key: {{ .SECRET_ACCESS_KEY }}
          host: {{ .endpoint | replace "http://" "" | replace "https://" "" }}
          endpoint: {{ .endpoint }}
          path_style: true

  refreshInterval: 1h

  data:
    - secretKey: endpoint
      remoteRef:
        key: ${GITLAB_S3_SECRET_PATH}
        property: endpoint

    - secretKey: ACCESS_KEY_ID
      remoteRef:
        key: ${GITLAB_S3_SECRET_PATH}
        property: ACCESS_KEY_ID

    - secretKey: SECRET_ACCESS_KEY
      remoteRef:
        key: ${GITLAB_S3_SECRET_PATH}
        property: SECRET_ACCESS_KEY

---
# GitLab Root Password
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gitlab-root-password
  namespace: gitlab-system
  labels:
    app.kubernetes.io/name: gitlab
    app.kubernetes.io/component: authentication
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: ${EXTERNAL_SECRET_STORE}

  target:
    name: gitlab-root-password
    creationPolicy: Owner

  refreshInterval: 1h

  data:
    - secretKey: password
      remoteRef:
        key: ${GITLAB_ROOT_SECRET_PATH}
        property: password

---
# GitLab OIDC Credentials (Keycloak)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gitlab-oidc-credentials
  namespace: gitlab-system
  labels:
    app.kubernetes.io/name: gitlab
    app.kubernetes.io/component: authentication
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: ${EXTERNAL_SECRET_STORE}

  target:
    name: gitlab-oidc-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        oidc-provider: |
          name: 'openid_connect'
          label: 'Keycloak SSO'
          args:
            name: 'openid_connect'
            scope: ['openid', 'profile', 'email']
            response_type: 'code'
            issuer: 'https://${KEYCLOAK_HOST}/realms/${KEYCLOAK_REALM}'
            discovery: true
            uid_field: 'preferred_username'
            client_auth_method: 'query'
            send_scope_to_token_endpoint: false
            pkce: true
            client_options:
              identifier: '{{ .client_id }}'
              secret: '{{ .client_secret }}'
              redirect_uri: 'https://${GITLAB_HOST}/users/auth/openid_connect/callback'

  refreshInterval: 1h

  data:
    - secretKey: client_id
      remoteRef:
        key: ${GITLAB_OIDC_SECRET_PATH}
        property: client_id

    - secretKey: client_secret
      remoteRef:
        key: ${GITLAB_OIDC_SECRET_PATH}
        property: client_secret
