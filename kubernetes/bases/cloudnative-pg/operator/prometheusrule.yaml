---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cloudnative-pg-operator
  namespace: cnpg-system
  labels:
    app.kubernetes.io/name: cloudnative-pg
    app.kubernetes.io/component: operator
    prometheus: victoria-metrics
spec:
  groups:
    - name: cloudnative-pg-operator
      interval: 30s
      rules:
        # Operator Health
        - alert: CNPGOperatorDown
          expr: |
            absent(up{job="cnpg-system/cloudnative-pg-metrics"} == 1)
          for: 5m
          labels:
            severity: critical
            component: cloudnative-pg-operator
          annotations:
            summary: "CloudNative-PG operator is down"
            description: "The CloudNative-PG operator has been down for more than 5 minutes. Database cluster management is unavailable."

        - alert: CNPGOperatorHighErrorRate
          expr: |
            rate(cnpg_collector_errors_total[5m]) > 0.1
          for: 10m
          labels:
            severity: warning
            component: cloudnative-pg-operator
          annotations:
            summary: "CNPG operator experiencing high error rate"
            description: "The CloudNative-PG operator is experiencing {{ $value | humanize }} errors per second for namespace {{ $labels.namespace }}."

        - alert: CNPGOperatorReconcileErrors
          expr: |
            rate(cnpg_collector_reconcile_errors_total[5m]) > 0.05
          for: 10m
          labels:
            severity: warning
            component: cloudnative-pg-operator
          annotations:
            summary: "CNPG operator reconciliation errors"
            description: "The CloudNative-PG operator is experiencing reconciliation errors at {{ $value | humanize }} per second."

        - alert: CNPGOperatorHighMemory
          expr: |
            container_memory_working_set_bytes{namespace="cnpg-system",container="manager"} / container_spec_memory_limit_bytes{namespace="cnpg-system",container="manager"} > 0.9
          for: 15m
          labels:
            severity: warning
            component: cloudnative-pg-operator
          annotations:
            summary: "CNPG operator high memory usage"
            description: "The CloudNative-PG operator is using {{ $value | humanizePercentage }} of its memory limit."

        - alert: CNPGOperatorReplicasNotReady
          expr: |
            kube_deployment_status_replicas_available{namespace="cnpg-system",deployment="cloudnative-pg"} < kube_deployment_spec_replicas{namespace="cnpg-system",deployment="cloudnative-pg"}
          for: 10m
          labels:
            severity: warning
            component: cloudnative-pg-operator
          annotations:
            summary: "CNPG operator replicas not ready"
            description: "Only {{ $value }} of the expected CNPG operator replicas are ready."
