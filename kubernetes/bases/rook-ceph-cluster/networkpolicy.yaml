---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rook-ceph-default-deny
  namespace: ${ROOK_CEPH_NAMESPACE}
  labels:
    app: rook-ceph
    app.kubernetes.io/managed-by: flux
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ${ROOK_CEPH_NAMESPACE}
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: ${ROOK_CEPH_NAMESPACE}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rook-ceph-allow-mon-communication
  namespace: ${ROOK_CEPH_NAMESPACE}
  labels:
    app: rook-ceph
    app.kubernetes.io/managed-by: flux
spec:
  podSelector:
    matchLabels:
      app: rook-ceph-mon
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from other MON pods
    - from:
        - podSelector:
            matchLabels:
              app: rook-ceph-mon
      ports:
        - protocol: TCP
          port: 6789
        - protocol: TCP
          port: 3300
    # Allow from OSD pods
    - from:
        - podSelector:
            matchLabels:
              app: rook-ceph-osd
      ports:
        - protocol: TCP
          port: 6789
        - protocol: TCP
          port: 3300
    # Allow from MGR pods
    - from:
        - podSelector:
            matchLabels:
              app: rook-ceph-mgr
      ports:
        - protocol: TCP
          port: 6789
        - protocol: TCP
          port: 3300
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: ${ROOK_CEPH_NAMESPACE}
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rook-ceph-allow-osd-communication
  namespace: ${ROOK_CEPH_NAMESPACE}
  labels:
    app: rook-ceph
    app.kubernetes.io/managed-by: flux
spec:
  podSelector:
    matchLabels:
      app: rook-ceph-osd
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from other OSD pods
    - from:
        - podSelector:
            matchLabels:
              app: rook-ceph-osd
      ports:
        - protocol: TCP
          port: 6800
          endPort: 7100
    # Allow from MON pods
    - from:
        - podSelector:
            matchLabels:
              app: rook-ceph-mon
      ports:
        - protocol: TCP
          port: 6800
          endPort: 7100
    # Allow from MGR pods
    - from:
        - podSelector:
            matchLabels:
              app: rook-ceph-mgr
      ports:
        - protocol: TCP
          port: 6800
          endPort: 7100
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: ${ROOK_CEPH_NAMESPACE}
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rook-ceph-allow-prometheus-scrape
  namespace: ${ROOK_CEPH_NAMESPACE}
  labels:
    app: rook-ceph
    app.kubernetes.io/managed-by: flux
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        values:
          - rook-ceph-mon
          - rook-ceph-mgr
  policyTypes:
    - Ingress
  ingress:
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: observability
      ports:
        - protocol: TCP
          port: 9283
        - protocol: TCP
          port: 9284
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rook-ceph-allow-external-api
  namespace: ${ROOK_CEPH_NAMESPACE}
  labels:
    app: rook-ceph
    app.kubernetes.io/managed-by: flux
spec:
  podSelector:
    matchLabels:
      app: rook-ceph-mgr
  policyTypes:
    - Ingress
  ingress:
    # Allow dashboard and API access from other namespaces
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 8443
