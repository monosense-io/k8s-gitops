apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
  namespace: fluent-bit
  labels:
    app.kubernetes.io/name: fluent-bit
    app.kubernetes.io/component: operator
    app.kubernetes.io/part-of: logging
    app.kubernetes.io/managed-by: flux
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: fluent-bit
    namespace: fluent-bit
  driftDetection:
    mode: enabled
  install:
    crds: Create
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  values:
    image:
      repository: fluent/fluent-bit
      tag: "4.1.1"

    # ServiceAccount configuration
    serviceAccount:
      create: true
      annotations:
        kubectl.kubernetes.io/default-container: fluent-bit

    # RBAC configuration
    rbac:
      create: true
      nodeAccess: true

    # DaemonSet configuration
    daemonSet:
      updateStrategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 1

    # Pod configuration
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "2020"
      prometheus.io/path: "/api/v1/metrics/prometheus"

    podSecurityContext:
      runAsUser: 0
      fsGroup: 0

    containerSecurityContext:
      privileged: true
      readOnlyRootFilesystem: false
      capabilities:
        drop: []

    # Resources
    resources:
      limits:
        cpu: 200m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

    # Volumes for Talos Linux
    extraVolumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibcontainers
        hostPath:
          path: /var/lib/containerd/io.containerd.runtime.v2.task/k8s.io
      - name: fluent-bit-state
        hostPath:
          path: /var/fluent-bit/state
          type: DirectoryOrCreate

    extraVolumeMounts:
      - name: varlog
        mountPath: /var/log
        readOnly: true
      - name: varlibcontainers
        mountPath: /var/lib/containerd/io.containerd.runtime.v2.task/k8s.io
        readOnly: true
      - name: fluent-bit-state
        mountPath: /var/fluent-bit/state

    # Network configuration
    hostNetwork: true

    # Tolerations for all nodes
    tolerations:
      - operator: Exists

    # Node selector for all nodes
    nodeSelector: {}

    # Affinity rules
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/os
                  operator: In
                  values:
                    - linux

    # Monitoring
    serviceMonitor:
      enabled: true
      namespace: fluent-bit
      annotations:
        prometheus.io/scrape: "true"
      labels:
        app.kubernetes.io/name: fluent-bit
        app.kubernetes.io/component: monitoring
        app.kubernetes.io/part-of: logging

    # Anti-Affinity for pod distribution
    antiAffinity: soft

    # Priority class for critical system component
    priorityClassName: system-node-critical

    # Termination grace period
    terminationGracePeriodSeconds: 30