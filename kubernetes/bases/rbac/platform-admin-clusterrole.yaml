---
# Platform Administrator ClusterRole
# Purpose: Cluster-wide read + namespace-scoped write to infrastructure namespaces
# Persona: Platform engineering team
# Validation: Security BLOCKER #1 - RBAC Model
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: platform-admin
  labels:
    app.kubernetes.io/managed-by: flux
    rbac.monosense.io/persona: platform-admin
    rbac.monosense.io/privilege-level: high
rules:
  # Cluster-wide read access for troubleshooting
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["get", "list", "watch"]

  # Cluster-scoped resources management
  - apiGroups: [""]
    resources:
      - nodes
      - persistentvolumes
      - namespaces
    verbs: ["get", "list", "watch", "patch"]

  # Storage management
  - apiGroups: ["storage.k8s.io"]
    resources:
      - storageclasses
      - volumeattachments
      - csidrivers
      - csinodes
    verbs: ["*"]

  # RBAC management (create/patch only, no delete)
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - clusterroles
      - clusterrolebindings
      - roles
      - rolebindings
    verbs: ["get", "list", "watch", "create", "patch"]

  # Cilium networking
  - apiGroups: ["cilium.io"]
    resources: ["*"]
    verbs: ["*"]

  # Network policies
  - apiGroups: ["networking.k8s.io"]
    resources:
      - networkpolicies
      - ingresses
    verbs: ["*"]

  # Custom Resource Definitions
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions"]
    verbs: ["get", "list", "watch"]

  # Certificate management
  - apiGroups: ["cert-manager.io"]
    resources: ["*"]
    verbs: ["*"]

  # External Secrets
  - apiGroups: ["external-secrets.io"]
    resources:
      - clustersecretstores
      - secretstores
    verbs: ["*"]

  # Monitoring CRDs
  - apiGroups:
      - "operator.victoriametrics.com"
      - "monitoring.coreos.com"
    resources: ["*"]
    verbs: ["*"]

  # Flux GitOps
  - apiGroups:
      - "source.toolkit.fluxcd.io"
      - "kustomize.toolkit.fluxcd.io"
      - "helm.toolkit.fluxcd.io"
      - "notification.toolkit.fluxcd.io"
      - "image.toolkit.fluxcd.io"
    resources: ["*"]
    verbs: ["*"]

  # Rook Ceph
  - apiGroups: ["ceph.rook.io"]
    resources: ["*"]
    verbs: ["*"]

  # CloudNativePG
  - apiGroups: ["postgresql.cnpg.io"]
    resources: ["*"]
    verbs: ["*"]

  # VolSync backups
  - apiGroups: ["volsync.backube"]
    resources: ["*"]
    verbs: ["*"]

  # Gateway API
  - apiGroups: ["gateway.networking.k8s.io"]
    resources: ["*"]
    verbs: ["*"]

  # NOTE: Namespace-scoped write access granted via RoleBindings
  # NOTE: Cannot delete namespaces (no 'delete' verb on namespaces resource)
