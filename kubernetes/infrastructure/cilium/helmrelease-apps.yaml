## DEPRECATED: This folder contains historical bootstrap-era HelmRelease examples.
## Do not modify or apply these manifests. The authoritative GitOps-managed
## Cilium HelmRelease lives at:
##   kubernetes/infrastructure/networking/cilium/core/helmrelease.yaml
## Keep this file only for reference. Remove once all docs point to the new path.
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
  namespace: kube-system
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: cilium
      version: "1.18.2"
      sourceRef:
        kind: OCIRepository
        name: cilium-charts
        namespace: flux-system
      interval: 12h

  install:
    crds: CreateReplace
    remediation:
      retries: 3

  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3

  values:
    # Cluster identification - DIFFERENT FROM INFRA
    cluster:
      name: apps
      id: 2

    # ==============================================================================
    # SERVICE MESH CONFIGURATION
    # ==============================================================================

    # CRITICAL: Enable full kube-proxy replacement for service mesh capabilities
    kubeProxyReplacement: "true"

    # CNI Configuration
    cni:
      exclusive: true  # Cilium is the only CNI
      install: true

    # ==============================================================================
    # NETWORKING
    # ==============================================================================

    # IP Address Management
    ipam:
      mode: kubernetes

    # Pod CIDR for apps cluster - DIFFERENT FROM INFRA
    ipv4NativeRoutingCIDR: "10.246.0.0/16"

    # Enable IPv4
    ipv4:
      enabled: true

    # Direct routing mode (no encapsulation overhead)
    routingMode: native
    autoDirectNodeRoutes: true

    # Tunnel protocol (only used if direct routing unavailable)
    tunnelProtocol: vxlan

    # ==============================================================================
    # ENCRYPTION & SECURITY
    # ==============================================================================

    # WireGuard transparent encryption (automatic mTLS for all pod traffic)
    encryption:
      enabled: true
      type: wireguard
      nodeEncryption: false  # Encrypt pod-to-pod only (not node-to-pod)
      wireguard:
        persistentKeepalive: 25s

    # SPIRE workload identity - DISABLED until storage is deployed
    # Enable after deploying OpenEBS/Rook-Ceph storage operators
    authentication:
      enabled: false
      mutual:
        spire:
          enabled: false
          install:
            enabled: false
            server:
              dataStorage:
                size: 1Gi
            agent: {}

    # ==============================================================================
    # HUBBLE OBSERVABILITY
    # ==============================================================================

    hubble:
      enabled: true

      # Hubble Relay (cluster-wide visibility aggregator)
      relay:
        enabled: true
        replicas: 1
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi

      # Hubble UI (service map and flow visualization)
      ui:
        enabled: true
        replicas: 1
        ingress:
          enabled: false  # Configure via Gateway API if needed
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi

      # Metrics export (Prometheus format)
      metrics:
        enabled:
        - dns:query;ignoreAAAA
        - drop
        - tcp
        - flow
        - port-distribution
        - icmp
        - httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction

        # Enable ServiceMonitor for Victoria Metrics
        serviceMonitor:
          enabled: true
          labels:
            prometheus: kube-prometheus

        # Dashboards
        enableOpenMetrics: true

      # Hubble export to external systems (e.g., Jaeger)
      # Note: Will export to infra cluster's Jaeger via Cluster Mesh
      export:
        dynamic:
          enabled: false  # Will enable after Cluster Mesh connection
          config:
            configMapName: hubble-export-config
            createConfigMap: false

    # ==============================================================================
    # CLUSTER MESH (Multi-Cluster)
    # ==============================================================================

    clustermesh:
      useAPIServer: false

      apiserver:
        replicas: 2

        service:
          type: LoadBalancer
          annotations:
            io.cilium/lb-ipam-ips: "10.25.12.100"

        tls:
          auto:
            enabled: true
            method: cronJob

        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi

      # Connected manually via CLI in Week 3
      config:
        enabled: false

    # ==============================================================================
    # BGP CONTROL PLANE
    # ==============================================================================

    bgpControlPlane:
      enabled: true

    # ==============================================================================
    # GATEWAY API
    # ==============================================================================

    gatewayAPI:
      enabled: true
      envoy:
        enabled: true
        service:
          type: LoadBalancer
          annotations:
            io.cilium/lb-ipam-ips: "10.25.12.120"

    # ==============================================================================
    # OPERATOR
    # ==============================================================================

    operator:
      replicas: 2
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi

    # ==============================================================================
    # CILIUM AGENT (runs on each node)
    # ==============================================================================

    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi

    # ==============================================================================
    # MONITORING
    # ==============================================================================

    prometheus:
      enabled: true
      serviceMonitor:
        enabled: true
        labels:
          prometheus: kube-prometheus

    # ==============================================================================
    # POLICY ENFORCEMENT
    # ==============================================================================

    policyEnforcementMode: "default"  # Policies enforced when explicitly defined

    # L7 proxy configuration
    proxy:
      prometheus:
        enabled: true

    # Enable L7 protocol parsers
    enableL7Proxy: true

    # ==============================================================================
    # PERFORMANCE TUNING
    # ==============================================================================

    # BPF Map sizes
    bpf:
      monitorAggregation: medium
      monitorInterval: "5s"
      monitorFlags: "all"
      # Increase map sizes for larger deployments
      ctTcpMax: 524288
      ctAnyMax: 262144
      natMax: 524288
      neighMax: 524288
      policyMapMax: 16384

    # ==============================================================================
    # HIGH AVAILABILITY
    # ==============================================================================

    # Enable endpoint health checking
    enableEndpointHealthChecking: true

    # Enable connection tracking
    enableIPv4Masquerade: true

    # Enable bandwidth manager for better QoS
    bandwidthManager:
      enabled: true
      bbr: true

    # ==============================================================================
    # SECURITY FEATURES
    # ==============================================================================

    # Enable host firewall
    hostFirewall:
      enabled: false  # Enable if you need node-level protection

    # enableCiliumEndpointSlice: REMOVED - deprecated in v1.16, removed in v1.18
    # This feature is now enabled by default and cannot be disabled

    # ==============================================================================
    # KUBERNETES API ENDPOINT (uses in-cluster config with kubePrism)
    # ==============================================================================
    # Note: Not setting k8sServiceHost/Port allows Cilium to use the in-cluster
    # kubeconfig which automatically routes through Talos kubePrism (127.0.0.1:7445)
    # This is more reliable than external DNS endpoints for pod-to-API communication

    # ==============================================================================
    # TALOS-SPECIFIC SETTINGS
    # ==============================================================================

    securityContext:
      capabilities:
        ciliumAgent:
        - CHOWN
        - KILL
        - NET_ADMIN
        - NET_RAW
        - IPC_LOCK
        - SYS_ADMIN
        - SYS_RESOURCE
        - DAC_OVERRIDE
        - FOWNER
        - SETGID
        - SETUID
        cleanCiliumState:
        - NET_ADMIN
        - SYS_ADMIN
        - SYS_RESOURCE

    cgroup:
      autoMount:
        enabled: false
      hostRoot: /sys/fs/cgroup

    # ==============================================================================
    # DEBUGGING (disable in production)
    # ==============================================================================

    debug:
      enabled: false  # Set to true for troubleshooting
