---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: flux-webhook-receiver
  namespace: flux-system
  labels:
    app.kubernetes.io/name: flux-webhook-receiver
    app.kubernetes.io/component: monitoring
spec:
  groups:
    - name: flux-webhook-receiver.rules
      interval: 30s
      rules:
        - alert: FluxWebhookReceiverNotReady
          expr: |
            gotk_reconcile_condition{kind="Receiver",status="False",type="Ready"} == 1
          for: 15m
          annotations:
            summary: Flux webhook receiver not ready
            description: |
              Flux webhook receiver {{ $labels.name }} in namespace {{ $labels.namespace }}
              has not been ready for 15 minutes.
              GitHub webhooks will not trigger reconciliation.
          labels:
            severity: warning
            component: flux

        - alert: FluxWebhookReceiverNoWebhooks
          expr: |
            increase(gotk_receiver_webhook_total[1h]) == 0
          for: 2h
          annotations:
            summary: No webhooks received
            description: |
              Flux webhook receiver has not received any webhooks in 2 hours.
              Verify GitHub webhook configuration.
          labels:
            severity: info
            component: flux

        - alert: FluxWebhookReceiverFailures
          expr: |
            rate(gotk_receiver_webhook_total{status!="200"}[5m]) > 0.1
          for: 10m
          annotations:
            summary: Flux webhook receiver failures
            description: |
              Flux webhook receiver is experiencing {{ $value | humanize }} failures/sec.
              Check receiver logs and GitHub webhook configuration.
          labels:
            severity: warning
            component: flux

        - alert: FluxWebhookReceiverHighLatency
          expr: |
            histogram_quantile(0.99, rate(gotk_receiver_webhook_duration_seconds_bucket[5m])) > 5
          for: 15m
          annotations:
            summary: Flux webhook receiver high latency
            description: |
              Flux webhook receiver p99 latency is {{ $value | humanizeDuration }} (>5s).
              Webhook processing is slow.
          labels:
            severity: warning
            component: flux
