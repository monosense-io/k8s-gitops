---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: flux-operator
  namespace: flux-system
  labels:
    app.kubernetes.io/name: flux-operator
    app.kubernetes.io/component: monitoring
spec:
  groups:
    - name: flux-operator.rules
      interval: 30s
      rules:
        - alert: FluxOperatorAbsent
          expr: |
            absent(up{job="flux-operator"})
          for: 5m
          annotations:
            summary: Flux operator is absent
            description: |
              The Flux operator has not reported metrics for 5 minutes.
              This indicates the flux-operator deployment may be down.
          labels:
            severity: critical
            component: flux-operator

        - alert: FluxOperatorDown
          expr: |
            up{job="flux-operator"} == 0
          for: 5m
          annotations:
            summary: Flux operator is down
            description: |
              The Flux operator on {{ $labels.instance }} has been down for 5 minutes.
              Flux instances will not be managed until the operator is restored.
          labels:
            severity: critical
            component: flux-operator

        - alert: FluxOperatorHighMemoryUsage
          expr: |
            process_resident_memory_bytes{job="flux-operator"} > 134217728
          for: 15m
          annotations:
            summary: Flux operator high memory usage
            description: |
              Flux operator memory usage is {{ humanize $value }} (>128Mi)
              for 15 minutes. Consider increasing resource limits.
          labels:
            severity: warning
            component: flux-operator

        - alert: FluxOperatorRestartingFrequently
          expr: |
            rate(kube_pod_container_status_restarts_total{namespace="flux-system",container="flux-operator"}[15m]) > 0
          for: 15m
          annotations:
            summary: Flux operator restarting frequently
            description: |
              Flux operator pod {{ $labels.pod }} has restarted {{ $value | humanize }} times
              in the last 15 minutes. Check pod logs for errors.
          labels:
            severity: warning
            component: flux-operator
