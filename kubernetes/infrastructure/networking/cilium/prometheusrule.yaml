---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cilium
  namespace: kube-system
  labels:
    app.kubernetes.io/name: cilium
    app.kubernetes.io/component: monitoring
spec:
  groups:
    - name: cilium.rules
      interval: 30s
      rules:
        - alert: CiliumAgentAbsent
          expr: |
            absent(cilium_version)
          for: 5m
          annotations:
            summary: Cilium agent metrics are absent
            description: |
              Cilium agent has not reported metrics for 5 minutes.
              CNI functionality may be compromised.
          labels:
            severity: critical
            component: networking

        - alert: CiliumAgentUnhealthy
          expr: |
            cilium_agent_controllers_failing > 0
          for: 10m
          annotations:
            summary: Cilium agent controller failures
            description: |
              Cilium agent on {{ $labels.instance }} has {{ $value }} failing controllers
              for 10 minutes. Network policy enforcement may be degraded.
          labels:
            severity: warning
            component: networking

        - alert: CiliumEndpointNotReady
          expr: |
            sum(cilium_endpoint_state{endpoint_state!="ready"}) > 5
          for: 10m
          annotations:
            summary: Cilium endpoints not ready
            description: |
              {{ $value }} Cilium endpoints are not in ready state for 10 minutes.
              Pod networking may be affected.
          labels:
            severity: warning
            component: networking

        - alert: CiliumPolicyImportErrors
          expr: |
            rate(cilium_policy_import_errors_total[5m]) > 0
          for: 5m
          annotations:
            summary: Cilium policy import errors
            description: |
              Cilium is encountering errors importing network policies at {{ $value | humanizePercentage }}
              rate. Network policy enforcement may not be working correctly.
          labels:
            severity: critical
            component: networking

        - alert: CiliumHighDatapathErrors
          expr: |
            rate(cilium_datapath_errors_total[5m]) > 1
          for: 10m
          annotations:
            summary: High Cilium datapath errors
            description: |
              Cilium datapath on {{ $labels.instance }} is experiencing {{ $value | humanize }} errors/sec.
              Network connectivity may be impacted.
          labels:
            severity: warning
            component: networking

        - alert: CiliumBPFMapPressure
          expr: |
            (cilium_bpf_map_ops_total{operation="update"} / cilium_bpf_map_capacity) > 0.9
          for: 15m
          annotations:
            summary: Cilium BPF map pressure
            description: |
              Cilium BPF map {{ $labels.map_name }} is at {{ $value | humanizePercentage }} capacity
              for 15 minutes. Consider increasing map size.
          labels:
            severity: warning
            component: networking

        - alert: CiliumOperatorAbsent
          expr: |
            absent(up{job="cilium-operator"})
          for: 5m
          annotations:
            summary: Cilium operator is absent
            description: |
              Cilium operator has not reported metrics for 5 minutes.
              Cluster-wide Cilium operations may be degraded.
          labels:
            severity: critical
            component: networking

        - alert: CiliumIdentityAllocationFailures
          expr: |
            rate(cilium_identity_label_sources_failed[5m]) > 0
          for: 10m
          annotations:
            summary: Cilium identity allocation failures
            description: |
              Cilium is failing to allocate security identities at {{ $value | humanize }} failures/sec.
              New pod network connectivity will fail.
          labels:
            severity: critical
            component: networking
