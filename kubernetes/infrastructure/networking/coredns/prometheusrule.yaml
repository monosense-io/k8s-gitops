---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: coredns
  namespace: kube-system
  labels:
    app.kubernetes.io/name: coredns
    app.kubernetes.io/component: monitoring
spec:
  groups:
    - name: coredns.rules
      interval: 30s
      rules:
        - alert: CoreDNSAbsent
          expr: |
            absent(up{job="coredns"})
          for: 5m
          annotations:
            summary: CoreDNS metrics are absent
            description: |
              CoreDNS has not reported metrics for 5 minutes.
              DNS resolution in the cluster may be failing.
          labels:
            severity: critical
            component: networking

        - alert: CoreDNSDown
          expr: |
            up{job="coredns"} == 0
          for: 5m
          annotations:
            summary: CoreDNS is down
            description: |
              CoreDNS pod {{ $labels.pod }} has been down for 5 minutes.
              DNS resolution may be degraded if all replicas are down.
          labels:
            severity: critical
            component: networking

        - alert: CoreDNSHighQueryRate
          expr: |
            rate(coredns_dns_requests_total[5m]) > 10000
          for: 15m
          annotations:
            summary: CoreDNS high query rate
            description: |
              CoreDNS is handling {{ $value | humanize }} queries/sec,
              which is unusually high. Check for DNS query loops or attacks.
          labels:
            severity: warning
            component: networking

        - alert: CoreDNSHighErrorRate
          expr: |
            rate(coredns_dns_responses_total{rcode="SERVFAIL"}[5m]) > 10
          for: 10m
          annotations:
            summary: CoreDNS high error rate
            description: |
              CoreDNS is returning SERVFAIL responses at {{ $value | humanize }} errors/sec.
              Upstream DNS servers may be unreachable.
          labels:
            severity: warning
            component: networking

        - alert: CoreDNSLatencyHigh
          expr: |
            histogram_quantile(0.99, rate(coredns_dns_request_duration_seconds_bucket[5m])) > 0.5
          for: 10m
          annotations:
            summary: CoreDNS high latency
            description: |
              CoreDNS p99 query latency is {{ $value | humanizeDuration }} (>500ms).
              DNS resolution is slow.
          labels:
            severity: warning
            component: networking

        - alert: CoreDNSForwardLatencyHigh
          expr: |
            histogram_quantile(0.99, rate(coredns_forward_request_duration_seconds_bucket[5m])) > 1
          for: 10m
          annotations:
            summary: CoreDNS forward latency high
            description: |
              CoreDNS p99 forward latency to upstream DNS is {{ $value | humanizeDuration }} (>1s).
              Upstream DNS servers may be slow or unreachable.
          labels:
            severity: warning
            component: networking

        - alert: CoreDNSCacheOverflow
          expr: |
            rate(coredns_cache_misses_total[5m]) / rate(coredns_cache_hits_total[5m]) > 5
          for: 15m
          annotations:
            summary: CoreDNS cache ineffective
            description: |
              CoreDNS cache miss/hit ratio is {{ $value | humanize }}:1.
              Consider increasing cache size or TTL.
          labels:
            severity: info
            component: networking
