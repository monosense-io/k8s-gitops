apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: coredns
  namespace: kube-system
spec:
  groups:
    - name: coredns
      interval: 30s
      rules:
        - alert: CoreDNSAbsent
          expr: absent(up{job="coredns"})
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "CoreDNS metrics absent"
            description: "CoreDNS metrics have been absent for 5 minutes"

        - alert: CoreDNSDown
          expr: up{job="coredns"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "CoreDNS is down"
            description: "CoreDNS pod {{ $labels.pod }} is down"

        - alert: CoreDNSHighErrorRate
          expr: rate(coredns_dns_responses_total{rcode="SERVFAIL"}[5m]) > 0.05
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "CoreDNS high error rate"
            description: "CoreDNS error rate above 5% for 10 minutes"

        - alert: CoreDNSLatencyHigh
          expr: histogram_quantile(0.99, rate(coredns_dns_request_duration_seconds_bucket[5m])) > 1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "CoreDNS high latency"
            description: "CoreDNS p99 latency above 1s for 10 minutes"
