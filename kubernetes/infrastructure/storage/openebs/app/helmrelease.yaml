---
apiVersion: v1
kind: Namespace
metadata:
  name: openebs-system
  labels:
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: openebs
  namespace: openebs-system
spec:
  interval: 15m
  url: https://openebs.github.io/openebs
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openebs
  namespace: openebs-system
spec:
  interval: 1h
  chart:
    spec:
      chart: openebs
      version: 4.3.3
      sourceRef:
        kind: HelmRepository
        name: openebs
        namespace: openebs-system
      interval: 15m
  install:
    remediation:
      retries: 3
    createNamespace: false
  upgrade:
    remediation:
      retries: 3
      strategy: rollback
    cleanupOnFail: true
  rollback:
    recreate: true
    cleanupOnFail: true
  values:
    # Disable all engines except LocalPV hostpath
    engines:
      local:
        lvm:
          enabled: false
        zfs:
          enabled: false
      replicated:
        mayastor:
          enabled: false

    # Enable LocalPV hostpath provisioner
    localpv-provisioner:
      enabled: true
      hostpathClass:
        enabled: true
        name: ${OPENEBS_LOCAL_SC}
        basePath: ${OPENEBS_BASEPATH}
        isDefaultClass: false
      # Resource limits for provisioner DaemonSet
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

    # Disable built-in observability stack (use Victoria Metrics instead)
    loki:
      enabled: false
    alloy:
      enabled: false
    minio:
      enabled: false

    # Observability integration with VictoriaMetrics
    serviceMonitor:
      enabled: true

    # Helper pod for debugging
    helper:
      image: "busybox"
      imageTag: "latest"
