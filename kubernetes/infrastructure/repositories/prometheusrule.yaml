---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: flux-repositories
  namespace: flux-system
  labels:
    app.kubernetes.io/name: flux-repositories
    app.kubernetes.io/component: monitoring
spec:
  groups:
    - name: flux-repositories.rules
      interval: 30s
      rules:
        - alert: OCIRepositoryNotReady
          expr: |
            gotk_reconcile_condition{kind="OCIRepository",status="False",type="Ready"} == 1
          for: 15m
          annotations:
            summary: OCIRepository not ready
            description: |
              OCIRepository {{ $labels.name }} in namespace {{ $labels.namespace }}
              has not been ready for 15 minutes. Charts cannot be fetched.
          labels:
            severity: warning
            component: gitops

        - alert: HelmRepositoryNotReady
          expr: |
            gotk_reconcile_condition{kind="HelmRepository",status="False",type="Ready"} == 1
          for: 15m
          annotations:
            summary: HelmRepository not ready
            description: |
              HelmRepository {{ $labels.name }} in namespace {{ $labels.namespace }}
              has not been ready for 15 minutes. Charts cannot be fetched.
          labels:
            severity: warning
            component: gitops

        - alert: OCIRepositorySyncFailure
          expr: |
            rate(gotk_reconcile_condition{kind="OCIRepository",status="False",type="Ready"}[10m]) > 0
          for: 15m
          annotations:
            summary: OCIRepository sync failures
            description: |
              OCIRepository {{ $labels.name }} is experiencing sync failures.
              Chart fetching from OCI registry may be failing.
          labels:
            severity: critical
            component: gitops

        - alert: HelmRepositorySyncFailure
          expr: |
            rate(gotk_reconcile_condition{kind="HelmRepository",status="False",type="Ready"}[10m]) > 0
          for: 15m
          annotations:
            summary: HelmRepository sync failures
            description: |
              HelmRepository {{ $labels.name }} is experiencing sync failures.
              Chart fetching from Helm repository may be failing.
          labels:
            severity: critical
            component: gitops

        - alert: RepositoryHighReconcileDuration
          expr: |
            histogram_quantile(0.99, rate(gotk_reconcile_duration_seconds_bucket{kind=~"OCIRepository|HelmRepository"}[5m])) > 60
          for: 15m
          annotations:
            summary: Repository reconciliation duration high
            description: |
              {{ $labels.kind }} {{ $labels.name }} p99 reconciliation duration
              is {{ $value | humanizeDuration }} (>60s).
              Repository synchronization is slow.
          labels:
            severity: warning
            component: gitops

        - alert: RepositoryArtifactFetchFailures
          expr: |
            rate(gotk_reconcile_condition{kind=~"OCIRepository|HelmRepository",type="ArtifactAvailable",status="False"}[10m]) > 0
          for: 15m
          annotations:
            summary: Repository artifact fetch failures
            description: |
              {{ $labels.kind }} {{ $labels.name }} is failing to fetch artifacts.
              HelmReleases depending on this repository will fail.
          labels:
            severity: critical
            component: gitops
